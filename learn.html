<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Malachi AI ‚Äî Learn Chess</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --black:  #0a0a0a;
      --dark:   #111111;
      --panel:  #161616;
      --panel2: #1c1c1c;
      --border: #2a2a2a;
      --gold:   #c9a84c;
      --gold2:  #e8c97a;
      --cream:  #f5f0e8;
      --muted:  #6b6b6b;
      --white:  #ffffff;
      --green:  #4caf50;
      --red:    #e05068;
    }
    html { scroll-behavior: smooth; }
    body { background: var(--black); color: var(--cream); font-family: 'Outfit', sans-serif; overflow-x: hidden; cursor: none; min-height: 100vh; }
    .cursor { position:fixed; width:10px; height:10px; background:var(--gold); border-radius:50%; pointer-events:none; z-index:9999; transform:translate(-50%,-50%); mix-blend-mode:difference; }
    .cursor-ring { position:fixed; width:32px; height:32px; border:1px solid var(--gold); border-radius:50%; pointer-events:none; z-index:9998; transform:translate(-50%,-50%); opacity:0.4; transition:left 0.12s ease-out,top 0.12s ease-out; }
    .chess-bg { position:fixed; inset:0; z-index:0; opacity:0.025; background-image:repeating-conic-gradient(var(--gold) 0% 25%, transparent 0% 50%); background-size:48px 48px; pointer-events:none; }

    /* NAV */
    nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:18px 40px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.96); backdrop-filter:blur(12px); }
    .logo { display:flex; align-items:center; gap:10px; text-decoration:none; }
    .logo-icon { width:28px; height:28px; display:grid; grid-template-columns:1fr 1fr; gap:2px; }
    .logo-icon span { background:var(--gold); border-radius:1px; display:block; }
    .logo-icon span:nth-child(2),.logo-icon span:nth-child(3) { background:transparent; border:1px solid var(--gold); }
    .logo-text { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:700; color:var(--white); }
    .logo-text span { color:var(--gold); }
    .nav-links { display:flex; gap:8px; }
    .nav-link { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); text-decoration:none; padding:8px 14px; border:1px solid transparent; transition:all 0.2s; }
    .nav-link:hover,.nav-link.active { color:var(--gold); border-color:var(--border); }
    .xp-bar-nav { display:flex; align-items:center; gap:12px; }
    .xp-label { font-family:'DM Mono',monospace; font-size:11px; color:var(--gold); letter-spacing:0.1em; }
    .xp-track { width:120px; height:6px; background:var(--border); border-radius:3px; overflow:hidden; }
    .xp-fill { height:100%; background:linear-gradient(90deg,var(--gold),var(--gold2)); border-radius:3px; transition:width 0.6s ease; }
    .level-badge { background:var(--gold); color:var(--black); font-family:'DM Mono',monospace; font-size:10px; font-weight:500; padding:4px 10px; letter-spacing:0.1em; }

    /* MAIN LAYOUT */
    .main { position:relative; z-index:1; display:grid; grid-template-columns:260px 1fr; min-height:calc(100vh - 61px); }

    /* SIDEBAR */
    .sidebar { background:var(--panel); border-right:1px solid var(--border); padding:28px 0; position:sticky; top:61px; height:calc(100vh - 61px); overflow-y:auto; }
    .sidebar::-webkit-scrollbar { width:3px; }
    .sidebar::-webkit-scrollbar-thumb { background:var(--border); }
    .sidebar-section { margin-bottom:8px; }
    .sidebar-heading { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.2em; text-transform:uppercase; color:var(--muted); padding:12px 24px 8px; }
    .lesson-btn { width:100%; background:transparent; border:none; text-align:left; padding:12px 24px; cursor:none; display:flex; align-items:center; gap:12px; transition:background 0.2s; position:relative; }
    .lesson-btn:hover { background:rgba(201,168,76,0.05); }
    .lesson-btn.active { background:rgba(201,168,76,0.1); border-left:2px solid var(--gold); }
    .lesson-btn.completed .lesson-dot { background:var(--green); }
    .lesson-dot { width:8px; height:8px; border-radius:50%; background:var(--border); flex-shrink:0; transition:background 0.3s; }
    .lesson-btn.active .lesson-dot { background:var(--gold); }
    .lesson-btn-text { flex:1; }
    .lesson-btn-title { font-size:13px; color:var(--cream); font-weight:400; line-height:1.3; }
    .lesson-btn.completed .lesson-btn-title { color:var(--muted); }
    .lesson-btn-type { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:0.05em; margin-top:2px; }
    .lesson-check { color:var(--green); font-size:12px; }

    /* CONTENT AREA */
    .content { padding:48px 56px; max-width:860px; }

    /* PROGRESS HEADER */
    .progress-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:48px; padding:28px 32px; border:1px solid var(--border); background:var(--panel); }
    .progress-left h1 { font-family:'Cormorant Garamond',serif; font-size:36px; font-weight:700; color:var(--white); margin-bottom:4px; }
    .progress-left p { font-size:14px; color:var(--muted); font-weight:300; }
    .progress-stats { display:flex; gap:32px; }
    .prog-stat { text-align:center; }
    .prog-stat-num { font-family:'Cormorant Garamond',serif; font-size:32px; font-weight:700; color:var(--gold); line-height:1; }
    .prog-stat-label { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:0.1em; text-transform:uppercase; margin-top:4px; }

    /* BADGES */
    .badges-row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:48px; }
    .badge-item { display:flex; flex-direction:column; align-items:center; gap:6px; }
    .badge-circle { width:56px; height:56px; border-radius:50%; border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:24px; transition:all 0.3s; }
    .badge-circle.earned { border-color:var(--gold); background:rgba(201,168,76,0.1); box-shadow:0 0 20px rgba(201,168,76,0.2); }
    .badge-circle.locked { opacity:0.3; filter:grayscale(1); }
    .badge-label { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:0.1em; color:var(--muted); text-transform:uppercase; text-align:center; }
    .badge-label.earned { color:var(--gold); }

    /* LESSON CARD */
    .lesson-card { display:none; }
    .lesson-card.active { display:block; animation:fadeIn 0.4s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

    .lesson-eyebrow { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:var(--gold); margin-bottom:16px; display:flex; align-items:center; gap:10px; }
    .lesson-eyebrow::before { content:''; width:24px; height:1px; background:var(--gold); }
    .lesson-title { font-family:'Cormorant Garamond',serif; font-size:clamp(32px,4vw,52px); font-weight:700; color:var(--white); line-height:1; margin-bottom:16px; }
    .lesson-desc { font-size:16px; line-height:1.7; color:var(--muted); margin-bottom:36px; max-width:600px; font-weight:300; }

    /* LESSON PHOTO */
    .lesson-photo { width:100%; max-width:680px; margin-bottom:36px; border-radius:2px; overflow:hidden; position:relative; border:1px solid var(--border); }
    .lesson-photo img { width:100%; height:260px; object-fit:cover; display:block; filter:brightness(0.9) contrast(1.05); }
    .lesson-photo-caption { position:absolute; bottom:0; left:0; right:0; padding:10px 16px; background:linear-gradient(transparent,rgba(0,0,0,0.75)); font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.12em; color:rgba(255,255,255,0.7); text-transform:uppercase; }


    /* LESSON BOARDS */
    .lesson-board-wrap { display:flex; align-items:flex-start; gap:32px; margin-bottom:32px; flex-wrap:wrap; }
    .lesson-board-wrap .diagram-board { flex-shrink:0; }
    .lesson-board-info { flex:1; min-width:200px; }
    .lesson-board-title { font-family:"DM Mono",monospace; font-size:11px; letter-spacing:0.2em; text-transform:uppercase; color:var(--gold); margin-bottom:12px; }
    .lesson-board-desc { font-size:14px; line-height:1.7; color:#9a9a9a; }
    .lesson-board-desc strong { color:var(--cream); }
    .sq-label { font-family:"DM Mono",monospace; font-size:9px; color:rgba(0,0,0,0.4); position:absolute; }
    .dsq { position:relative; }
    .dsq.highlight { background:rgba(201,168,76,0.55) !important; }
    .dsq.red-hl { background:rgba(220,50,80,0.45) !important; }
    .dsq.green-hl { background:rgba(80,200,100,0.45) !important; }
    .dsq.arrow-from { background:rgba(201,168,76,0.35) !important; }

    /* LESSON CONTENT BLOCKS */
    .lesson-block { margin-bottom:32px; }
    .block-label { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.2em; text-transform:uppercase; color:var(--gold); margin-bottom:12px; }

    /* DIAGRAM BOARD */
    .diagram-board { display:inline-grid; grid-template-columns:repeat(8,48px); grid-template-rows:repeat(8,48px); border:2px solid var(--gold); box-shadow:0 0 40px rgba(201,168,76,0.1); margin-bottom:8px; }
    .diagram-board.small { grid-template-columns:repeat(8,38px); grid-template-rows:repeat(8,38px); }
    .dsq { display:flex; align-items:center; justify-content:center; font-size:26px; }
    .diagram-board.small .dsq { font-size:20px; }
    .dsq.dl { background:#e8d5a3; }
    .dsq.dd { background:#8b6914; }
    .dsq.highlight { background:rgba(201,168,76,0.5) !important; }
    .dsq.red-hl { background:rgba(220,50,80,0.4) !important; }
    .diagram-caption { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); letter-spacing:0.08em; margin-top:8px; }

    /* TEXT CONTENT */
    .lesson-text { font-size:15px; line-height:1.8; color:#9a9a9a; font-weight:300; }
    .lesson-text strong { color:var(--cream); font-weight:500; }
    .lesson-text .highlight-box { background:var(--panel2); border-left:3px solid var(--gold); padding:16px 20px; margin:16px 0; font-size:14px; color:var(--cream); }

    /* PIECE MOVES GRID */
    .pieces-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-bottom:24px; }
    .piece-card { background:var(--panel); border:1px solid var(--border); padding:20px; transition:all 0.3s; }
    .piece-card:hover { border-color:var(--gold); }
    .piece-card-icon { font-size:36px; margin-bottom:8px; }
    .piece-card-name { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:600; color:var(--white); margin-bottom:4px; }
    .piece-card-val { font-family:'DM Mono',monospace; font-size:10px; color:var(--gold); letter-spacing:0.1em; margin-bottom:8px; }
    .piece-card-desc { font-size:13px; color:var(--muted); line-height:1.6; font-weight:300; }

    /* QUIZ */
    .quiz-block { background:var(--panel); border:1px solid var(--border); padding:32px; }
    .quiz-question { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:600; color:var(--white); margin-bottom:24px; line-height:1.3; }
    .quiz-options { display:flex; flex-direction:column; gap:10px; margin-bottom:24px; }
    .quiz-option { background:transparent; border:1px solid var(--border); color:var(--cream); font-family:'Outfit',sans-serif; font-size:14px; padding:14px 20px; text-align:left; cursor:none; transition:all 0.2s; display:flex; align-items:center; gap:12px; }
    .quiz-option:hover:not(.answered) { border-color:var(--gold); color:var(--gold); }
    .quiz-option.correct { border-color:var(--green); background:rgba(76,175,80,0.1); color:var(--green); }
    .quiz-option.wrong { border-color:var(--red); background:rgba(220,80,104,0.1); color:var(--red); }
    .quiz-option.answered { cursor:not-allowed; }
    .option-letter { width:24px; height:24px; border:1px solid currentColor; border-radius:50%; display:flex; align-items:center; justify-content:center; font-family:'DM Mono',monospace; font-size:11px; flex-shrink:0; }
    .quiz-feedback { padding:16px; font-size:14px; line-height:1.6; border-radius:2px; display:none; }
    .quiz-feedback.show { display:block; }
    .quiz-feedback.correct { background:rgba(76,175,80,0.1); border:1px solid var(--green); color:#81c784; }
    .quiz-feedback.wrong { background:rgba(220,80,104,0.1); border:1px solid var(--red); color:#f48fb1; }

    /* PUZZLE */
    .puzzle-block { }
    .puzzle-board-wrap { display:flex; gap:32px; align-items:flex-start; flex-wrap:wrap; }
    .puzzle-info { flex:1; min-width:200px; }
    .puzzle-prompt { font-size:15px; color:var(--muted); line-height:1.7; margin-bottom:20px; font-weight:300; }
    .puzzle-hint-btn { background:transparent; border:1px solid var(--border); color:var(--muted); font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.1em; text-transform:uppercase; padding:10px 20px; cursor:none; transition:all 0.2s; }
    .puzzle-hint-btn:hover { border-color:var(--gold); color:var(--gold); }
    .puzzle-hint { font-size:13px; color:var(--gold); margin-top:12px; display:none; padding:12px; background:rgba(201,168,76,0.08); border:1px solid rgba(201,168,76,0.2); }
    .puzzle-hint.show { display:block; }
    .puzzle-result { font-family:'DM Mono',monospace; font-size:12px; letter-spacing:0.1em; margin-top:12px; display:none; }
    .puzzle-result.show { display:block; }
    .puzzle-result.correct { color:var(--green); }
    .puzzle-result.wrong { color:var(--red); }

    /* NEXT BUTTON */
    .lesson-footer { display:flex; justify-content:space-between; align-items:center; margin-top:48px; padding-top:32px; border-top:1px solid var(--border); }
    .btn-primary { background:var(--gold); color:var(--black); border:none; padding:14px 36px; font-family:'DM Mono',monospace; font-size:12px; letter-spacing:0.1em; text-transform:uppercase; cursor:none; font-weight:500; transition:all 0.25s; }
    .btn-primary:hover { background:var(--gold2); transform:translateY(-1px); }
    .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--muted); padding:14px 36px; font-family:'DM Mono',monospace; font-size:12px; letter-spacing:0.1em; text-transform:uppercase; cursor:none; transition:all 0.25s; }
    .btn-ghost:hover { border-color:var(--gold); color:var(--gold); }
    .lesson-progress-text { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); letter-spacing:0.08em; }

    /* BADGE TOAST */
    .badge-toast { position:fixed; bottom:32px; right:32px; background:var(--panel); border:1px solid var(--gold); padding:20px 24px; display:flex; align-items:center; gap:16px; z-index:1000; transform:translateX(200%); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); box-shadow:0 0 40px rgba(201,168,76,0.2); }
    .badge-toast.show { transform:translateX(0); }
    .toast-icon { font-size:32px; }
    .toast-text h4 { font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:600; color:var(--gold); }
    .toast-text p { font-size:13px; color:var(--muted); }

    /* COMPLETE SCREEN */
    .complete-screen { display:none; text-align:center; padding:80px 40px; }
    .complete-screen.show { display:block; animation:fadeIn 0.5s ease; }
    .complete-icon { font-size:80px; margin-bottom:24px; }
    .complete-screen h2 { font-family:'Cormorant Garamond',serif; font-size:52px; font-weight:700; color:var(--gold); margin-bottom:16px; }
    .complete-screen p { font-size:16px; color:var(--muted); max-width:400px; margin:0 auto 40px; line-height:1.7; }

    @media(max-width:900px) {
      .main { grid-template-columns:1fr; }
      .sidebar { position:relative; top:0; height:auto; }
      .content { padding:28px 20px; }
      .progress-header { flex-direction:column; gap:24px; }
      .puzzle-board-wrap { flex-direction:column; }
    }
  </style>
</head>
<body>

<div class="chess-bg"></div>
<div class="cursor" id="cursor"></div>
<div class="cursor-ring" id="cursorRing"></div>

<!-- BADGE TOAST -->
<div class="badge-toast" id="badgeToast">
  <div class="toast-icon" id="toastIcon">üèÖ</div>
  <div class="toast-text">
    <h4 id="toastTitle">Badge Earned!</h4>
    <p id="toastDesc">Keep going!</p>
  </div>
</div>

<!-- NAV -->
<nav>
  <a href="index.html" class="logo">
    <div class="logo-icon"><span></span><span></span><span></span><span></span></div>
    <div class="logo-text">Malachi <span>AI</span></div>
  </a>
  <div class="nav-links">
    <a href="index.html" class="nav-link">Home</a>
    <a href="play.html" class="nav-link">Play</a>
    <a href="learn.html" class="nav-link active">Learn</a>
    <a href="dashboard.html" class="nav-link" id="dashboardLink" style="display:none">Dashboard</a>
  </div>
  <div class="xp-bar-nav">
    <div class="xp-label" id="xpLabel">0 XP</div>
    <div class="xp-track"><div class="xp-fill" id="xpFill" style="width:0%"></div></div>
    <div class="level-badge" id="levelBadge">LVL 1</div>
  </div>
</nav>

<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar"></div>

  <!-- CONTENT -->
  <div class="content">

    <!-- PROGRESS HEADER -->
    <div class="progress-header">
      <div class="progress-left">
        <h1>Chess Academy</h1>
        <p>Master chess step by step ‚Äî from first moves to advanced tactics.</p>
      </div>
      <div class="progress-stats">
        <div class="prog-stat"><div class="prog-stat-num" id="statCompleted">0</div><div class="prog-stat-label">Completed</div></div>
        <div class="prog-stat"><div class="prog-stat-num" id="statXP">0</div><div class="prog-stat-label">XP Earned</div></div>
        <div class="prog-stat"><div class="prog-stat-num" id="statBadges">0</div><div class="prog-stat-label">Badges</div></div>
      </div>
    </div>

    <!-- BADGES -->
    <div class="lesson-block">
      <div class="block-label">Your Badges</div>
      <div class="badges-row" id="badgesRow"></div>
    </div>

    <!-- LESSON CARDS -->
    <div id="lessonArea"></div>

  </div>
</div>

<script>
 
// ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ
const cursor = document.getElementById('cursor');
const ring = document.getElementById('cursorRing');
document.addEventListener('mousemove', e => {
  cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
  setTimeout(() => { ring.style.left = e.clientX + 'px'; ring.style.top = e.clientY + 'px'; }, 80);
});

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let xp = 0;
let currentLesson = 0;
let completed = new Set();
let earnedBadges = new Set();

// ‚îÄ‚îÄ CURRICULUM DATA ‚îÄ‚îÄ
const BADGES = [
  { id:'first_step', icon:'üë£', label:'First Step', desc:'Complete your first lesson', req: () => completed.size >= 1 },
  { id:'pawn_star',  icon:'‚ôü', label:'Pawn Star',  desc:'Complete the Basics module', req: () => completed.has(0) && completed.has(1) && completed.has(2) },
  { id:'tactician',  icon:'‚öîÔ∏è', label:'Tactician',  desc:'Complete the Tactics module', req: () => completed.has(3) && completed.has(4) && completed.has(5) },
  { id:'strategist', icon:'üß†', label:'Strategist', desc:'Complete the Openings module', req: () => completed.has(6) && completed.has(7) },
  { id:'endgame',    icon:'üëë', label:'Endgame King', desc:'Complete the Endgames module', req: () => completed.has(8) && completed.has(9) },
  { id:'scholar',    icon:'üéì', label:'Scholar',    desc:'Complete all 10 lessons', req: () => completed.size >= 10 },
];

const LESSONS = [
  // ‚îÄ‚îÄ BASICS ‚îÄ‚îÄ
  {
    category: 'Basics',
    title: 'Meet the Pieces',
    type: 'Lesson',
    xp: 50,
    render: () => `
      <div class="lesson-eyebrow">Module 1 ‚Äî Basics</div>
      <h2 class="lesson-title">Meet the Pieces</h2>
      <p class="lesson-desc">Before you can play chess, you need to know your army. Each piece has a unique power ‚Äî learn them and you'll be dangerous from day one.</p>
      <div class="lesson-board-wrap"><div id="lb-0"></div><div class="lesson-board-info"><div class="lesson-board-title">Starting Position</div><div class="lesson-board-desc">The full army. <strong>White</strong> always on ranks 1‚Äì2, <strong>Black</strong> on ranks 7‚Äì8. Queen on her own color ‚Äî White queen on the light d1 square.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="block-label">Your Six Pieces</div>
        <div class="pieces-grid">
          <div class="piece-card"><div class="piece-card-icon">‚ôî</div><div class="piece-card-name">King</div><div class="piece-card-val">‚àû Value ‚Äî Protect at all costs</div><div class="piece-card-desc">Moves one square in any direction. If your king is captured, you lose. Everything else is secondary.</div></div>
          <div class="piece-card"><div class="piece-card-icon">‚ôï</div><div class="piece-card-name">Queen</div><div class="piece-card-val">9 Points ‚Äî Your most powerful piece</div><div class="piece-card-desc">Moves any number of squares in any direction ‚Äî horizontal, vertical, or diagonal. Guard her carefully.</div></div>
          <div class="piece-card"><div class="piece-card-icon">‚ôñ</div><div class="piece-card-name">Rook</div><div class="piece-card-val">5 Points ‚Äî Controls open files</div><div class="piece-card-desc">Moves any number of squares horizontally or vertically. Rooks become very powerful in the endgame.</div></div>
          <div class="piece-card"><div class="piece-card-icon">‚ôó</div><div class="piece-card-name">Bishop</div><div class="piece-card-val">3 Points ‚Äî Diagonal ruler</div><div class="piece-card-desc">Moves any number of squares diagonally. Each bishop stays on its own color for the whole game.</div></div>
          <div class="piece-card"><div class="piece-card-icon">‚ôò</div><div class="piece-card-name">Knight</div><div class="piece-card-val">3 Points ‚Äî The trickster</div><div class="piece-card-desc">Moves in an L-shape: 2 squares one way and 1 square the other. The ONLY piece that can jump over others.</div></div>
          <div class="piece-card"><div class="piece-card-icon">‚ôô</div><div class="piece-card-name">Pawn</div><div class="piece-card-val">1 Point ‚Äî Small but mighty</div><div class="piece-card-desc">Moves forward one square (or two on its first move). Captures diagonally. Reach the other side and promote to any piece!</div></div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-0">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">Which piece can jump over other pieces?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(0,0,1,'The Knight is the ONLY piece that can jump ‚Äî it leaps in an L-shape right over anything in its way!')">
            <div class="option-letter">A</div> The Bishop
          </button>
          <button class="quiz-option" onclick="answerQuiz(0,1,1,'The Knight is the ONLY piece that can jump ‚Äî it leaps in an L-shape right over anything in its way!')">
            <div class="option-letter">B</div> The Knight
          </button>
          <button class="quiz-option" onclick="answerQuiz(0,2,1,'The Knight is the ONLY piece that can jump ‚Äî it leaps in an L-shape right over anything in its way!')">
            <div class="option-letter">C</div> The Rook
          </button>
          <button class="quiz-option" onclick="answerQuiz(0,3,1,'The Knight is the ONLY piece that can jump ‚Äî it leaps in an L-shape right over anything in its way!')">
            <div class="option-letter">D</div> The Queen
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-0"></div>
      </div>`
  },
  {
    category: 'Basics',
    title: 'The Chessboard',
    type: 'Lesson + Diagram',
    xp: 50,
    render: () => `
      <div class="lesson-eyebrow">Module 1 ‚Äî Basics</div>
      <h2 class="lesson-title">The Chessboard</h2>
      <p class="lesson-desc">The board is your battlefield. 64 squares, 8 files (a‚Äìh) and 8 ranks (1‚Äì8). Knowing where you are is the first step to going where you want.</p>
      <div class="lesson-board-wrap"><div id="lb-1"></div><div class="lesson-board-info"><div class="lesson-board-title">The Board ‚Äî Files &amp; Ranks</div><div class="lesson-board-desc">Files run <strong>a‚Äìh</strong> left to right. Ranks run <strong>1‚Äì8</strong> bottom to top. The highlighted squares are the <strong>center four</strong> ‚Äî the most powerful squares on the board.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="block-label">Board Diagram</div>
        <div id="board-lesson-1"></div>
        <div class="diagram-caption">The board ‚Äî White always starts at the bottom. Rank 1 is White's home. Rank 8 is Black's home.</div>
      </div>
      <div class="lesson-block">
        <div class="lesson-text">
          <p>Every square has a name made of a <strong>file letter</strong> (a through h, left to right from White's side) and a <strong>rank number</strong> (1 through 8, bottom to top for White).</p>
          <div class="highlight-box">üí° Key rule: White always sits at ranks 1 and 2. Black sits at ranks 7 and 8. The queen always starts on her own color ‚Äî White queen on d1 (a light square), Black queen on d8 (a dark square).</div>
          <p>At the start of the game, each side has 16 pieces: 1 king, 1 queen, 2 rooks, 2 bishops, 2 knights, and 8 pawns.</p>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-1">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">Where does the White queen start at the beginning of a game?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(1,0,0,'d1 is correct! The queen starts on her own color ‚Äî and for White, that\\'s the light square d1.')">
            <div class="option-letter">A</div> d1
          </button>
          <button class="quiz-option" onclick="answerQuiz(1,1,0,'d1 is correct! The queen starts on her own color ‚Äî and for White, that\\'s the light square d1.')">
            <div class="option-letter">B</div> e1
          </button>
          <button class="quiz-option" onclick="answerQuiz(1,2,0,'d1 is correct! The queen starts on her own color ‚Äî and for White, that\\'s the light square d1.')">
            <div class="option-letter">C</div> d8
          </button>
          <button class="quiz-option" onclick="answerQuiz(1,3,0,'d1 is correct! The queen starts on her own color ‚Äî and for White, that\\'s the light square d1.')">
            <div class="option-letter">D</div> a1
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-1"></div>
      </div>`
  },
  {
    category: 'Basics',
    title: 'Check, Checkmate & Draw',
    type: 'Lesson',
    xp: 75,
    render: () => `
      <div class="lesson-eyebrow">Module 1 ‚Äî Basics</div>
      <h2 class="lesson-title">Check, Checkmate & Draw</h2>
      <p class="lesson-desc">The three most important words in chess. Understand these and you understand the whole game.</p>
      <div class="lesson-board-wrap"><div id="lb-2"></div><div class="lesson-board-info"><div class="lesson-board-title">Checkmate Example</div><div class="lesson-board-desc">The Black king on g8 is in <strong>check</strong> from the White queen on g2 ‚Äî and cannot escape. The rook on f1 covers the f-file. This is <strong>checkmate</strong>.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p><strong>Check</strong> means your king is being attacked. You MUST get out of check on your next move ‚Äî you can't just ignore it. You can escape by moving the king, blocking the attack, or capturing the attacking piece.</p>
          <div class="highlight-box">‚ö†Ô∏è You can never make a move that leaves your own king in check. The game will not allow it.</div>
          <p style="margin-top:16px"><strong>Checkmate</strong> is when the king is in check AND there is no legal way to escape. The game ends immediately ‚Äî the side that delivers checkmate wins.</p>
          <div class="highlight-box">‚ôõ You don't actually capture the king in chess ‚Äî the game ends the moment checkmate is reached.</div>
          <p style="margin-top:16px"><strong>Stalemate</strong> is a draw. It happens when a player is NOT in check but has no legal moves. The game ends in a tie ‚Äî even if one side is way ahead in pieces! Avoid giving your opponent a stalemate when you're winning.</p>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-2">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">Your opponent is NOT in check, but has no legal moves. What happens?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(2,0,1,'Stalemate! When the player to move has no legal moves and is not in check, the game is a draw ‚Äî even if you have way more pieces.')">
            <div class="option-letter">A</div> You win automatically
          </button>
          <button class="quiz-option" onclick="answerQuiz(2,1,1,'Stalemate! When the player to move has no legal moves and is not in check, the game is a draw ‚Äî even if you have way more pieces.')">
            <div class="option-letter">B</div> Stalemate ‚Äî the game is a draw
          </button>
          <button class="quiz-option" onclick="answerQuiz(2,2,1,'Stalemate! When the player to move has no legal moves and is not in check, the game is a draw ‚Äî even if you have way more pieces.')">
            <div class="option-letter">C</div> The opponent must pass their turn
          </button>
          <button class="quiz-option" onclick="answerQuiz(2,3,1,'Stalemate! When the player to move has no legal moves and is not in check, the game is a draw ‚Äî even if you have way more pieces.')">
            <div class="option-letter">D</div> Checkmate
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-2"></div>
      </div>`
  },

  // ‚îÄ‚îÄ TACTICS ‚îÄ‚îÄ
  {
    category: 'Tactics',
    title: 'The Fork',
    type: 'Lesson + Puzzle',
    xp: 100,
    render: () => `
      <div class="lesson-eyebrow">Module 2 ‚Äî Tactics</div>
      <h2 class="lesson-title">The Fork</h2>
      <p class="lesson-desc">A fork is one of the most powerful moves in chess ‚Äî one piece attacks two enemy pieces at the same time. The opponent can only save one.</p>
      <div class="lesson-board-wrap"><div id="lb-3"></div><div class="lesson-board-info"><div class="lesson-board-title">Knight Fork ‚Äî White to Move</div><div class="lesson-board-desc">White plays <strong>Nc7+</strong> ‚Äî the knight simultaneously attacks the Black king on e8 and the queen on a6. Black must escape check and loses the queen.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>Any piece can fork, but <strong>knights are the best forks</strong> because of their unique L-shaped movement ‚Äî they're unpredictable and hard to block.</p>
          <div class="highlight-box">‚ôû Classic knight fork: place your knight so it attacks the king AND queen at the same time. The opponent must move their king out of check ‚Äî and you take the queen for free!</div>
        </div>
      </div>
      <div class="lesson-block">
        <div class="block-label">Puzzle ‚Äî Find the Fork</div>
        <div class="puzzle-block">
          <div class="puzzle-board-wrap">
            <div id="board-puzzle-3"></div>
            <div class="puzzle-info">
              <p class="puzzle-prompt">White to move. Find the knight move that forks the Black king and queen at the same time. White wins a queen!</p>
              <div style="display:flex;flex-direction:column;gap:8px;margin-top:16px">
                <button class="quiz-option" onclick="puzzleAnswer(3,0,1,'‚úì Nc7+ is the fork! The knight attacks both the king on e8 and the queen on a6. Black must escape check, and White takes the queen.')">Nc7+</button>
                <button class="quiz-option" onclick="puzzleAnswer(3,1,1,'‚úì Nc7+ is the fork! The knight attacks both the king on e8 and the queen on a6. Black must escape check, and White takes the queen.')">Nf4</button>
                <button class="quiz-option" onclick="puzzleAnswer(3,2,1,'‚úì Nc7+ is the fork! The knight attacks both the king on e8 and the queen on a6. Black must escape check, and White takes the queen.')">Nd6</button>
              </div>
              <div class="puzzle-hint-btn" onclick="showHint(3)" style="margin-top:16px;display:inline-block;padding:10px 20px;border:1px solid var(--border);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);">Show Hint</div>
              <div class="puzzle-hint" id="hint-3">Look for a square where the knight can attack both the king AND queen in one move. The king is on e8, the queen is on a6.</div>
              <div class="quiz-feedback" id="qfeedback-3" style="margin-top:12px;"></div>
            </div>
          </div>
        </div>
      </div>`
  },
  {
    category: 'Tactics',
    title: 'The Pin',
    type: 'Lesson',
    xp: 100,
    render: () => `
      <div class="lesson-eyebrow">Module 2 ‚Äî Tactics</div>
      <h2 class="lesson-title">The Pin</h2>
      <p class="lesson-desc">A pin freezes an enemy piece in place. Move it, and something even more valuable behind it gets captured.</p>
      <div class="lesson-board-wrap"><div id="lb-4"></div><div class="lesson-board-info"><div class="lesson-board-title">Absolute Pin</div><div class="lesson-board-desc">White's bishop on b5 pins the Black knight on c6 to the king on e8. The knight <strong>cannot legally move</strong> ‚Äî doing so would expose the king to check.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>There are two types of pins. An <strong>absolute pin</strong> is when a piece is pinned to the king ‚Äî it literally cannot move because that would expose the king to check. A <strong>relative pin</strong> is when moving the piece would lose something valuable (like a queen) behind it.</p>
          <div class="highlight-box">‚ôó Bishops and rooks are the most common pinning pieces. A bishop can pin a knight to a king diagonally. A rook can pin a piece to a king along a rank or file.</div>
          <p style="margin-top:16px">Once you've pinned a piece, <strong>attack it again</strong> with pawns or other pieces. The pinned piece can't defend itself by moving!</p>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-4">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">A knight is pinned to the king by a bishop. Can the knight move?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(4,0,1,'Correct! An absolute pin means the piece legally CANNOT move ‚Äî doing so would put the king in check, which is illegal.')">
            <div class="option-letter">A</div> No ‚Äî moving would put the king in check
          </button>
          <button class="quiz-option" onclick="answerQuiz(4,1,1,'Correct! An absolute pin means the piece legally CANNOT move ‚Äî doing so would put the king in check, which is illegal.')">
            <div class="option-letter">B</div> Yes, it can always move
          </button>
          <button class="quiz-option" onclick="answerQuiz(4,2,1,'Correct! An absolute pin means the piece legally CANNOT move ‚Äî doing so would put the king in check, which is illegal.')">
            <div class="option-letter">C</div> Only if it captures something
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-4"></div>
      </div>`
  },
  {
    category: 'Tactics',
    title: 'The Skewer',
    type: 'Lesson',
    xp: 100,
    render: () => `
      <div class="lesson-eyebrow">Module 2 ‚Äî Tactics</div>
      <h2 class="lesson-title">The Skewer</h2>
      <p class="lesson-desc">A skewer is like a pin in reverse ‚Äî you attack a valuable piece directly, forcing it to move, and capture the less valuable piece hiding behind it.</p>
      <div class="lesson-board-wrap"><div id="lb-5"></div><div class="lesson-board-info"><div class="lesson-board-title">Rook Skewer</div><div class="lesson-board-desc">White's rook attacks the Black king on e8. The king <strong>must move</strong> ‚Äî revealing the rook on e5 behind it. White captures it for free.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>In a pin, the more valuable piece is <em>behind</em> the attacked piece. In a skewer, the more valuable piece is <em>in front</em>. You attack the king or queen directly, and when it moves away, you capture the rook or bishop it was protecting.</p>
          <div class="highlight-box">‚ôñ Example: Your rook attacks the enemy king along a rank. The king must move. Behind the king is a rook ‚Äî now unprotected. You take it for free.</div>
          <p style="margin-top:16px">Skewers are especially common in endgames when there are fewer pieces on the board and kings become more active.</p>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-5">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">In a skewer, which piece is attacked first?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(5,0,2,'Correct! In a skewer, you attack the MORE valuable piece first (like the king or queen), forcing it to move and exposing something behind it.')">
            <div class="option-letter">A</div> The less valuable piece
          </button>
          <button class="quiz-option" onclick="answerQuiz(5,1,2,'Correct! In a skewer, you attack the MORE valuable piece first (like the king or queen), forcing it to move and exposing something behind it.')">
            <div class="option-letter">B</div> The more valuable piece
          </button>
          <button class="quiz-option" onclick="answerQuiz(5,2,2,'Correct! In a skewer, you attack the MORE valuable piece first (like the king or queen), forcing it to move and exposing something behind it.')">
            <div class="option-letter">C</div> Both at the same time
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-5"></div>
      </div>`
  },

  // ‚îÄ‚îÄ OPENINGS ‚îÄ‚îÄ
  {
    category: 'Openings',
    title: 'Opening Principles',
    type: 'Lesson',
    xp: 75,
    render: () => `
      <div class="lesson-eyebrow">Module 3 ‚Äî Openings</div>
      <h2 class="lesson-title">Opening Principles</h2>
      <p class="lesson-desc">You don't need to memorize 50 openings to play well. Master these three principles and you'll start every game strong.</p>
      <div class="lesson-board-wrap"><div id="lb-6"></div><div class="lesson-board-info"><div class="lesson-board-title">After 1.e4 e5 2.Nf3 Nc6 3.Bc4</div><div class="lesson-board-desc">White has followed all 3 principles: <strong>e4 controls the center</strong>, Nf3 and Bc4 develop pieces, and White is ready to castle. The center squares are highlighted.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Principle 1: Control the Center</strong><br>
            The four central squares ‚Äî e4, d4, e5, d5 ‚Äî are the most powerful on the board. Pieces in the center control more squares and have more options. Open with e4 or d4 to claim center space immediately.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Principle 2: Develop Your Pieces</strong><br>
            Get your knights and bishops off the back rank and into the game. Don't move the same piece twice in the opening unless you have to. Every move should bring a new piece into action.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">Principle 3: Castle Early</strong><br>
            Castling moves your king to safety behind a wall of pawns and connects your rooks. Try to castle within the first 10 moves. A king stuck in the center is a target.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-6">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">Which is the best first move for White according to opening principles?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(6,0,0,'e4 is the most popular first move in chess! It immediately controls the center, opens lines for the bishop and queen, and follows all three opening principles.')">
            <div class="option-letter">A</div> e4 ‚Äî Advance the king's pawn
          </button>
          <button class="quiz-option" onclick="answerQuiz(6,1,0,'e4 is the most popular first move in chess! It immediately controls the center, opens lines for the bishop and queen, and follows all three opening principles.')">
            <div class="option-letter">B</div> h4 ‚Äî Advance the edge pawn
          </button>
          <button class="quiz-option" onclick="answerQuiz(6,2,0,'e4 is the most popular first move in chess! It immediately controls the center, opens lines for the bishop and queen, and follows all three opening principles.')">
            <div class="option-letter">C</div> Na3 ‚Äî Move the knight to the edge
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-6"></div>
      </div>`
  },
  {
    category: 'Openings',
    title: "The Scholar's Mate",
    type: 'Lesson + Puzzle',
    xp: 75,
    render: () => `
      <div class="lesson-eyebrow">Module 3 ‚Äî Openings</div>
      <h2 class="lesson-title">The Scholar's Mate</h2>
      <p class="lesson-desc">The fastest checkmate in chess ‚Äî and the most common trap beginners fall into. Learn how it works so you can use it AND defend against it.</p>
      <div class="lesson-board-wrap"><div id="lb-7"></div><div class="lesson-board-info"><div class="lesson-board-title">Scholar's Mate ‚Äî Qxf7#</div><div class="lesson-board-desc">After 1.e4 e5 2.Bc4 Nc6 3.Qh5 Nf6?? White plays <strong>4.Qxf7#</strong>. The queen on f7 is protected by the bishop on c4. Black's king is trapped ‚Äî checkmate.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>The Scholar's Mate tries to checkmate on f7 (or f2 for Black) ‚Äî the weakest square in the starting position because it's only defended by the king. The attack uses the queen and bishop together.</p>
          <div class="highlight-box">The moves: 1. e4 e5 2. Bc4 Nc6 3. Qh5 Nf6?? 4. Qxf7# ‚Äî Checkmate in 4 moves! The queen on f7 is protected by the bishop on c4, and the king can't escape.</div>
          <p style="margin-top:16px"><strong>How to defend:</strong> When you see the queen and bishop aimed at f7, play Nf6 to attack the queen, then g6 to chase it away. Or simply develop pieces to block the attack.</p>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-7">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">The Scholar's Mate targets which square for checkmate?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(7,0,1,'f7! It\\'s the weakest square for Black at the start of the game ‚Äî only defended by the king, and vulnerable to a queen + bishop attack from White.')">
            <div class="option-letter">A</div> e8
          </button>
          <button class="quiz-option" onclick="answerQuiz(7,1,1,'f7! It\\'s the weakest square for Black at the start of the game ‚Äî only defended by the king, and vulnerable to a queen + bishop attack from White.')">
            <div class="option-letter">B</div> f7
          </button>
          <button class="quiz-option" onclick="answerQuiz(7,2,1,'f7! It\\'s the weakest square for Black at the start of the game ‚Äî only defended by the king, and vulnerable to a queen + bishop attack from White.')">
            <div class="option-letter">C</div> g8
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-7"></div>
      </div>`
  },

  // ‚îÄ‚îÄ ENDGAMES ‚îÄ‚îÄ
  {
    category: 'Endgames',
    title: 'King & Pawn Endgames',
    type: 'Lesson',
    xp: 125,
    render: () => `
      <div class="lesson-eyebrow">Module 4 ‚Äî Endgames</div>
      <h2 class="lesson-title">King & Pawn Endgames</h2>
      <p class="lesson-desc">When most pieces are traded off, pawns decide who wins. The king ‚Äî passive in the opening ‚Äî becomes your most powerful piece in the endgame.</p>
      <div class="lesson-board-wrap"><div id="lb-8"></div><div class="lesson-board-info"><div class="lesson-board-title">King Opposition</div><div class="lesson-board-desc">The White king on e5 has the <strong>opposition</strong> ‚Äî the Black king on e7 is forced to step aside. White's king escorts the pawn to promotion.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The Opposition</strong><br>
            When two kings face each other with one square between them, they are "in opposition." The player who does NOT have to move has the opposition ‚Äî a major advantage in pawn endgames.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Passed Pawns</strong><br>
            A passed pawn has no enemy pawns blocking its path to promotion. These pawns must be pushed! In the endgame, a passed pawn that reaches the 7th rank becomes an unstoppable threat.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">The Rule of the Square</strong><br>
            Draw a diagonal square from the pawn to the promotion square. If the defending king can step into that square, it can catch the pawn. If not, the pawn promotes!
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-8">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">In the endgame, how does the king's role change compared to the opening?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(8,0,0,'Exactly right! In the endgame, the king transforms from a piece you protect into an aggressive fighter. Activate your king early in the endgame!')">
            <div class="option-letter">A</div> It becomes an active attacking piece
          </button>
          <button class="quiz-option" onclick="answerQuiz(8,1,0,'Exactly right! In the endgame, the king transforms from a piece you protect into an aggressive fighter. Activate your king early in the endgame!')">
            <div class="option-letter">B</div> It stays hidden behind pawns
          </button>
          <button class="quiz-option" onclick="answerQuiz(8,2,0,'Exactly right! In the endgame, the king transforms from a piece you protect into an aggressive fighter. Activate your king early in the endgame!')">
            <div class="option-letter">C</div> It becomes less important
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-8"></div>
      </div>`
  },
  {
    category: 'Endgames',
    title: 'Rook Endgames',
    type: 'Lesson',
    xp: 125,
    render: () => `
      <div class="lesson-eyebrow">Module 4 ‚Äî Endgames</div>
      <h2 class="lesson-title">Rook Endgames</h2>
      <p class="lesson-desc">Rook endgames are the most common in chess. Mastering just a few key principles will save and win countless games.</p>
      <div class="lesson-board-wrap"><div id="lb-9"></div><div class="lesson-board-info"><div class="lesson-board-title">Rook Behind the Passed Pawn</div><div class="lesson-board-desc">White's rook sits <strong>behind the passed pawn</strong> on e7. As the pawn advances, the rook's power grows. This is the most important rook endgame principle.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Rooks Belong Behind Passed Pawns</strong><br>
            Whether it's your pawn or your opponent's ‚Äî put your rook behind it. Your rook gains power as the pawn advances. Their rook gains power as their pawn advances (which you want to stop).
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The Lucena Position</strong><br>
            The key winning position in rook endgames. The attacking king escorts its pawn to the 7th rank, cuts off the defending king, and uses a "bridge building" technique to win.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">The Philidor Position</strong><br>
            The key drawing technique for the defender. Keep your rook on the 6th rank until the attacking pawn advances, then switch to checking from behind. Master this and you'll never lose a drawn rook endgame.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-9">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">Where should your rook be placed relative to a passed pawn?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(9,0,1,'Behind the passed pawn! This is the most important rook endgame principle. The rook gains more and more power as the pawn pushes forward.')">
            <div class="option-letter">A</div> In front of it
          </button>
          <button class="quiz-option" onclick="answerQuiz(9,1,1,'Behind the passed pawn! This is the most important rook endgame principle. The rook gains more and more power as the pawn pushes forward.')">
            <div class="option-letter">B</div> Behind it
          </button>
          <button class="quiz-option" onclick="answerQuiz(9,2,1,'Behind the passed pawn! This is the most important rook endgame principle. The rook gains more and more power as the pawn pushes forward.')">
            <div class="option-letter">C</div> On the opposite side of the board
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-9"></div>
      </div>`
  },

  // ‚îÄ‚îÄ OPENINGS: BEGINNER ‚îÄ‚îÄ
  {
    category: 'Openings',
    title: 'The Italian Game',
    type: 'Lesson',
    xp: 100,
    render: () => `
      <div class="lesson-eyebrow">Module 5 ‚Äî Openings: Beginner</div>
      <h2 class="lesson-title">The Italian Game</h2>
      <p class="lesson-desc">One of the oldest and most popular openings in chess. Simple, aggressive, and perfect for beginners who want a solid start.</p>
      <div class="lesson-board-wrap"><div id="lb-10"></div><div class="lesson-board-info"><div class="lesson-board-title">Italian Game ‚Äî After 3.Bc4</div><div class="lesson-board-desc">White's bishop eyes the <strong>f7 square</strong> ‚Äî Black's weakest point. White is ready to castle and has followed all opening principles in just 3 moves.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>The Italian Game begins: <strong>1. e4 e5 2. Nf3 Nc6 3. Bc4</strong>. White's bishop aims at the f7 square ‚Äî the weakest point in Black's position ‚Äî and prepares to castle quickly.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Why it works</strong><br>
            All three moves follow opening principles: control the center (e4), develop a piece (Nf3), develop another piece to an aggressive square (Bc4). You're ready to castle by move 5.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The Giuoco Piano</strong><br>
            After Bc4, if Black plays Bc5 ‚Äî mirroring your setup ‚Äî you have the Giuoco Piano ("Quiet Game"). Both sides develop smoothly and fight for center control. Great for learning positional chess.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">The Evan's Gambit</strong><br>
            Feeling aggressive? After 3...Bc5, try 4. b4 ‚Äî the Evans Gambit! You sacrifice a pawn for rapid development and a powerful center. One of the most exciting openings in chess history.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-10">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">What is White's 3rd move in the Italian Game?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(10,0,1,'Bc4! The bishop aims at f7, follows opening principles, and prepares for early castling. This is the Italian Game.')">
            <div class="option-letter">A</div> Bc4
          </button>
          <button class="quiz-option" onclick="answerQuiz(10,1,1,'Bc4! The bishop aims at f7, follows opening principles, and prepares for early castling. This is the Italian Game.')">
            <div class="option-letter">B</div> d4
          </button>
          <button class="quiz-option" onclick="answerQuiz(10,2,1,'Bc4! The bishop aims at f7, follows opening principles, and prepares for early castling. This is the Italian Game.')">
            <div class="option-letter">C</div> Bb5
          </button>
          <button class="quiz-option" onclick="answerQuiz(10,3,1,'Bc4! The bishop aims at f7, follows opening principles, and prepares for early castling. This is the Italian Game.')">
            <div class="option-letter">D</div> Nc3
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-10"></div>
      </div>`
  },
  {
    category: 'Openings',
    title: 'The Spanish Opening',
    type: 'Lesson',
    xp: 100,
    render: () => `
      <div class="lesson-eyebrow">Module 5 ‚Äî Openings: Beginner</div>
      <h2 class="lesson-title">The Spanish Opening (Ruy L√≥pez)</h2>
      <p class="lesson-desc">The most played opening at the highest levels of chess for 500 years. Subtle, deep, and incredibly rich in strategy.</p>
      <div class="lesson-board-wrap"><div id="lb-11"></div><div class="lesson-board-info"><div class="lesson-board-title">Ruy L√≥pez ‚Äî After 3.Bb5</div><div class="lesson-board-desc">White's bishop pins the knight defending e5. The <strong>Ruy L√≥pez</strong> has been played by World Champions for over 400 years.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>The Spanish begins: <strong>1. e4 e5 2. Nf3 Nc6 3. Bb5</strong>. Instead of attacking f7 directly, White puts indirect pressure on Black's e5 pawn by threatening the knight that defends it.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The Big Idea</strong><br>
            Bb5 pins or threatens the Nc6. If the knight moves, the e5 pawn loses its defender. White isn't winning the pawn immediately ‚Äî it's a long-term squeeze that gives White a space advantage.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The Marshall Attack</strong><br>
            Black's most aggressive response: sacrifice a pawn early for a massive attack. The resulting positions are razor-sharp and have been played by World Champions for over 100 years.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">Why the pros play it</strong><br>
            Magnus Carlsen, Garry Kasparov, and Bobby Fischer all used the Spanish as their main weapon with White. It gives you a small but lasting edge if you know the plans.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-11">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">What is the key idea behind Bb5 in the Spanish Opening?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(11,0,2,'Correct! Bb5 pressures the Nc6, which defends the e5 pawn. It is a long-term strategic threat, not an immediate capture.')">
            <div class="option-letter">A</div> To immediately capture the e5 pawn
          </button>
          <button class="quiz-option" onclick="answerQuiz(11,1,2,'Correct! Bb5 pressures the Nc6, which defends the e5 pawn. It is a long-term strategic threat, not an immediate capture.')">
            <div class="option-letter">B</div> To pressure the knight defending e5
          </button>
          <button class="quiz-option" onclick="answerQuiz(11,2,2,'Correct! Bb5 pressures the Nc6, which defends the e5 pawn. It is a long-term strategic threat, not an immediate capture.')">
            <div class="option-letter">C</div> To attack f7 directly
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-11"></div>
      </div>`
  },

  // ‚îÄ‚îÄ OPENINGS: ADVANCED ‚îÄ‚îÄ
  {
    category: 'Openings',
    title: "The Sicilian Defense",
    type: 'Lesson',
    xp: 125,
    render: () => `
      <div class="lesson-eyebrow">Module 6 ‚Äî Openings: Advanced</div>
      <h2 class="lesson-title">The Sicilian Defense</h2>
      <p class="lesson-desc">The most popular and combative response to 1. e4. Black fights for the center asymmetrically ‚Äî and creates winning chances from the very first move.</p>
      <div class="lesson-board-wrap"><div id="lb-12"></div><div class="lesson-board-info"><div class="lesson-board-title">Sicilian ‚Äî After 1.e4 c5</div><div class="lesson-board-desc">Black avoids a symmetrical position. The c5 pawn <strong>fights for d4</strong> without letting White have a pawn in the center. The most popular defense at all levels.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>After <strong>1. e4 c5</strong>, Black doesn't mirror White's center control ‚Äî they undermine it. The c5 pawn fights for d4 without giving White a free tempo with e5.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Why Black loves the Sicilian</strong><br>
            The positions are unbalanced ‚Äî White often attacks kingside while Black counterattacks queenside. Both sides play for a win, making it perfect for players who hate draws.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The Najdorf Variation</strong><br>
            After 1.e4 c5 2.Nf3 d6 3.d4 cxd4 4.Nxd4 Nf6 5.Nc3 a6 ‚Äî Bobby Fischer called it "best by test." The a6 move prevents Bb5 and prepares b5. Kasparov's main weapon for decades.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">The Dragon Variation</strong><br>
            Black fianchettoes the bishop to g7, creating a powerful diagonal aimed at White's queenside. One of the sharpest openings in chess ‚Äî both sides attack as fast as possible.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-12">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">What is Black's first move in the Sicilian Defense?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(12,0,1,'1...c5! The Sicilian. By playing c5 instead of e5, Black fights for d4 without giving White a symmetrical position. The most popular response to 1. e4 at all levels.')">
            <div class="option-letter">A</div> 1...e5
          </button>
          <button class="quiz-option" onclick="answerQuiz(12,1,1,'1...c5! The Sicilian. By playing c5 instead of e5, Black fights for d4 without giving White a symmetrical position. The most popular response to 1. e4 at all levels.')">
            <div class="option-letter">B</div> 1...c5
          </button>
          <button class="quiz-option" onclick="answerQuiz(12,2,1,'1...c5! The Sicilian. By playing c5 instead of e5, Black fights for d4 without giving White a symmetrical position. The most popular response to 1. e4 at all levels.')">
            <div class="option-letter">C</div> 1...d5
          </button>
          <button class="quiz-option" onclick="answerQuiz(12,3,1,'1...c5! The Sicilian. By playing c5 instead of e5, Black fights for d4 without giving White a symmetrical position. The most popular response to 1. e4 at all levels.')">
            <div class="option-letter">D</div> 1...Nf6
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-12"></div>
      </div>`
  },
  {
    category: 'Openings',
    title: "The Queen's Gambit",
    type: 'Lesson',
    xp: 125,
    render: () => `
      <div class="lesson-eyebrow">Module 6 ‚Äî Openings: Advanced</div>
      <h2 class="lesson-title">The Queen's Gambit</h2>
      <p class="lesson-desc">Not actually a gambit ‚Äî it's a positional powerhouse used by every World Champion. Learn why 1. d4 openings are just as exciting as 1. e4.</p>
      <div class="lesson-board-wrap"><div id="lb-13"></div><div class="lesson-board-info"><div class="lesson-board-title">Queen's Gambit ‚Äî After 1.d4 d5 2.c4</div><div class="lesson-board-desc">White offers the c4 pawn. If Black takes it (<strong>Accepted</strong>), White gets a huge center with e4. If Black declines (<strong>Declined</strong>), a rich positional battle begins.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>The Queen's Gambit: <strong>1. d4 d5 2. c4</strong>. White offers a pawn on c4. If Black takes it (2...dxc4), White gets a big center with 3. e4. If Black declines, a rich strategic battle begins.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Accepted vs Declined</strong><br>
            <strong>Accepted (QGA):</strong> Black takes the pawn and tries to hold it. White gets the center and attacks.<br>
            <strong>Declined (QGD):</strong> Black holds the center with ...e6. Solid and classical ‚Äî played by World Champions for 150 years.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The Slav Defense</strong><br>
            After 1.d4 d5 2.c4 c6 ‚Äî Black supports the d5 pawn with the c-pawn, freeing the c8 bishop. One of the most solid defenses in chess.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">Pop Culture Note</strong><br>
            The Netflix show "The Queen's Gambit" is named after this opening. Beth Harmon plays it throughout the series ‚Äî and now millions of new players know what it is!
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-13">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">In the Queen's Gambit, what happens if Black accepts and takes on c4?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(13,0,0,'Correct! If Black takes the pawn, White plays e4 and gets a powerful pawn center. That is why the Queen&apos;s Gambit is not a true gambit ‚Äî White almost always gets the pawn back.')">
            <div class="option-letter">A</div> White builds a big center with e4
          </button>
          <button class="quiz-option" onclick="answerQuiz(13,1,0,'Correct! If Black takes the pawn, White plays e4 and gets a powerful pawn center. That is why the Queen&apos;s Gambit is not a true gambit ‚Äî White almost always gets the pawn back.')">
            <div class="option-letter">B</div> Black keeps the pawn permanently
          </button>
          <button class="quiz-option" onclick="answerQuiz(13,2,0,'Correct! If Black takes the pawn, White plays e4 and gets a powerful pawn center. That is why the Queen&apos;s Gambit is not a true gambit ‚Äî White almost always gets the pawn back.')">
            <div class="option-letter">C</div> White loses material
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-13"></div>
      </div>`
  },

  // ‚îÄ‚îÄ TACTICS: MORE PATTERNS ‚îÄ‚îÄ
  {
    category: 'Tactics',
    title: 'The Discovered Attack',
    type: 'Lesson',
    xp: 100,
    render: () => `
      <div class="lesson-eyebrow">Module 7 ‚Äî Tactics: More Patterns</div>
      <h2 class="lesson-title">The Discovered Attack</h2>
      <p class="lesson-desc">Move one piece to unleash a surprise attack from another. Discovered attacks are devastating because the opponent has to deal with two threats at once.</p>
      <div class="lesson-board-wrap"><div id="lb-14"></div><div class="lesson-board-info"><div class="lesson-board-title">Discovered Attack</div><div class="lesson-board-desc">White moves the knight on d4, <strong>uncovering</strong> the bishop's attack on the Black queen. The knight also attacks something else simultaneously ‚Äî a double threat.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>A <strong>discovered attack</strong> happens when you move a piece out of the way, revealing an attack from the piece behind it. The moving piece can also make its own threat ‚Äî creating a double attack.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Discovered Check</strong><br>
            The most powerful version: you move a piece to reveal a check from another piece. While the opponent must deal with the check, your moving piece can capture material or create another threat. Often wins decisive material.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">Double Check</strong><br>
            The rarest and most powerful: BOTH the moving piece AND the revealed piece give check simultaneously. The only way to escape a double check is to move the king ‚Äî you cannot block or capture both checking pieces at once.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-14">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">What is the ONLY legal response to a double check?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(14,0,0,'Move the king! In a double check, two pieces are giving check simultaneously. You cannot block both or capture both ‚Äî the king must move. This is why double check is so powerful.')">
            <div class="option-letter">A</div> Move the king
          </button>
          <button class="quiz-option" onclick="answerQuiz(14,1,0,'Move the king! In a double check, two pieces are giving check simultaneously. You cannot block both or capture both ‚Äî the king must move. This is why double check is so powerful.')">
            <div class="option-letter">B</div> Block one of the checks
          </button>
          <button class="quiz-option" onclick="answerQuiz(14,2,0,'Move the king! In a double check, two pieces are giving check simultaneously. You cannot block both or capture both ‚Äî the king must move. This is why double check is so powerful.')">
            <div class="option-letter">C</div> Capture one of the checking pieces
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-14"></div>
      </div>`
  },
  {
    category: 'Tactics',
    title: 'Back Rank Mate',
    type: 'Lesson',
    xp: 100,
    render: () => `
      <div class="lesson-eyebrow">Module 7 ‚Äî Tactics: More Patterns</div>
      <h2 class="lesson-title">The Back Rank Mate</h2>
      <p class="lesson-desc">The most common checkmate at every level below grandmaster. Your own pawns become your prison ‚Äî and the enemy rook walks in for checkmate.</p>
      <div class="lesson-board-wrap"><div id="lb-15"></div><div class="lesson-board-info"><div class="lesson-board-title">Back Rank Weakness</div><div class="lesson-board-desc">Black's king is trapped behind its own pawns on g8. White's rook delivers <strong>checkmate on the 8th rank</strong>. Always keep an escape square!</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>A <strong>back rank mate</strong> happens when a king is trapped on its starting rank (rank 1 for White, rank 8 for Black) by its own pawns, and a rook or queen delivers checkmate along that rank.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">How to avoid it</strong><br>
            Create a "luft" (German for "air") ‚Äî move one of the pawns in front of your king one square forward. This gives your king an escape square. g3 or h3 are the most common luft moves.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">How to use it</strong><br>
            Before any rook trade, check: is your opponent's back rank weak? If their king has no escape square, a rook sacrifice can force the checkmate. Trade rooks to eliminate defenders, then deliver the final blow.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">The Anastasia's Mate</strong><br>
            A related pattern: a knight and rook trap the king on the edge of the board. The knight cuts off escape squares, the rook delivers checkmate.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-15">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">What is a "luft" and why is it important?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(15,0,1,'Correct! Luft means moving a pawn to give the king an escape square. Without it, your king is trapped on the back rank and vulnerable to checkmate by a rook or queen.')">
            <div class="option-letter">A</div> A pawn move that gives the king an escape square
          </button>
          <button class="quiz-option" onclick="answerQuiz(15,1,1,'Correct! Luft means moving a pawn to give the king an escape square. Without it, your king is trapped on the back rank and vulnerable to checkmate by a rook or queen.')">
            <div class="option-letter">B</div> A type of pawn sacrifice in the opening
          </button>
          <button class="quiz-option" onclick="answerQuiz(15,2,1,'Correct! Luft means moving a pawn to give the king an escape square. Without it, your king is trapped on the back rank and vulnerable to checkmate by a rook or queen.')">
            <div class="option-letter">C</div> Moving the king to safety before castling
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-15"></div>
      </div>`
  },
  {
    category: 'Tactics',
    title: 'Zwischenzug',
    type: 'Lesson',
    xp: 125,
    render: () => `
      <div class="lesson-eyebrow">Module 7 ‚Äî Tactics: More Patterns</div>
      <h2 class="lesson-title">Zwischenzug ‚Äî The In-Between Move</h2>
      <p class="lesson-desc">German for "in-between move." Instead of playing the expected move, you play a surprise shot first. One of the most mind-bending tactics in chess.</p>
      <div class="lesson-board-wrap"><div id="lb-16"></div><div class="lesson-board-info"><div class="lesson-board-title">In-Between Check</div><div class="lesson-board-desc">Instead of recapturing, White plays an <strong>intermediate check</strong> gaining tempo before returning to the expected sequence.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>A <strong>Zwischenzug</strong> (pronounced ZVISH-en-tsoog) is when you interrupt a forced sequence with an unexpected move that changes everything. Your opponent thinks they know what's coming ‚Äî then you play something completely different first.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Classic example</strong><br>
            Your opponent captures your piece. Instead of recapturing immediately (which they expect), you first give check or make a bigger threat. They must respond to YOUR threat ‚Äî and now when you recapture, the position has completely changed in your favor.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">Why it works</strong><br>
            Chess players calculate based on expected moves. A Zwischenzug breaks the pattern and forces the opponent to recalculate everything from scratch ‚Äî often under time pressure. The best Zwischenzugs are completely invisible until they appear on the board.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-16">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">What makes a Zwischenzug so effective psychologically?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(16,0,2,'Exactly! The opponent calculates the expected sequence and thinks they know what is coming. When you play an unexpected move first, they must throw out all their calculations and start over ‚Äî often under time pressure.')">
            <div class="option-letter">A</div> It captures the most valuable piece
          </button>
          <button class="quiz-option" onclick="answerQuiz(16,1,2,'Exactly! The opponent calculates the expected sequence and thinks they know what is coming. When you play an unexpected move first, they must throw out all their calculations and start over ‚Äî often under time pressure.')">
            <div class="option-letter">B</div> It breaks the opponent\'s expected calculation
          </button>
          <button class="quiz-option" onclick="answerQuiz(16,2,2,'Exactly! The opponent calculates the expected sequence and thinks they know what is coming. When you play an unexpected move first, they must throw out all their calculations and start over ‚Äî often under time pressure.')">
            <div class="option-letter">C</div> It always gives check
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-16"></div>
      </div>`
  },

  // ‚îÄ‚îÄ SECRET RULES ‚îÄ‚îÄ
  {
    category: 'Secret Rules',
    title: 'En Passant',
    type: 'Lesson',
    xp: 150,
    render: () => `
      <div class="lesson-eyebrow">Module 8 ‚Äî Secret Rules</div>
      <h2 class="lesson-title">En Passant ‚Äî The Ghost Capture</h2>
      <p class="lesson-desc">The most surprising rule in chess. A pawn captures another pawn that isn't even on the square it lands on. Beginners are always shocked when this happens to them.</p>
      <div class="lesson-board-wrap"><div id="lb-17"></div><div class="lesson-board-info"><div class="lesson-board-title">En Passant</div><div class="lesson-board-desc">Black just played d7‚Äìd5. White's e5 pawn captures <strong>en passant</strong> to d6, taking the Black pawn as if it only moved one square.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p><strong>En passant</strong> (French for "in passing") is a special pawn capture that can only happen in one specific situation: when a pawn uses its two-square first move to land beside an enemy pawn.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The Rule</strong><br>
            If your pawn is on the 5th rank and an enemy pawn moves TWO squares from its starting position to land beside your pawn, you can capture it AS IF it had only moved one square. You move diagonally forward to the square the pawn skipped over ‚Äî and the enemy pawn is removed.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The catch ‚Äî it expires!</strong><br>
            You MUST capture en passant on the very next move. If you play any other move first, the right to capture en passant disappears forever. It's now or never.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">Historical origin</strong><br>
            En passant was added to chess in the 15th century when the two-square pawn move was introduced. Without en passant, pawns could use the double move to sneak past enemy pawns unfairly. The rule preserves the original game balance.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-17">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">If you don't capture en passant immediately, what happens?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(17,0,0,'Correct! En passant is a now-or-never rule. If you play any other move, the right to capture en passant is permanently lost. You cannot take it on a later turn.')">
            <div class="option-letter">A</div> The right to capture en passant is permanently lost
          </button>
          <button class="quiz-option" onclick="answerQuiz(17,1,0,'Correct! En passant is a now-or-never rule. If you play any other move, the right to capture en passant is permanently lost. You cannot take it on a later turn.')">
            <div class="option-letter">B</div> You can still capture it on your next turn
          </button>
          <button class="quiz-option" onclick="answerQuiz(17,2,0,'Correct! En passant is a now-or-never rule. If you play any other move, the right to capture en passant is permanently lost. You cannot take it on a later turn.')">
            <div class="option-letter">C</div> The game ends in a draw
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-17"></div>
      </div>`
  },
  {
    category: 'Secret Rules',
    title: 'Castling ‚Äî All the Rules',
    type: 'Lesson',
    xp: 150,
    render: () => `
      <div class="lesson-eyebrow">Module 8 ‚Äî Secret Rules</div>
      <h2 class="lesson-title">Castling ‚Äî All the Rules</h2>
      <p class="lesson-desc">Everyone knows you can castle. But do you know all FIVE conditions that must be met? Knowing the rules lets you castle when others can't ‚Äî and stop your opponent from castling too.</p>
      <div class="lesson-board-wrap"><div id="lb-18"></div><div class="lesson-board-info"><div class="lesson-board-title">Before Castling Kingside</div><div class="lesson-board-desc">All squares between king and rook are clear. White can castle: king moves to <strong>g1</strong>, rook jumps to <strong>f1</strong>. King is safe, rook enters the game.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>Castling is the only move where two pieces move at once ‚Äî the king moves two squares toward a rook, and the rook jumps to the other side of the king.</p>
          <div class="highlight-box" style="margin-bottom:12px">
            <strong style="color:var(--gold)">The 5 Rules of Castling</strong><br>
            <br>
            <strong>1.</strong> Neither the king NOR the rook can have moved previously in the game ‚Äî even if they moved back to the original square.<br>
            <strong>2.</strong> There must be no pieces between the king and rook.<br>
            <strong>3.</strong> The king cannot be in check at the time of castling.<br>
            <strong>4.</strong> The king cannot pass through a square that is under attack.<br>
            <strong>5.</strong> The king cannot land on a square that is under attack.<br>
          </div>
          <div class="highlight-box" style="margin-bottom:12px">
            <strong style="color:var(--gold)">Kingside vs Queenside</strong><br>
            Kingside castling (0-0): king moves to g1, rook to f1. Faster and safer ‚Äî only 2 squares between king and rook.<br>
            Queenside castling (0-0-0): king moves to c1, rook to d1. More aggressive but the king ends up more exposed.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">The Rook CAN be attacked</strong><br>
            This surprises players: the rook is allowed to pass through an attacked square during queenside castling. Only the KING cannot pass through or land on an attacked square.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-18">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">Your king has never moved, but your kingside rook moved earlier and came back. Can you castle kingside?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(18,0,1,'No castling! Once the rook moves ‚Äî even if it returns to its original square ‚Äî the right to castle with that rook is permanently lost. The rule is about whether the piece has ever moved, not where it currently is.')">
            <div class="option-letter">A</div> No ‚Äî the rook already moved, so castling rights are lost
          </button>
          <button class="quiz-option" onclick="answerQuiz(18,1,1,'No castling! Once the rook moves ‚Äî even if it returns to its original square ‚Äî the right to castle with that rook is permanently lost. The rule is about whether the piece has ever moved, not where it currently is.')">
            <div class="option-letter">B</div> Yes ‚Äî the rook is back on its starting square
          </button>
          <button class="quiz-option" onclick="answerQuiz(18,2,1,'No castling! Once the rook moves ‚Äî even if it returns to its original square ‚Äî the right to castle with that rook is permanently lost. The rule is about whether the piece has ever moved, not where it currently is.')">
            <div class="option-letter">C</div> Only if no pieces are between them
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-18"></div>
      </div>`
  },
  {
    category: 'Secret Rules',
    title: 'Pawn Promotion',
    type: 'Lesson',
    xp: 150,
    render: () => `
      <div class="lesson-eyebrow">Module 8 ‚Äî Secret Rules</div>
      <h2 class="lesson-title">Pawn Promotion ‚Äî The Secret Weapon</h2>
      <p class="lesson-desc">A pawn reaches the other side of the board and becomes ANY piece it wants. This rule hides some of chess's most surprising and sneaky tactics.</p>
      <div class="lesson-board-wrap"><div id="lb-19"></div><div class="lesson-board-info"><div class="lesson-board-title">One Step From Queening</div><div class="lesson-board-desc">White's pawn on e7 is about to promote. On the next move it becomes a <strong>queen</strong> ‚Äî almost always the strongest choice.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <p>When a pawn reaches the 8th rank (for White) or 1st rank (for Black), it <strong>must</strong> be promoted ‚Äî it cannot stay a pawn. You choose: queen, rook, bishop, or knight.</p>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Why not always promote to a queen?</strong><br>
            Almost always you should ‚Äî the queen is the most powerful piece. But there are rare cases where promoting to a knight is actually stronger! A knight can give check from squares no queen can reach, and can create a fork that a queen can't.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Underpromotion</strong><br>
            Promoting to a rook, bishop, or knight is called underpromotion. The most common reason: promoting to a queen would be stalemate, but promoting to a rook gives check and wins! Always check for this before automatically grabbing a queen.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">Can you have two queens?</strong><br>
            Yes! You can promote a pawn even when you still have your original queen. In theory, you could have 9 queens at once (original + 8 promoted pawns). In practice, one extra queen is usually enough to win.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-19">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">You promote a pawn to a queen, but it creates stalemate. What should you have done instead?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(19,0,2,'Promote to a rook! A rook gives the same checkmate ability as a queen in most cases, but doesn\'t cover the extra squares that were causing stalemate. Always check for stalemate before promoting.')">
            <div class="option-letter">A</div> Don't promote ‚Äî keep it as a pawn
          </button>
          <button class="quiz-option" onclick="answerQuiz(19,1,2,'Promote to a rook! A rook gives the same checkmate ability as a queen in most cases, but doesn\'t cover the extra squares that were causing stalemate. Always check for stalemate before promoting.')">
            <div class="option-letter">B</div> Promote to a rook instead
          </button>
          <button class="quiz-option" onclick="answerQuiz(19,2,2,'Promote to a rook! A rook gives the same checkmate ability as a queen in most cases, but doesn\'t cover the extra squares that were causing stalemate. Always check for stalemate before promoting.')">
            <div class="option-letter">C</div> The stalemate cannot be avoided
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-19"></div>
      </div>`
  },
  {
    category: 'Secret Rules',
    title: 'The 50-Move Rule & Threefold Repetition',
    type: 'Lesson',
    xp: 150,
    render: () => `
      <div class="lesson-eyebrow">Module 8 ‚Äî Secret Rules</div>
      <h2 class="lesson-title">Draw Rules Nobody Tells You About</h2>
      <p class="lesson-desc">Chess has automatic draw rules that most beginners never learn. Knowing them can save a lost position ‚Äî or stop your opponent from using them against you.</p>
      <div class="lesson-board-wrap"><div id="lb-20"></div><div class="lesson-board-info"><div class="lesson-board-title">King vs King ‚Äî Drawn</div><div class="lesson-board-desc">Neither side can force checkmate. After 50 moves without a pawn move or capture, either player may claim a <strong>draw</strong>.</div></div></div></div>
      
      <div class="lesson-block">
        <div class="lesson-text">
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">The 50-Move Rule</strong><br>
            If 50 moves pass without a pawn move or a capture, either player can claim a draw. This prevents the stronger side from dragging out a theoretically winning but practically impossible endgame forever. The counter resets every time a pawn moves or a piece is captured.
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Threefold Repetition</strong><br>
            If the EXACT same position occurs three times (with the same player to move and the same castling/en passant rights), either player can claim a draw. The positions don't have to happen in a row ‚Äî just three times total. Used by grandmasters to escape losing positions!
          </div>
          <div class="highlight-box" style="margin-bottom:16px">
            <strong style="color:var(--gold)">Insufficient Material</strong><br>
            Some endgames are theoretically impossible to win ‚Äî even with perfect play. King vs King, King + Bishop vs King, King + Knight vs King ‚Äî these are automatic draws. The game ends immediately when neither side has enough material to checkmate.
          </div>
          <div class="highlight-box">
            <strong style="color:var(--gold)">Perpetual Check</strong><br>
            If you can keep giving check forever with no way for the opponent to escape, you can claim a draw by threefold repetition. A brilliant defensive resource ‚Äî you sacrifice material to force endless checks and avoid losing.
          </div>
        </div>
      </div>
      <div class="lesson-block quiz-block" id="quiz-20">
        <div class="block-label">Quick Check</div>
        <div class="quiz-question">You're losing badly. You find a way to give check every move and the position repeats three times. What can you claim?</div>
        <div class="quiz-options">
          <button class="quiz-option" onclick="answerQuiz(20,0,1,'A draw by threefold repetition! If the same position occurs three times (same player to move, same rights), either player can claim a draw. This is how grandmasters escape lost positions with perpetual check.')">
            <div class="option-letter">A</div> A draw by threefold repetition
          </button>
          <button class="quiz-option" onclick="answerQuiz(20,1,1,'A draw by threefold repetition! If the same position occurs three times (same player to move, same rights), either player can claim a draw. This is how grandmasters escape lost positions with perpetual check.')">
            <div class="option-letter">B</div> Nothing ‚Äî you still lose
          </button>
          <button class="quiz-option" onclick="answerQuiz(20,2,1,'A draw by threefold repetition! If the same position occurs three times (same player to move, same rights), either player can claim a draw. This is how grandmasters escape lost positions with perpetual check.')">
            <div class="option-letter">C</div> A win by perpetual check
          </button>
        </div>
        <div class="quiz-feedback" id="qfeedback-20"></div>
      </div>`
  },
];

// ‚îÄ‚îÄ QUIZ LOGIC ‚îÄ‚îÄ
const quizAnswered = {};
function answerQuiz(lessonIdx, chosen, correct, feedback) {
  if (quizAnswered[lessonIdx]) return;
  quizAnswered[lessonIdx] = true;
  const block = document.getElementById('quiz-' + lessonIdx);
  if (!block) return;
  const opts = block.querySelectorAll('.quiz-option');
  opts.forEach((o, i) => {
    o.classList.add('answered');
    if (i === correct) o.classList.add('correct');
    else if (i === chosen && chosen !== correct) o.classList.add('wrong');
  });
  const fb = document.getElementById('qfeedback-' + lessonIdx);
  fb.textContent = (chosen === correct ? '‚úì ' : '‚úó ') + feedback;
  fb.className = 'quiz-feedback show ' + (chosen === correct ? 'correct' : 'wrong');
  if (chosen === correct) addXP(20);
}

function puzzleAnswer(lessonIdx, chosen, correct, feedback) {
  answerQuiz(lessonIdx, chosen, correct, feedback);
}

function showHint(id) {
  const h = document.getElementById('hint-' + id);
  if (h) h.classList.add('show');
}

// ‚îÄ‚îÄ BOARD DIAGRAMS ‚îÄ‚îÄ
function renderDiagram(containerId, pieces, highlights = []) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.className = 'diagram-board';
  el.innerHTML = '';
  for (let rank = 8; rank >= 1; rank--) {
    for (let fi = 0; fi < 8; fi++) {
      const file = 'abcdefgh'[fi];
      const sq = file + rank;
      const isLight = (fi + rank) % 2 !== 0;
      const div = document.createElement('div');
      div.className = 'dsq ' + (isLight ? 'dl' : 'dd');
      if (highlights.includes(sq)) div.classList.add('highlight');
      if (pieces[sq]) div.textContent = pieces[sq];
      el.appendChild(div);
    }
  }
}

function renderStartingBoard(containerId) {
  renderDiagram(containerId, {
    a8:'‚ôú',b8:'‚ôû',c8:'‚ôù',d8:'‚ôõ',e8:'‚ôö',f8:'‚ôù',g8:'‚ôû',h8:'‚ôú',
    a7:'‚ôü',b7:'‚ôü',c7:'‚ôü',d7:'‚ôü',e7:'‚ôü',f7:'‚ôü',g7:'‚ôü',h7:'‚ôü',
    a2:'‚ôô',b2:'‚ôô',c2:'‚ôô',d2:'‚ôô',e2:'‚ôô',f2:'‚ôô',g2:'‚ôô',h2:'‚ôô',
    a1:'‚ôñ',b1:'‚ôò',c1:'‚ôó',d1:'‚ôï',e1:'‚ôî',f1:'‚ôó',g1:'‚ôò',h1:'‚ôñ',
  });
}

function renderForkPuzzle(containerId) {
  renderDiagram(containerId, {
    e8:'‚ôö', a6:'‚ôõ', e5:'‚ôò', h2:'‚ôî'
  }, ['c7']);
}


function renderLessonBoard(idx) {
  const id = 'lb-' + idx;
  if (!document.getElementById(id)) return;

  // Piece sets
  const W = { K:'‚ôî', Q:'‚ôï', R:'‚ôñ', B:'‚ôó', N:'‚ôò', P:'‚ôô' };
  const B = { K:'‚ôö', Q:'‚ôõ', R:'‚ôú', B:'‚ôù', N:'‚ôû', P:'‚ôü' };

  const boards = [
    // 0 ‚Äî Meet the Pieces: full starting position
    () => renderDiagram(id, {
      a8:B.R,b8:B.N,c8:B.B,d8:B.Q,e8:B.K,f8:B.B,g8:B.N,h8:B.R,
      a7:B.P,b7:B.P,c7:B.P,d7:B.P,e7:B.P,f7:B.P,g7:B.P,h7:B.P,
      a2:W.P,b2:W.P,c2:W.P,d2:W.P,e2:W.P,f2:W.P,g2:W.P,h2:W.P,
      a1:W.R,b1:W.N,c1:W.B,d1:W.Q,e1:W.K,f1:W.B,g1:W.N,h1:W.R,
    }),
    // 1 ‚Äî Chessboard: empty board, center highlighted
    () => renderDiagram(id, {}, ['d4','e4','d5','e5']),
    // 2 ‚Äî Check/Checkmate: king trapped, queen gives mate
    () => renderDiagram(id, {
      g8:B.K, h7:B.P, g7:B.P, f7:B.P,
      g2:W.Q, f1:W.R, e1:W.K,
    }, ['g8','g2']),
    // 3 ‚Äî The Fork: Nc7+ hits king on e8 and queen on a6
    () => renderDiagram(id, {
      e8:B.K, a6:B.Q, e5:W.N, h1:W.K,
    }, ['c7']),
    // 4 ‚Äî The Pin: Bb5 pins Nc6 to King on e8
    () => renderDiagram(id, {
      e8:B.K, c6:B.N, e7:B.P,
      b5:W.B, e1:W.K,
    }, ['c6']),
    // 5 ‚Äî The Skewer: rook skewers king, hits rook behind
    () => renderDiagram(id, {
      e8:B.K, e5:B.R,
      e1:W.R, a1:W.K,
    }, ['e8']),
    // 6 ‚Äî Opening Principles: after 1.e4 e5 2.Nf3 Nc6 3.Bc4
    () => renderDiagram(id, {
      e8:B.K, c6:B.N, e7:B.P,
      a7:B.P,b7:B.P,c7:B.P,d7:B.P,f7:B.P,g7:B.P,h7:B.P,
      a2:W.P,b2:W.P,c2:W.P,d2:W.P,f2:W.P,g2:W.P,h2:W.P,
      e4:W.P, f3:W.N, c4:W.B, e1:W.K,
    }, ['d4','e4','d5','e5']),
    // 7 ‚Äî Scholar's Mate: Qxf7# position
    () => renderDiagram(id, {
      e8:B.K, c6:B.N, f6:B.N,
      a7:B.P,b7:B.P,c7:B.P,d7:B.P,g7:B.P,h7:B.P,
      a2:W.P,b2:W.P,c2:W.P,d2:W.P,f2:W.P,g2:W.P,h2:W.P,
      e4:W.P, c4:W.B, h5:W.Q, e1:W.K,
    }, ['f7']),
    // 8 ‚Äî King & Pawn endgame: opposition
    () => renderDiagram(id, {
      e7:B.K,
      e5:W.K, e4:W.P,
    }, ['e6','e5']),
    // 9 ‚Äî Rook endgame: rook behind passed pawn
    () => renderDiagram(id, {
      e8:B.K,
      e7:W.P, e1:W.R, g1:W.K,
    }, ['e7']),
    // 10 ‚Äî Italian Game: after 1.e4 e5 2.Nf3 Nc6 3.Bc4
    () => renderDiagram(id, {
      e8:B.K, c6:B.N,
      a7:B.P,b7:B.P,c7:B.P,d7:B.P,e5:B.P,f7:B.P,g7:B.P,h7:B.P,
      a2:W.P,b2:W.P,c2:W.P,d2:W.P,f2:W.P,g2:W.P,h2:W.P,
      e4:W.P, f3:W.N, c4:W.B, e1:W.K,
    }, ['c4','f7']),
    // 11 ‚Äî Ruy Lopez: after 1.e4 e5 2.Nf3 Nc6 3.Bb5
    () => renderDiagram(id, {
      e8:B.K, c6:B.N,
      a7:B.P,b7:B.P,c7:B.P,d7:B.P,e5:B.P,f7:B.P,g7:B.P,h7:B.P,
      a2:W.P,b2:W.P,c2:W.P,d2:W.P,f2:W.P,g2:W.P,h2:W.P,
      e4:W.P, f3:W.N, b5:W.B, e1:W.K,
    }, ['b5','c6']),
    // 12 ‚Äî Sicilian: after 1.e4 c5
    () => renderDiagram(id, {
      e8:B.K,
      a7:B.P,b7:B.P,d7:B.P,e7:B.P,f7:B.P,g7:B.P,h7:B.P,c5:B.P,
      a2:W.P,b2:W.P,c2:W.P,d2:W.P,f2:W.P,g2:W.P,h2:W.P,
      e4:W.P, e1:W.K,
    }, ['c5','e4']),
    // 13 ‚Äî Queen's Gambit: after 1.d4 d5 2.c4
    () => renderDiagram(id, {
      e8:B.K,
      a7:B.P,b7:B.P,c7:B.P,e7:B.P,f7:B.P,g7:B.P,h7:B.P,d5:B.P,
      a2:W.P,b2:W.P,e2:W.P,f2:W.P,g2:W.P,h2:W.P,
      d4:W.P, c4:W.P, e1:W.K,
    }, ['c4','d5']),
    // 14 ‚Äî Discovered Attack: bishop uncovers rook hitting queen
    () => renderDiagram(id, {
      d8:B.Q, e8:B.K,
      d4:W.N, b2:W.B, e1:W.R, g1:W.K,
    }, ['d4','d8']),
    // 15 ‚Äî Back Rank Mate
    () => renderDiagram(id, {
      g8:B.K, f7:B.P, g7:B.P, h7:B.P,
      e8:W.R, g1:W.K,
    }, ['e8','g8']),
    // 16 ‚Äî Zwischenzug: White has a zwischenzug check before recapturing
    () => renderDiagram(id, {
      e8:B.K, d5:B.N,
      d1:W.Q, g5:W.B, e1:W.K,
    }, ['g5','d8']),
    // 17 ‚Äî En Passant: e5 pawn can capture d5 pawn en passant to d6
    () => renderDiagram(id, {
      e8:B.K, d5:B.P,
      e5:W.P, e1:W.K,
    }, ['d5','d6']),
    // 18 ‚Äî Castling: before kingside castle
    () => renderDiagram(id, {
      e8:B.K,
      a2:W.P,b2:W.P,c2:W.P,d2:W.P,e2:W.P,f2:W.P,g2:W.P,h2:W.P,
      a1:W.R, e1:W.K, h1:W.R,
    }, ['f1','g1']),
    // 19 ‚Äî Pawn Promotion: pawn on e7 ready to promote
    () => renderDiagram(id, {
      e8:B.K,
      e7:W.P, g1:W.K,
    }, ['e7','e8']),
    // 20 ‚Äî Draw rules: bare kings
    () => renderDiagram(id, {
      e8:B.K,
      e1:W.K,
    }, []),
  ];

  if (boards[idx]) boards[idx]();
}

// ‚îÄ‚îÄ XP & LEVELS ‚îÄ‚îÄ
const LEVELS = [
  { min:0,   label:'Pawn',    lvl:1  },
  { min:100, label:'Knight',  lvl:2  },
  { min:250, label:'Bishop',  lvl:3  },
  { min:500, label:'Rook',    lvl:4  },
  { min:750, label:'Queen',   lvl:5  },
  { min:1000,label:'King',    lvl:6  },
];

function addXP(amount) {
  xp += amount;
  const nextLevelXP = 1000;
  const pct = Math.min(100, (xp / nextLevelXP) * 100);
  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('xpLabel').textContent = xp + ' XP';
  document.getElementById('statXP').textContent = xp;
  const level = LEVELS.slice().reverse().find(l => xp >= l.min) || LEVELS[0];
  document.getElementById('levelBadge').textContent = 'LVL ' + level.lvl;
  checkBadges();
}

// ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ
function checkBadges() {
  BADGES.forEach(b => {
    if (!earnedBadges.has(b.id) && b.req()) {
      earnedBadges.add(b.id);
      showBadgeToast(b);
      document.getElementById('statBadges').textContent = earnedBadges.size;
      renderBadges();
    }
  });
}

function showBadgeToast(badge) {
  document.getElementById('toastIcon').textContent = badge.icon;
  document.getElementById('toastTitle').textContent = badge.label + ' Badge Earned!';
  document.getElementById('toastDesc').textContent = badge.desc;
  const toast = document.getElementById('badgeToast');
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 4000);
}

function renderBadges() {
  const row = document.getElementById('badgesRow');
  row.innerHTML = BADGES.map(b => `
    <div class="badge-item">
      <div class="badge-circle ${earnedBadges.has(b.id) ? 'earned' : 'locked'}">${b.icon}</div>
      <div class="badge-label ${earnedBadges.has(b.id) ? 'earned' : ''}">${b.label}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ
function renderSidebar() {
  const sidebar = document.getElementById('sidebar');
  const categories = [...new Set(LESSONS.map(l => l.category))];
  sidebar.innerHTML = categories.map(cat => {
    const catLessons = LESSONS.filter(l => l.category === cat);
    return `<div class="sidebar-section">
      <div class="sidebar-heading">${cat}</div>
      ${catLessons.map(l => {
        const idx = LESSONS.indexOf(l);
        const isDone = completed.has(idx);
        const isActive = idx === currentLesson;
        return `<button class="lesson-btn ${isActive ? 'active' : ''} ${isDone ? 'completed' : ''}" onclick="goToLesson(${idx})">
          <div class="lesson-dot"></div>
          <div class="lesson-btn-text">
            <div class="lesson-btn-title">${l.title}</div>
            <div class="lesson-btn-type">${l.type}</div>
          </div>
          ${isDone ? '<span class="lesson-check">‚úì</span>' : ''}
        </button>`;
      }).join('')}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ LESSON RENDERING ‚îÄ‚îÄ
function renderLesson(idx) {
  const area = document.getElementById('lessonArea');
  const lesson = LESSONS[idx];
  const total = LESSONS.length;
  area.innerHTML = `
    <div class="lesson-card active" id="lesson-${idx}">
      ${lesson.render()}
      <div class="lesson-footer">
        <button class="btn-ghost" onclick="prevLesson()" ${idx === 0 ? 'disabled style="opacity:0.3"' : ''}>‚Üê Previous</button>
        <div class="lesson-progress-text">Lesson ${idx + 1} of ${total}</div>
        <button class="btn-primary" onclick="completeLesson(${idx})">Complete & Continue ‚Üí</button>
      </div>
    </div>`;

  // Render lesson boards
  setTimeout(() => renderLessonBoard(idx), 50);
}

function goToLesson(idx) {
  currentLesson = idx;
  renderLesson(idx);
  renderSidebar();
  document.querySelector('.content').scrollTo({ top: 0, behavior: 'smooth' });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function completeLesson(idx) {
  if (!completed.has(idx)) {
    completed.add(idx);
    addXP(LESSONS[idx].xp);
    document.getElementById('statCompleted').textContent = completed.size;
    checkBadges();
    saveProgress();
  }
  if (idx + 1 < LESSONS.length) {
    goToLesson(idx + 1);
  } else {
    showComplete();
  }
}

function prevLesson() {
  if (currentLesson > 0) goToLesson(currentLesson - 1);
}

function showComplete() {
  document.getElementById('lessonArea').innerHTML = `
    <div class="complete-screen show">
      <div class="complete-icon">‚ôî</div>
      <h2>Course Complete!</h2>
      <p>You've completed all 10 lessons in the Malachi AI Chess Academy. You've earned ${xp} XP and ${earnedBadges.size} badges. Now go practice what you've learned!</p>
      <a href="play.html"><button class="btn-primary" style="margin-right:12px">Play a Game ‚Üí</button></a>
      <button class="btn-ghost" onclick="goToLesson(0)">Review Lessons</button>
    </div>`;
}

// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const SUPABASE_URL = 'https://nlsmrveieqadjmytsmjm.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sc21ydmVpZXFhZGpteXRzbWptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTg4NjcsImV4cCI6MjA4NzI5NDg2N30.9uIWjPJsOhdXXHqGLIMcdY5eitbkGoHyhbreAEe-apM';

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
const { createClient } = supabase.createClient ? supabase : window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, storageKey: 'malachi-auth' } });

async function init() {
  renderBadges();
  renderSidebar();

  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    // Get profile
    const { data: profile } = await sb.from('profiles').select('*').eq('id', session.user.id).single();
    if (profile) {
      // Show name in nav
      const navLinks = document.querySelector('.nav-links');
      const nameEl = document.createElement('span');
      nameEl.style.cssText = 'font-family:"DM Mono",monospace;font-size:11px;color:var(--gold);letter-spacing:0.08em;padding:8px 0;';
      nameEl.textContent = profile.username;
      navLinks.appendChild(nameEl);

      // Show sign out button
      const signOutBtn = document.createElement('button');
      signOutBtn.className = 'nav-link';
      signOutBtn.textContent = 'Sign Out';
      signOutBtn.onclick = async () => { await sb.auth.signOut(); window.location.href = 'login.html'; };
      navLinks.appendChild(signOutBtn);

      // Show dashboard link only for teachers/parents
      if (profile.role === 'teacher' || profile.role === 'parent') {
        document.getElementById('dashboardLink').style.display = 'inline-block';
      }
    }

    // Load saved progress
    const { data } = await sb.from('progress').select('*').eq('user_id', session.user.id).single();
    if (data) {
      xp = data.xp || 0;
      // Load actual completed lesson indices if available, otherwise fall back to count
      if (data.badges && Array.isArray(data.badges) && data.quiz_scores && data.quiz_scores.completed_lessons) {
        completed = new Set(data.quiz_scores.completed_lessons);
      } else {
        completed = new Set(Array.from({length: data.lessons_completed}, (_, i) => i));
      }
      earnedBadges = new Set(data.badges || []);
      document.getElementById('statCompleted').textContent = completed.size;
      document.getElementById('statXP').textContent = xp;
      document.getElementById('statBadges').textContent = earnedBadges.size;
      const pct = Math.min(100, (xp / 1000) * 100);
      document.getElementById('xpFill').style.width = pct + '%';
      document.getElementById('xpLabel').textContent = xp + ' XP';
    }
  } else {
    // Not logged in ‚Äî show sign in button
    const navLinks = document.querySelector('.nav-links');
    const signInBtn = document.createElement('a');
    signInBtn.href = 'login.html';
    signInBtn.className = 'nav-link';
    signInBtn.textContent = 'Sign In';
    signInBtn.style.color = 'var(--gold)';
    navLinks.appendChild(signInBtn);
  }

  renderLesson(currentLesson);
}

async function saveProgress() {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) return;

  // Store actual lesson indices so we know WHICH lessons were completed, not just how many
  const behaviorData = {};
  try {
    const { data: existing } = await sb.from('progress').select('quiz_scores').eq('user_id', session.user.id).single();
    Object.assign(behaviorData, existing?.quiz_scores || {});
  } catch(e) {}

  behaviorData.completed_lessons = [...completed]; // actual indices e.g. [0, 2, 4]

  const { error } = await sb.from('progress').update({
    lessons_completed: completed.size,
    xp: xp,
    badges: [...earnedBadges],
    quiz_scores: behaviorData,
    updated_at: new Date().toISOString()
  }).eq('user_id', session.user.id);

  if (error) {
    console.error('‚ùå Save failed:', error.message);
  } else {
    console.log('‚úÖ Progress saved ‚Äî lessons:', completed.size, 'xp:', xp);
  }
}

init();
</script>
</body>
</html>
