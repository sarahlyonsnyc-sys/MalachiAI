<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malachi AI ‚Äî Puzzle Trainer</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <style>
    :root {
      --black:  #0a0a0a;
      --dark:   #111111;
      --panel:  #161616;
      --panel2: #1c1c1c;
      --border: #2a2a2a;
      --gold:   #c9a84c;
      --gold2:  #e8c97a;
      --cream:  #f5f0e8;
      --muted:  #6b6b6b;
      --white:  #ffffff;
      --green:  #4caf50;
      --red:    #e05068;
      --blue:   #5b8dee;
      --purple: #9c6fe4;
      --orange: #f0924a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { background: var(--black); color: var(--cream); font-family: 'Outfit', sans-serif; overflow-x: hidden; min-height: 100vh; }
    .cursor { position:fixed; width:10px; height:10px; background:var(--gold); border-radius:50%; pointer-events:none; z-index:9999; transform:translate(-50%,-50%); mix-blend-mode:difference; }
    .cursor-ring { position:fixed; width:32px; height:32px; border:1px solid var(--gold); border-radius:50%; pointer-events:none; z-index:9998; transform:translate(-50%,-50%); opacity:0.4; transition:left 0.12s ease-out,top 0.12s ease-out; }
    .chess-bg { position:fixed; inset:0; z-index:0; opacity:0.025; background-image:repeating-conic-gradient(var(--gold) 0% 25%, transparent 0% 50%); background-size:48px 48px; pointer-events:none; }

    /* NAV */
    nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:18px 40px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.96); backdrop-filter:blur(12px); }
    .logo { display:flex; align-items:center; gap:12px; text-decoration:none; }
    .logo-icon { display:grid; grid-template-columns:1fr 1fr; gap:2px; width:18px; height:18px; }
    .logo-icon span { background:var(--gold); border-radius:1px; display:block; }
    .logo-icon span:nth-child(2),.logo-icon span:nth-child(3) { background:transparent; border:1px solid var(--gold); }
    .logo-text { font-family:'DM Mono',monospace; font-size:13px; letter-spacing:0.1em; color:var(--cream); }
    .logo-text span { color:var(--gold); }
    .nav-right { display:flex; align-items:center; gap:16px; }
    .nav-link { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); text-decoration:none; padding:8px 14px; border:1px solid transparent; transition:all 0.2s; }
    .nav-link:hover, .nav-link.active { color:var(--gold); border-color:var(--border); }
    .streak-badge { font-family:'DM Mono',monospace; font-size:11px; color:var(--orange); background:rgba(240,146,74,0.1); border:1px solid rgba(240,146,74,0.3); padding:6px 12px; letter-spacing:0.08em; }

    /* MAIN LAYOUT */
    .main { position:relative; z-index:1; display:grid; grid-template-columns: 280px 1fr 300px; gap:0; min-height: calc(100vh - 65px); }

    /* LEFT SIDEBAR ‚Äî filters */
    .sidebar-left { background:var(--panel); border-right:1px solid var(--border); padding:24px 0; overflow-y:auto; }
    .sidebar-section { padding:0 20px 20px; }
    .sidebar-title { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.2em; color:var(--muted); text-transform:uppercase; margin-bottom:12px; padding-top:20px; border-top:1px solid var(--border); }
    .sidebar-title:first-child { border-top:none; padding-top:0; }
    .filter-btn { width:100%; text-align:left; background:none; border:1px solid transparent; color:var(--muted); font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.06em; padding:9px 12px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:space-between; margin-bottom:3px; }
    .filter-btn:hover { color:var(--cream); border-color:var(--border); }
    .filter-btn.active { color:var(--gold); background:rgba(201,168,76,0.08); border-color:rgba(201,168,76,0.3); }
    .filter-count { font-size:9px; color:var(--muted); }

    .rating-range { padding:0 4px; }
    .rating-label { display:flex; justify-content:space-between; font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); margin-bottom:8px; }
    input[type=range] { width:100%; accent-color:var(--gold); }

    /* CENTER ‚Äî board */
    .board-area { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:32px 24px; gap:20px; }
    .puzzle-header { width:100%; max-width:520px; display:flex; align-items:center; justify-content:space-between; }
    .puzzle-title { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.15em; color:var(--muted); text-transform:uppercase; }
    .puzzle-rating-badge { font-family:'DM Mono',monospace; font-size:11px; color:var(--gold); background:rgba(201,168,76,0.1); border:1px solid rgba(201,168,76,0.2); padding:5px 12px; }

    .board-wrap { position:relative; }
    #puzzle-board { display:grid; grid-template-columns:repeat(8,1fr); width:480px; height:480px; border:2px solid var(--border); box-shadow:0 0 40px rgba(0,0,0,0.6); }
    .sq { width:60px; height:60px; display:flex; align-items:center; justify-content:center; position:relative; cursor:pointer; transition:background 0.1s; }
    .sq.light { background:#2a2a2a; }
    .sq.dark  { background:#1a1a1a; }
    .sq.selected { background:rgba(201,168,76,0.4) !important; }
    .sq.hint    { background:rgba(91,141,238,0.35) !important; }
    .sq.correct { background:rgba(76,175,80,0.45) !important; }
    .sq.wrong   { background:rgba(224,80,104,0.45) !important; }
    .sq.last-from { background:rgba(201,168,76,0.2) !important; }
    .sq.last-to   { background:rgba(201,168,76,0.3) !important; }
    .piece { font-size:38px; line-height:1; user-select:none; pointer-events:none; }
    .piece.white { color:#f0e6cc; filter: drop-shadow(1px 1px 0 #000) drop-shadow(-1px -1px 0 #000) drop-shadow(1px -1px 0 #000) drop-shadow(-1px 1px 0 #000); }
    .piece.black { color:#111; filter: drop-shadow(1px 1px 0 rgba(255,255,255,0.8)) drop-shadow(-1px -1px 0 rgba(255,255,255,0.8)) drop-shadow(1px -1px 0 rgba(255,255,255,0.6)) drop-shadow(-1px 1px 0 rgba(255,255,255,0.6)); }
    .sq-label { position:absolute; bottom:2px; right:3px; font-size:8px; font-family:'DM Mono',monospace; color:rgba(255,255,255,0.2); pointer-events:none; }
    .sq-label-rank { position:absolute; top:2px; left:3px; font-size:8px; font-family:'DM Mono',monospace; color:rgba(255,255,255,0.2); pointer-events:none; }
    .move-dot { position:absolute; width:18px; height:18px; background:rgba(201,168,76,0.55); border-radius:50%; pointer-events:none; }
    .capture-ring { position:absolute; inset:3px; border:3px solid rgba(201,168,76,0.55); border-radius:50%; pointer-events:none; }

    .to-move-bar { width:480px; display:flex; align-items:center; gap:12px; font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); letter-spacing:0.08em; }
    .to-move-dot { width:12px; height:12px; border-radius:50%; border:2px solid var(--border); }
    .to-move-dot.white { background:#f0f0f0; }
    .to-move-dot.black { background:#2a2a2a; border-color:#666; }

    .puzzle-controls { width:480px; display:flex; gap:10px; }
    .ctrl-btn { flex:1; padding:11px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; text-transform:uppercase; border:1px solid var(--border); background:var(--panel); color:var(--muted); cursor:pointer; transition:all 0.2s; }
    .ctrl-btn:hover { color:var(--cream); border-color:var(--muted); }
    .ctrl-btn.primary { border-color:rgba(201,168,76,0.4); color:var(--gold); background:rgba(201,168,76,0.06); }
    .ctrl-btn.primary:hover { background:rgba(201,168,76,0.12); }

    /* FEEDBACK OVERLAY */
    .feedback-overlay { width:480px; padding:16px 20px; display:none; align-items:center; gap:14px; border:1px solid var(--border); }
    .feedback-overlay.show { display:flex; }
    .feedback-overlay.success { border-color:rgba(76,175,80,0.4); background:rgba(76,175,80,0.07); }
    .feedback-overlay.fail    { border-color:rgba(224,80,104,0.4); background:rgba(224,80,104,0.07); }
    .feedback-icon { font-size:24px; }
    .feedback-text { flex:1; }
    .feedback-title { font-weight:600; font-size:14px; margin-bottom:3px; }
    .feedback-overlay.success .feedback-title { color:var(--green); }
    .feedback-overlay.fail .feedback-title { color:var(--red); }
    .feedback-desc { font-size:12px; color:var(--muted); line-height:1.5; }

    /* RIGHT SIDEBAR ‚Äî stats + themes */
    .sidebar-right { background:var(--panel); border-left:1px solid var(--border); padding:24px 20px; overflow-y:auto; }
    .stat-row { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border); }
    .stat-row:last-child { border-bottom:none; }
    .stat-label { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.1em; color:var(--muted); text-transform:uppercase; }
    .stat-value { font-family:'DM Mono',monospace; font-size:16px; color:var(--gold); font-weight:600; }
    .stat-value.green { color:var(--green); }
    .stat-value.red { color:var(--red); }

    .themes-list { display:flex; flex-wrap:wrap; gap:6px; margin-top:12px; }
    .theme-tag { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:0.08em; padding:4px 9px; background:rgba(201,168,76,0.08); border:1px solid rgba(201,168,76,0.2); color:var(--gold); text-transform:uppercase; }
    .theme-tag.blue { background:rgba(91,141,238,0.08); border-color:rgba(91,141,238,0.2); color:var(--blue); }
    .theme-tag.purple { background:rgba(156,111,228,0.08); border-color:rgba(156,111,228,0.2); color:var(--purple); }
    .theme-tag.green { background:rgba(76,175,80,0.08); border-color:rgba(76,175,80,0.2); color:var(--green); }

    .history-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); }
    .history-item:last-child { border-bottom:none; }
    .history-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .history-dot.win { background:var(--green); }
    .history-dot.loss { background:var(--red); }
    .history-info { flex:1; font-size:11px; color:var(--muted); font-family:'DM Mono',monospace; }
    .history-rating { font-family:'DM Mono',monospace; font-size:11px; color:var(--gold); }

    /* LOADING */
    .loading-state { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; height:480px; width:480px; }
    .loading-chess { font-size:48px; animation:spin 2s linear infinite; }
    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
    .loading-text { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.15em; color:var(--muted); text-transform:uppercase; }

    /* ERROR STATE */
    .error-state { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; height:480px; width:480px; text-align:center; padding:40px; }
    .error-icon { font-size:48px; }
    .error-title { font-size:16px; font-weight:600; color:var(--cream); }
    .error-desc { font-size:12px; color:var(--muted); line-height:1.6; }

    .section-head { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.2em; color:var(--muted); text-transform:uppercase; margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid var(--border); }

    @media (max-width: 1100px) {
      .main { grid-template-columns: 220px 1fr; }
      .sidebar-right { display:none; }
    }
    @media (max-width: 800px) {
      .main { grid-template-columns: 1fr; }
      .sidebar-left { display:none; }
      #puzzle-board { width:360px; height:360px; }
      .sq { width:45px; height:45px; }
      .piece { font-size:28px; }
      .to-move-bar, .puzzle-controls, .feedback-overlay { width:360px; }
    }
  </style>
</head>
<body>
<div class="cursor" id="cursor"></div>
<div class="cursor-ring" id="cursorRing"></div>
<div class="chess-bg"></div>

<nav>
  <a href="index.html" class="logo">
    <div class="logo-icon"><span></span><span></span><span></span><span></span></div>
    <div class="logo-text">Malachi <span>AI</span></div>
  </a>
  <div class="nav-right">
    <a href="index.html" class="nav-link">Home</a>
    <a href="learn.html" class="nav-link">Learn</a>
    <a href="openings.html" class="nav-link">Openings</a>
    <a href="play.html" class="nav-link">Play</a>
    <a href="dashboard.html" class="nav-link">Dashboard</a>
    <div class="streak-badge" id="streakBadge">üî• 0 Streak</div>
  </div>
</nav>

<div class="main">
  <!-- LEFT SIDEBAR -->
  <div class="sidebar-left">
    <div class="sidebar-section">
      <div class="sidebar-title">Difficulty</div>
      <button class="filter-btn active" onclick="setThemeFilter('all')" id="filter-all">All Puzzles <span class="filter-count">‚àû</span></button>
      <button class="filter-btn" onclick="setThemeFilter('oneMove')" id="filter-oneMove">Beginner <span class="filter-count">1 move</span></button>
      <button class="filter-btn" onclick="setThemeFilter('short')" id="filter-short">Easy <span class="filter-count">2 moves</span></button>
      <button class="filter-btn" onclick="setThemeFilter('fork')" id="filter-fork">Forks <span class="filter-count">‚ëÇ</span></button>
      <button class="filter-btn" onclick="setThemeFilter('pin')" id="filter-pin">Pins <span class="filter-count">üìå</span></button>
      <button class="filter-btn" onclick="setThemeFilter('skewer')" id="filter-skewer">Skewers</button>
      <button class="filter-btn" onclick="setThemeFilter('discoveredAttack')" id="filter-discoveredAttack">Discovered Attack</button>
      <button class="filter-btn" onclick="setThemeFilter('backRankMate')" id="filter-backRankMate">Back Rank Mate</button>
      <button class="filter-btn" onclick="setThemeFilter('mateIn1')" id="filter-mateIn1">Mate in 1</button>
      <button class="filter-btn" onclick="setThemeFilter('mateIn2')" id="filter-mateIn2">Mate in 2</button>
      <button class="filter-btn" onclick="setThemeFilter('mateIn3')" id="filter-mateIn3">Mate in 3+</button>
      <button class="filter-btn" onclick="setThemeFilter('endgame')" id="filter-endgame">Endgame</button>
      <button class="filter-btn" onclick="setThemeFilter('opening')" id="filter-opening">Opening Traps</button>
      <button class="filter-btn" onclick="setThemeFilter('sacrifice')" id="filter-sacrifice">Sacrifices</button>
      <button class="filter-btn" onclick="setThemeFilter('crushing')" id="filter-crushing">Crushing</button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Rating Range</div>
      <div class="rating-range">
        <div class="rating-label">
          <span>Min: <span id="ratingMinLabel">600</span></span>
          <span>Max: <span id="ratingMaxLabel">2400</span></span>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-bottom:8px;line-height:1.7">
          600 = beginner &nbsp;¬∑&nbsp; 1200 = intermediate<br>1800 = advanced &nbsp;¬∑&nbsp; 2400 = master
        </div>
        <input type="range" id="ratingMin" min="600" max="2400" step="100" value="600" oninput="updateRatingLabel()">
        <input type="range" id="ratingMax" min="600" max="2400" step="100" value="2400" oninput="updateRatingLabel()" style="margin-top:8px">
      </div>
    </div>
  </div>

  <!-- BOARD CENTER -->
  <div class="board-area">
    <div class="puzzle-header">
      <div class="puzzle-title" id="puzzleTitle">Tactics Trainer ‚Äî Powered by Lichess</div>
      <div class="puzzle-rating-badge" id="puzzleRatingBadge">Rating: ‚Äî</div>
    </div>

    <div class="board-wrap">
      <div id="puzzle-board">
        <div class="loading-state">
          <div class="loading-chess">‚ôü</div>
          <div class="loading-text">Loading puzzle...</div>
        </div>
      </div>
    </div>

    <div class="to-move-bar">
      <div class="to-move-dot" id="toMoveDot"></div>
      <span id="toMoveText">Loading...</span>
    </div>

    <div class="feedback-overlay" id="feedbackOverlay">
      <div class="feedback-icon" id="feedbackIcon"></div>
      <div class="feedback-text">
        <div class="feedback-title" id="feedbackTitle"></div>
        <div class="feedback-desc" id="feedbackDesc"></div>
      </div>
    </div>

    <div class="puzzle-controls">
      <button class="ctrl-btn" onclick="showHint()">üí° Hint</button>
      <button class="ctrl-btn" onclick="showAnswer()">üëÅ Answer</button>
      <button class="ctrl-btn" onclick="restartPuzzle()" style="color:#e8c97a;border-color:rgba(232,201,122,0.3)">üîÑ Retry</button>
      <button class="ctrl-btn primary" onclick="loadNextPuzzle()">Next ‚Üí</button>
    </div>
    <div class="puzzle-controls" style="margin-top:6px">
      <button class="ctrl-btn" id="reviewBackBtn" onclick="reviewBack()" disabled style="opacity:0.35">‚Üê Back</button>
      <button class="ctrl-btn" id="reviewLabel" style="cursor:default;flex:2;font-size:9px">Review moves</button>
      <button class="ctrl-btn" id="reviewFwdBtn" onclick="reviewForward()" disabled style="opacity:0.35">Forward ‚Üí</button>
    </div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="sidebar-right">
    <div class="section-head">Your Session</div>
    <div class="stat-row"><span class="stat-label">Solved</span><span class="stat-value green" id="statSolved">0</span></div>
    <div class="stat-row"><span class="stat-label">Failed</span><span class="stat-value red" id="statFailed">0</span></div>
    <div class="stat-row"><span class="stat-label">Streak</span><span class="stat-value" id="statStreak">0 üî•</span></div>
    <div class="stat-row"><span class="stat-label">Accuracy</span><span class="stat-value" id="statAccuracy">‚Äî</span></div>
    <div class="stat-row"><span class="stat-label">Best Streak</span><span class="stat-value" id="statBestStreak">0</span></div>

    <div class="section-head" style="margin-top:24px">Current Puzzle</div>
    <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:8px;letter-spacing:0.06em;">THEMES</div>
    <div class="themes-list" id="themesList"></div>

    <div class="section-head" style="margin-top:24px">Recent History</div>
    <div id="historyList"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ
const cursor = document.getElementById('cursor');
const ring = document.getElementById('cursorRing');
document.addEventListener('mousemove', e => {
  cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
  ring.style.left = e.clientX + 'px'; ring.style.top = e.clientY + 'px';
});

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let game = null;
let currentPuzzle = null;
let solutionMoves = [];
let solutionIndex = 0;
let selectedSquare = null;
let reviewMode = false;
let reviewMoves = [];
let reviewIndex = 0;
let puzzleSolved = false;
let puzzleFailed = false;
let hintUsed = false;
let playerColor = 'w';

let stats = { solved: 0, failed: 0, streak: 0, bestStreak: 0, history: [] };
let currentThemeFilter = 'all';
let puzzleQueue = [];
let loadingNext = false;

const PIECE_UNICODE = {
  wK:'‚ôî', wQ:'‚ôï', wR:'‚ôñ', wB:'‚ôó', wN:'‚ôò', wP:'‚ôô',
  bK:'‚ôö', bQ:'‚ôõ', bR:'‚ôú', bB:'‚ôù', bN:'‚ôû', bP:'‚ôü'
};

const THEME_COLORS = {
  fork:'gold', pin:'blue', skewer:'purple', discoveredAttack:'blue',
  backRankMate:'red', mateIn1:'red', mateIn2:'red', mateIn3:'red',
  endgame:'green', opening:'green', sacrifice:'purple', crushing:'gold',
  short:'green', long:'purple', oneMove:'green'
};

function themeClass(t) { return THEME_COLORS[t] || ''; }

function prettyTheme(t) {
  return t.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();
}

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
function setThemeFilter(theme) {
  currentThemeFilter = theme;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('filter-' + theme);
  if (btn) btn.classList.add('active');
  puzzleQueue = [];
  loadNextPuzzle();
}

function updateRatingLabel() {
  const min = parseInt(document.getElementById('ratingMin').value);
  const max = parseInt(document.getElementById('ratingMax').value);
  document.getElementById('ratingMinLabel').textContent = min;
  document.getElementById('ratingMaxLabel').textContent = max;
}

// ‚îÄ‚îÄ LICHESS API ‚îÄ‚îÄ
// ‚îÄ‚îÄ SUPABASE ENGINE ‚îÄ‚îÄ
const SB_URL = 'https://nlsmrveieqadjmytsmjm.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sc21ydmVpZXFhZGpteXRzbWptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTg4NjcsImV4cCI6MjA4NzI5NDg2N30.9uIWjPJsOhdXXHqGLIMcdY5eitbkGoHyhbreAEe-apM';

async function refillQueue() {
  const minR = parseInt(document.getElementById('ratingMin').value);
  const maxR = parseInt(document.getElementById('ratingMax').value);
  const base = SB_URL + '/rest/v1/puzzles';
  const hdrs = { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Accept': 'application/json' };
  let cUrl = `${base}?select=id&rating=gte.${minR}&rating=lte.${maxR}&limit=1`;
  if (currentThemeFilter !== 'all') cUrl += `&themes=ilike.*${currentThemeFilter}*`;
  const cRes = await fetch(cUrl, { headers: { ...hdrs, 'Prefer': 'count=exact' } });
  const total = parseInt((cRes.headers.get('content-range') || '0/50000').split('/')[1]) || 50000;
  const offset = Math.floor(Math.random() * Math.max(0, total - 30));
  let url = `${base}?select=id,fen,moves,rating,themes&rating=gte.${minR}&rating=lte.${maxR}&order=id.asc&offset=${offset}&limit=30`;
  if (currentThemeFilter !== 'all') url += `&themes=ilike.*${currentThemeFilter}*`;
  const res = await fetch(url, { headers: hdrs });
  if (!res.ok) throw new Error('DB error ' + res.status);
  const data = await res.json();
  if (!data.length) throw new Error('No puzzles found for this filter.');
  for (let i = data.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [data[i],data[j]]=[data[j],data[i]]; }
  puzzleQueue = data;
}

async function loadNextPuzzle() {
  puzzleSolved = false; puzzleFailed = false; hintUsed = false; selectedSquare = null;
  document.getElementById('feedbackOverlay').className = 'feedback-overlay';
  document.getElementById('toMoveText').textContent = 'Loading...';
  document.getElementById('puzzleRatingBadge').textContent = 'Rating: ‚Äî';
  document.getElementById('themesList').innerHTML = '';
  document.getElementById('puzzle-board').innerHTML = '<div class="loading-state"><div class="loading-chess">‚ôü</div><div class="loading-text">Loading puzzle...</div></div>';
  try {
    if (puzzleQueue.length === 0) await refillQueue();
    const p = puzzleQueue.shift();
    currentPuzzle = { id:p.id, fen:p.fen, moves:p.moves, rating:p.rating, themes:(p.themes||'').split(' ').filter(Boolean) };
    setupPuzzle({ puzzle: currentPuzzle });
  } catch(e) { showError(e); }
}

function setupPuzzle(data) {
  const puzzle = data.puzzle;
  const fen = puzzle.fen;
  const movesUCI = puzzle.moves.split(' '); // all moves: first is opponent's setup move, rest are solution

  game = new Chess(fen);

  // Play the first move (opponent's move that sets up the puzzle)
  const setupMove = movesUCI[0];
  const from = setupMove.slice(0,2);
  const to = setupMove.slice(2,4);
  const promo = setupMove[4] || undefined;
  game.move({ from, to, promotion: promo });

  // Solution is everything after the first move
  solutionMoves = movesUCI.slice(1);
  solutionIndex = 0;
  playerColor = game.turn(); // whoever moves next is the player

  // Update header
  const rating = puzzle.rating || '?';
  document.getElementById('puzzleRatingBadge').textContent = 'Rating: ' + rating;
  document.getElementById('puzzleTitle').textContent = 'Find the best move ‚Äî ' + (playerColor === 'w' ? 'White' : 'Black') + ' to move';

  // Themes
  const themes = (puzzle.themes || []);
  const themeHtml = themes.slice(0,8).map(t =>
    `<span class="theme-tag ${themeClass(t)}">${prettyTheme(t)}</span>`
  ).join('');
  document.getElementById('themesList').innerHTML = themeHtml;

  renderBoard();
  updateToMove();
  animateSetupMove(from, to);
}

function animateSetupMove(from, to) {
  // Briefly highlight the setup move squares
  setTimeout(() => {
    const fromEl = document.querySelector(`[data-sq="${from}"]`);
    const toEl = document.querySelector(`[data-sq="${to}"]`);
    if (fromEl) fromEl.classList.add('last-from');
    if (toEl) toEl.classList.add('last-to');
    setTimeout(() => {
      if (fromEl) fromEl.classList.remove('last-from');
      if (toEl) toEl.classList.remove('last-to');
    }, 800);
  }, 100);
}

// ‚îÄ‚îÄ BOARD RENDERING ‚îÄ‚îÄ
function renderBoard() {
  const board = document.getElementById('puzzle-board');
  board.innerHTML = '';
  const pos = game.board();

  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const rank = playerColor === 'w' ? 7 - r : r;
      const file = playerColor === 'w' ? c : 7 - c;
      const sq = 'abcdefgh'[file] + (rank + 1);
      const piece = pos[rank] ? pos[rank][file] : null;
      const isLight = (rank + file) % 2 === 1;

      const div = document.createElement('div');
      div.className = 'sq ' + (isLight ? 'light' : 'dark');
      div.dataset.sq = sq;
      div.onclick = () => handleSquareClick(sq);

      if (piece) {
        const key = piece.color + piece.type.toUpperCase();
        const p = document.createElement('div');
        p.className = 'piece ' + (piece.color === 'w' ? 'white' : 'black');
        p.textContent = PIECE_UNICODE[key] || '?';
        div.appendChild(p);
      }

      if (c === 0) {
        const lbl = document.createElement('div');
        lbl.className = 'sq-label-rank';
        lbl.textContent = rank + 1;
        div.appendChild(lbl);
      }
      if (r === 7) {
        const lbl = document.createElement('div');
        lbl.className = 'sq-label';
        lbl.textContent = 'abcdefgh'[file];
        div.appendChild(lbl);
      }

      board.appendChild(div);
    }
  }

  // Show move dots for selected piece
  if (selectedSquare && !puzzleSolved && !puzzleFailed) {
    const moves = game.moves({ square: selectedSquare, verbose: true });
    moves.forEach(m => {
      const toEl = document.querySelector(`[data-sq="${m.to}"]`);
      if (!toEl) return;
      const targetPiece = game.get(m.to);
      if (targetPiece) {
        const ring = document.createElement('div');
        ring.className = 'capture-ring';
        toEl.appendChild(ring);
      } else {
        const dot = document.createElement('div');
        dot.className = 'move-dot';
        toEl.appendChild(dot);
      }
    });
    const selEl = document.querySelector(`[data-sq="${selectedSquare}"]`);
    if (selEl) selEl.classList.add('selected');
  }
}

function updateToMove() {
  const dot = document.getElementById('toMoveDot');
  const txt = document.getElementById('toMoveText');
  dot.className = 'to-move-dot ' + (playerColor === 'w' ? 'white' : 'black');
  txt.textContent = 'You are ' + (playerColor === 'w' ? 'White ‚ôî' : 'Black ‚ôö') + ' ‚Äî find the best move!';
}

// ‚îÄ‚îÄ MOVE HANDLING ‚îÄ‚îÄ
function handleSquareClick(sq) {
  if (puzzleSolved || puzzleFailed) return;
  if (game.turn() !== playerColor) return;

  const piece = game.get(sq);

  if (selectedSquare) {
    if (selectedSquare === sq) {
      selectedSquare = null;
      renderBoard();
      return;
    }
    // Try the move
    const move = attemptMove(selectedSquare, sq);
    if (move) {
      selectedSquare = null;
      return;
    }
    // If clicked own piece, select it instead
    if (piece && piece.color === playerColor) {
      selectedSquare = sq;
      renderBoard();
      return;
    }
    selectedSquare = null;
    renderBoard();
    return;
  }

  if (piece && piece.color === playerColor) {
    selectedSquare = sq;
    renderBoard();
  }
}

function attemptMove(from, to) {
  const promotion = needsPromotion(from, to) ? 'q' : undefined;
  const move = game.move({ from, to, promotion });
  if (!move) return null;

  // Check if move matches solution
  const expected = solutionMoves[solutionIndex];
  const expectedFrom = expected.slice(0,2);
  const expectedTo = expected.slice(2,4);
  const playerMoveUCI = from + to + (promotion || '');
  const expectedUCI = expected.slice(0,4) + (expected[4] || '');

  if (from === expectedFrom && to === expectedTo) {
    // Correct!
    flashSquares(from, to, 'correct');
    solutionIndex++;

    if (solutionIndex >= solutionMoves.length) {
      // Puzzle complete!
      onPuzzleSolved();
    } else {
      // Play opponent's response
      renderBoard();
      setTimeout(() => playOpponentMove(), 700);
    }
  } else {
    // Wrong move
    game.undo();
    flashSquares(from, to, 'wrong');
    onPuzzleFailed(from, to);
  }

  renderBoard();
  return move;
}

function playOpponentMove() {
  if (solutionIndex >= solutionMoves.length) return;
  const oppMove = solutionMoves[solutionIndex];
  const from = oppMove.slice(0,2);
  const to = oppMove.slice(2,4);
  const promo = oppMove[4] || undefined;
  game.move({ from, to, promotion: promo });
  solutionIndex++;
  flashSquares(from, to, 'last-from');
  renderBoard();
  if (solutionIndex >= solutionMoves.length) {
    onPuzzleSolved();
  }
}

function needsPromotion(from, to) {
  const piece = game.get(from);
  if (!piece || piece.type !== 'p') return false;
  const toRank = parseInt(to[1]);
  return (piece.color === 'w' && toRank === 8) || (piece.color === 'b' && toRank === 1);
}

function flashSquares(from, to, cls) {
  const fromEl = document.querySelector(`[data-sq="${from}"]`);
  const toEl = document.querySelector(`[data-sq="${to}"]`);
  if (fromEl) { fromEl.classList.add(cls); setTimeout(() => fromEl.classList.remove(cls), 700); }
  if (toEl)   { toEl.classList.add(cls);   setTimeout(() => toEl.classList.remove(cls), 700); }
}

// ‚îÄ‚îÄ PUZZLE OUTCOME ‚îÄ‚îÄ
function onPuzzleSolved() {
  setTimeout(enterReviewMode, 400);
  puzzleSolved = true;
  stats.solved++;
  stats.streak++;
  if (stats.streak > stats.bestStreak) stats.bestStreak = stats.streak;
  addHistory(currentPuzzle?.rating || '?', true);
  updateStats();

  const overlay = document.getElementById('feedbackOverlay');
  overlay.className = 'feedback-overlay show success';
  document.getElementById('feedbackIcon').textContent = hintUsed ? '‚úì' : '‚≠ê';
  document.getElementById('feedbackTitle').textContent = hintUsed ? 'Solved with hint!' : 'Brilliant! Puzzle solved!';
  document.getElementById('feedbackDesc').textContent = hintUsed
    ? 'You found the right idea. Try the next one without a hint!'
    : 'You found the best move. Keep going ‚Äî your tactics are improving!';
}

function onPuzzleFailed(from, to) {
  setTimeout(enterReviewMode, 900);
  puzzleFailed = true;
  stats.failed++;
  stats.streak = 0;
  addHistory(currentPuzzle?.rating || '?', false);
  updateStats();

  const overlay = document.getElementById('feedbackOverlay');
  overlay.className = 'feedback-overlay show fail';
  document.getElementById('feedbackIcon').textContent = '‚úó';
  document.getElementById('feedbackTitle').textContent = 'Not the best move';
  const expected = solutionMoves[solutionIndex];
  const solFrom = expected.slice(0,2).toUpperCase();
  const solTo = expected.slice(2,4).toUpperCase();
  document.getElementById('feedbackDesc').textContent = `The right move was ${solFrom}‚Üí${solTo}. Click "Next Puzzle" to try a fresh one, or study the position.`;
}

function updateReviewBtns() {
  const back = document.getElementById('reviewBackBtn');
  const fwd  = document.getElementById('reviewFwdBtn');
  const lbl  = document.getElementById('reviewLabel');
  if (!back) return;
  back.disabled = !(reviewMode && reviewIndex > 0);
  back.style.opacity = (reviewMode && reviewIndex > 0) ? '1' : '0.35';
  fwd.disabled  = !(reviewMode && reviewIndex < reviewMoves.length);
  fwd.style.opacity  = (reviewMode && reviewIndex < reviewMoves.length) ? '1' : '0.35';
  lbl.textContent = reviewMode ? `Move ${reviewIndex} / ${reviewMoves.length}` : 'Review moves';
}
function enterReviewMode() {
  reviewMoves = game.history({ verbose: true });
  reviewIndex = reviewMoves.length;
  reviewMode = true;
  updateReviewBtns();
}
function reviewBack() {
  if (!reviewMode || reviewIndex <= 0) return;
  reviewIndex--;
  const g = new Chess(currentPuzzle.fen);
  const su = currentPuzzle.moves.split(' ')[0];
  g.move({ from:su.slice(0,2), to:su.slice(2,4), promotion:su[4]||'q' });
  reviewMoves.slice(0, reviewIndex).forEach(m => g.move(m.san));
  game = g; renderBoard(); updateReviewBtns();
}
function reviewForward() {
  if (!reviewMode || reviewIndex >= reviewMoves.length) return;
  game.move(reviewMoves[reviewIndex].san);
  reviewIndex++; renderBoard(); updateReviewBtns();
}
function restartPuzzle() {
  if (!currentPuzzle) return;
  reviewMode = false; reviewMoves = []; reviewIndex = 0;
  updateReviewBtns();
  setupPuzzle({ puzzle: currentPuzzle });
}
function showAnswer() {
  if (puzzleSolved || puzzleFailed) return;
  puzzleFailed = true;
  addHistory(currentPuzzle.rating, false);
  let idx = solutionIndex;
  function step() {
    if (idx >= solutionMoves.length) {
      document.getElementById('toMoveText').textContent = 'üëÅ Answer shown ‚Äî use ‚Üê ‚Üí to review';
      enterReviewMode(); return;
    }
    const uci = solutionMoves[idx];
    game.move({ from:uci.slice(0,2), to:uci.slice(2,4), promotion:uci[4]||'q' });
    renderBoard(); idx++; setTimeout(step, 650);
  }
  step();
}
function showHint() {
  if (puzzleSolved || puzzleFailed || solutionIndex >= solutionMoves.length) return;
  hintUsed = true;
  const expected = solutionMoves[solutionIndex];
  const hintFrom = expected.slice(0,2);
  const hintEl = document.querySelector(`[data-sq="${hintFrom}"]`);
  if (hintEl) {
    hintEl.classList.add('hint');
    setTimeout(() => hintEl.classList.remove('hint'), 1500);
  }
  selectedSquare = hintFrom;
  renderBoard();
}

function skipPuzzle() {
  stats.failed++;
  stats.streak = 0;
  addHistory(currentPuzzle?.rating || '?', false);
  updateStats();
  loadNextPuzzle();
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function updateStats() {
  document.getElementById('statSolved').textContent = stats.solved;
  document.getElementById('statFailed').textContent = stats.failed;
  document.getElementById('statStreak').textContent = stats.streak + ' üî•';
  document.getElementById('statBestStreak').textContent = stats.bestStreak;
  document.getElementById('streakBadge').textContent = 'üî• ' + stats.streak + ' Streak';
  const total = stats.solved + stats.failed;
  const acc = total > 0 ? Math.round(stats.solved / total * 100) + '%' : '‚Äî';
  document.getElementById('statAccuracy').textContent = acc;
}

function addHistory(rating, won) {
  stats.history.unshift({ rating, won });
  if (stats.history.length > 8) stats.history.pop();
  const list = document.getElementById('historyList');
  list.innerHTML = stats.history.map(h => `
    <div class="history-item">
      <div class="history-dot ${h.won ? 'win' : 'loss'}"></div>
      <div class="history-info">${h.won ? 'Solved' : 'Failed'}</div>
      <div class="history-rating">${h.rating}</div>
    </div>`).join('');
}

function showError(err) {
  document.getElementById('puzzle-board').innerHTML = `
    <div class="error-state">
      <div class="error-icon">‚ö†Ô∏è</div>
      <div class="error-title">Couldn't load puzzle</div>
      <div class="error-desc">The Lichess API is unreachable. Check your internet connection and try again.<br><br>Error: ${err.message}</div>
    </div>`;
  document.getElementById('toMoveText').textContent = 'Connection error';
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadNextPuzzle();
updateStats();
</script>
</body>
</html>
