<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malachi AI ‚Äî Puzzle Trainer</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <style>
    :root {
      --black:  #0a0a0a;
      --dark:   #111111;
      --panel:  #161616;
      --panel2: #1c1c1c;
      --border: #2a2a2a;
      --gold:   #c9a84c;
      --gold2:  #e8c97a;
      --cream:  #f5f0e8;
      --muted:  #6b6b6b;
      --white:  #ffffff;
      --green:  #4caf50;
      --red:    #e05068;
      --blue:   #5b8dee;
      --purple: #9c6fe4;
      --orange: #f0924a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body { background: var(--black); color: var(--cream); font-family: 'Outfit', sans-serif; overflow-x: hidden; min-height: 100vh; }
    .cursor { position:fixed; width:10px; height:10px; background:var(--gold); border-radius:50%; pointer-events:none; z-index:9999; transform:translate(-50%,-50%); mix-blend-mode:difference; }
    .cursor-ring { position:fixed; width:32px; height:32px; border:1px solid var(--gold); border-radius:50%; pointer-events:none; z-index:9998; transform:translate(-50%,-50%); opacity:0.4; transition:left 0.12s ease-out,top 0.12s ease-out; }
    .chess-bg { position:fixed; inset:0; z-index:0; opacity:0.025; background-image:repeating-conic-gradient(var(--gold) 0% 25%, transparent 0% 50%); background-size:48px 48px; pointer-events:none; }

    /* NAV */
    nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:18px 40px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.96); backdrop-filter:blur(12px); }
    .logo { display:flex; align-items:center; gap:12px; text-decoration:none; }
    .logo-icon { display:grid; grid-template-columns:1fr 1fr; gap:2px; width:18px; height:18px; }
    .logo-icon span { background:var(--gold); border-radius:1px; display:block; }
    .logo-icon span:nth-child(2),.logo-icon span:nth-child(3) { background:transparent; border:1px solid var(--gold); }
    .logo-text { font-family:'DM Mono',monospace; font-size:13px; letter-spacing:0.1em; color:var(--cream); }
    .logo-text span { color:var(--gold); }
    .nav-right { display:flex; align-items:center; gap:16px; }
    .nav-link { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); text-decoration:none; padding:8px 14px; border:1px solid transparent; transition:all 0.2s; }
    .nav-link:hover, .nav-link.active { color:var(--gold); border-color:var(--border); }
    .streak-badge { font-family:'DM Mono',monospace; font-size:11px; color:var(--orange); background:rgba(240,146,74,0.1); border:1px solid rgba(240,146,74,0.3); padding:6px 12px; letter-spacing:0.08em; }

    /* MAIN LAYOUT */
    .main { position:relative; z-index:1; display:grid; grid-template-columns: 280px 1fr 300px; gap:0; min-height: calc(100vh - 65px); }

    /* LEFT SIDEBAR ‚Äî filters */
    .sidebar-left { background:var(--panel); border-right:1px solid var(--border); padding:24px 0; overflow-y:auto; }
    .sidebar-section { padding:0 20px 20px; }
    .sidebar-title { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.2em; color:var(--muted); text-transform:uppercase; margin-bottom:12px; padding-top:20px; border-top:1px solid var(--border); }
    .sidebar-title:first-child { border-top:none; padding-top:0; }
    .filter-btn { width:100%; text-align:left; background:none; border:1px solid transparent; color:var(--muted); font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.06em; padding:9px 12px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:space-between; margin-bottom:3px; }
    .filter-btn:hover { color:var(--cream); border-color:var(--border); }
    .filter-btn.active { color:var(--gold); background:rgba(201,168,76,0.08); border-color:rgba(201,168,76,0.3); }
    .filter-count { font-size:9px; color:var(--muted); }

    .rating-range { padding:0 4px; }
    .rating-label { display:flex; justify-content:space-between; font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); margin-bottom:8px; }
    input[type=range] { width:100%; accent-color:var(--gold); }

    /* CENTER ‚Äî board */
    .board-area { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:32px 24px; gap:20px; }
    .puzzle-header { width:100%; max-width:520px; display:flex; align-items:center; justify-content:space-between; }
    .puzzle-title { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.15em; color:var(--muted); text-transform:uppercase; }
    .puzzle-rating-badge { font-family:'DM Mono',monospace; font-size:11px; color:var(--gold); background:rgba(201,168,76,0.1); border:1px solid rgba(201,168,76,0.2); padding:5px 12px; }

    .board-wrap { position:relative; }
    #puzzle-board { display:grid; grid-template-columns:repeat(8,1fr); width:480px; height:480px; border:2px solid var(--border); box-shadow:0 0 40px rgba(0,0,0,0.6); }
    .sq { width:60px; height:60px; display:flex; align-items:center; justify-content:center; position:relative; cursor:pointer; transition:background 0.1s; }
    .sq.light { background:#2a2a2a; }
    .sq.dark  { background:#1a1a1a; }
    .sq.selected { background:rgba(201,168,76,0.4) !important; }
    .sq.hint    { background:rgba(91,141,238,0.35) !important; }
    .sq.correct { background:rgba(76,175,80,0.45) !important; }
    .sq.wrong   { background:rgba(224,80,104,0.45) !important; }
    .sq.last-from { background:rgba(201,168,76,0.2) !important; }
    .sq.last-to   { background:rgba(201,168,76,0.3) !important; }
    .piece { font-size:38px; line-height:1; user-select:none; pointer-events:none; filter:drop-shadow(0 2px 3px rgba(0,0,0,0.5)); }
    .sq-label { position:absolute; bottom:2px; right:3px; font-size:8px; font-family:'DM Mono',monospace; color:rgba(255,255,255,0.2); pointer-events:none; }
    .sq-label-rank { position:absolute; top:2px; left:3px; font-size:8px; font-family:'DM Mono',monospace; color:rgba(255,255,255,0.2); pointer-events:none; }
    .move-dot { position:absolute; width:18px; height:18px; background:rgba(201,168,76,0.55); border-radius:50%; pointer-events:none; }
    .capture-ring { position:absolute; inset:3px; border:3px solid rgba(201,168,76,0.55); border-radius:50%; pointer-events:none; }

    .to-move-bar { width:480px; display:flex; align-items:center; gap:12px; font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); letter-spacing:0.08em; }
    .to-move-dot { width:12px; height:12px; border-radius:50%; border:2px solid var(--border); }
    .to-move-dot.white { background:#f0f0f0; }
    .to-move-dot.black { background:#2a2a2a; border-color:#666; }

    .puzzle-controls { width:480px; display:flex; gap:10px; }
    .ctrl-btn { flex:1; padding:11px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; text-transform:uppercase; border:1px solid var(--border); background:var(--panel); color:var(--muted); cursor:pointer; transition:all 0.2s; }
    .ctrl-btn:hover { color:var(--cream); border-color:var(--muted); }
    .ctrl-btn.primary { border-color:rgba(201,168,76,0.4); color:var(--gold); background:rgba(201,168,76,0.06); }
    .ctrl-btn.primary:hover { background:rgba(201,168,76,0.12); }

    /* FEEDBACK OVERLAY */
    .feedback-overlay { width:480px; padding:16px 20px; display:none; align-items:center; gap:14px; border:1px solid var(--border); }
    .feedback-overlay.show { display:flex; }
    .feedback-overlay.success { border-color:rgba(76,175,80,0.4); background:rgba(76,175,80,0.07); }
    .feedback-overlay.fail    { border-color:rgba(224,80,104,0.4); background:rgba(224,80,104,0.07); }
    .feedback-icon { font-size:24px; }
    .feedback-text { flex:1; }
    .feedback-title { font-weight:600; font-size:14px; margin-bottom:3px; }
    .feedback-overlay.success .feedback-title { color:var(--green); }
    .feedback-overlay.fail .feedback-title { color:var(--red); }
    .feedback-desc { font-size:12px; color:var(--muted); line-height:1.5; }

    /* RIGHT SIDEBAR ‚Äî stats + themes */
    .sidebar-right { background:var(--panel); border-left:1px solid var(--border); padding:24px 20px; overflow-y:auto; }
    .stat-row { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border); }
    .stat-row:last-child { border-bottom:none; }
    .stat-label { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.1em; color:var(--muted); text-transform:uppercase; }
    .stat-value { font-family:'DM Mono',monospace; font-size:16px; color:var(--gold); font-weight:600; }
    .stat-value.green { color:var(--green); }
    .stat-value.red { color:var(--red); }

    .themes-list { display:flex; flex-wrap:wrap; gap:6px; margin-top:12px; }
    .theme-tag { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:0.08em; padding:4px 9px; background:rgba(201,168,76,0.08); border:1px solid rgba(201,168,76,0.2); color:var(--gold); text-transform:uppercase; }
    .theme-tag.blue { background:rgba(91,141,238,0.08); border-color:rgba(91,141,238,0.2); color:var(--blue); }
    .theme-tag.purple { background:rgba(156,111,228,0.08); border-color:rgba(156,111,228,0.2); color:var(--purple); }
    .theme-tag.green { background:rgba(76,175,80,0.08); border-color:rgba(76,175,80,0.2); color:var(--green); }

    .history-item { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); }
    .history-item:last-child { border-bottom:none; }
    .history-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .history-dot.win { background:var(--green); }
    .history-dot.loss { background:var(--red); }
    .history-info { flex:1; font-size:11px; color:var(--muted); font-family:'DM Mono',monospace; }
    .history-rating { font-family:'DM Mono',monospace; font-size:11px; color:var(--gold); }

    /* LOADING */
    .loading-state { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; height:480px; width:480px; }
    .loading-chess { font-size:48px; animation:spin 2s linear infinite; }
    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
    .loading-text { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.15em; color:var(--muted); text-transform:uppercase; }

    /* ERROR STATE */
    .error-state { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; height:480px; width:480px; text-align:center; padding:40px; }
    .error-icon { font-size:48px; }
    .error-title { font-size:16px; font-weight:600; color:var(--cream); }
    .error-desc { font-size:12px; color:var(--muted); line-height:1.6; }

    .section-head { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.2em; color:var(--muted); text-transform:uppercase; margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid var(--border); }

    @media (max-width: 1100px) {
      .main { grid-template-columns: 220px 1fr; }
      .sidebar-right { display:none; }
    }
    @media (max-width: 800px) {
      .main { grid-template-columns: 1fr; }
      .sidebar-left { display:none; }
      #puzzle-board { width:360px; height:360px; }
      .sq { width:45px; height:45px; }
      .piece { font-size:28px; }
      .to-move-bar, .puzzle-controls, .feedback-overlay { width:360px; }
    }
  </style>
</head>
<body>
<div class="cursor" id="cursor"></div>
<div class="cursor-ring" id="cursorRing"></div>
<div class="chess-bg"></div>

<nav>
  <a href="index.html" class="logo">
    <div class="logo-icon"><span></span><span></span><span></span><span></span></div>
    <div class="logo-text">Malachi <span>AI</span></div>
  </a>
  <div class="nav-right">
    <a href="index.html" class="nav-link">Home</a>
    <a href="learn.html" class="nav-link">Learn</a>
    <a href="openings.html" class="nav-link">Openings</a>
    <a href="play.html" class="nav-link">Play</a>
    <a href="dashboard.html" class="nav-link">Dashboard</a>
    <div class="streak-badge" id="streakBadge">üî• 0 Streak</div>
  </div>
</nav>

<div class="main">
  <!-- LEFT SIDEBAR -->
  <div class="sidebar-left">
    <div class="sidebar-section">
      <div class="sidebar-title">Difficulty</div>
      <button class="filter-btn active" onclick="setThemeFilter('all')" id="filter-all">All Puzzles</button>
      <button class="filter-btn" onclick="setThemeFilter('mateIn1')" id="filter-mateIn1">‚ò† Mate in 1</button>
      <button class="filter-btn" onclick="setThemeFilter('mateIn2')" id="filter-mateIn2">‚ò† Mate in 2</button>
      <button class="filter-btn" onclick="setThemeFilter('mateIn3')" id="filter-mateIn3">‚ò† Mate in 3</button>
      <button class="filter-btn" onclick="setThemeFilter('fork')" id="filter-fork">‚ëÇ Forks</button>
      <button class="filter-btn" onclick="setThemeFilter('pin')" id="filter-pin">üìå Pins</button>
      <button class="filter-btn" onclick="setThemeFilter('skewer')" id="filter-skewer">‚ü∂ Skewers</button>
      <button class="filter-btn" onclick="setThemeFilter('discoveredAttack')" id="filter-discoveredAttack">Discovered Attack</button>
      <button class="filter-btn" onclick="setThemeFilter('backRankMate')" id="filter-backRankMate">Back Rank Mate</button>
      <button class="filter-btn" onclick="setThemeFilter('endgame')" id="filter-endgame">‚ôü Endgame</button>
      <button class="filter-btn" onclick="setThemeFilter('middlegame')" id="filter-middlegame">Middlegame</button>
      <button class="filter-btn" onclick="setThemeFilter('openingTactics')" id="filter-openingTactics">Opening Traps</button>
      <button class="filter-btn" onclick="setThemeFilter('sacrifice')" id="filter-sacrifice">‚ö° Sacrifices</button>
      <button class="filter-btn" onclick="setThemeFilter('crushing')" id="filter-crushing">üí• Crushing</button>
      <button class="filter-btn" onclick="setThemeFilter('advantage')" id="filter-advantage">Advantage</button>
      <button class="filter-btn" onclick="setThemeFilter('hangingPiece')" id="filter-hangingPiece">Hanging Piece</button>
      <button class="filter-btn" onclick="setThemeFilter('deflection')" id="filter-deflection">Deflection</button>
      <button class="filter-btn" onclick="setThemeFilter('attraction')" id="filter-attraction">Attraction</button>
      <button class="filter-btn" onclick="setThemeFilter('zugzwang')" id="filter-zugzwang">Zugzwang</button>
      <button class="filter-btn" onclick="setThemeFilter('promotion')" id="filter-promotion">Promotion</button>
      <button class="filter-btn" onclick="setThemeFilter('rookEndgame')" id="filter-rookEndgame">Rook Endgame</button>
      <button class="filter-btn" onclick="setThemeFilter('pawnEndgame')" id="filter-pawnEndgame">Pawn Endgame</button>
      <button class="filter-btn" onclick="setThemeFilter('long')" id="filter-long">Long Combo</button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Rating Range</div>
      <div class="rating-range">
        <div class="rating-label">
          <span>Min: <span id="ratingMinLabel">600</span></span>
          <span>Max: <span id="ratingMaxLabel">2400</span></span>
        </div>
        <input type="range" id="ratingMin" min="600" max="2400" step="100" value="600" oninput="updateRatingLabel()">
        <input type="range" id="ratingMax" min="600" max="2400" step="100" value="2400" oninput="updateRatingLabel()" style="margin-top:8px">
      </div>
    </div>
  </div>

  <!-- BOARD CENTER -->
  <div class="board-area">
    <div class="puzzle-header">
      <div class="puzzle-title" id="puzzleTitle">Tactics Trainer ‚Äî Powered by Lichess</div>
      <div class="puzzle-rating-badge" id="puzzleRatingBadge">Rating: ‚Äî</div>
    </div>

    <div class="board-wrap">
      <div id="puzzle-board">
        <div class="loading-state">
          <div class="loading-chess">‚ôü</div>
          <div class="loading-text">Loading puzzle...</div>
        </div>
      </div>
    </div>

    <div class="to-move-bar">
      <div class="to-move-dot" id="toMoveDot"></div>
      <span id="toMoveText">Loading...</span>
    </div>

    <div class="feedback-overlay" id="feedbackOverlay">
      <div class="feedback-icon" id="feedbackIcon"></div>
      <div class="feedback-text">
        <div class="feedback-title" id="feedbackTitle"></div>
        <div class="feedback-desc" id="feedbackDesc"></div>
      </div>
    </div>

    <div class="puzzle-controls">
      <button class="ctrl-btn" onclick="showHint()">üí° Hint</button>
      <button class="ctrl-btn" onclick="skipPuzzle()">‚è≠ Skip</button>
      <button class="ctrl-btn primary" onclick="loadNextPuzzle()">Next Puzzle ‚Üí</button>
    </div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="sidebar-right">
    <div class="section-head">Your Session</div>
    <div class="stat-row"><span class="stat-label">Solved</span><span class="stat-value green" id="statSolved">0</span></div>
    <div class="stat-row"><span class="stat-label">Failed</span><span class="stat-value red" id="statFailed">0</span></div>
    <div class="stat-row"><span class="stat-label">Streak</span><span class="stat-value" id="statStreak">0 üî•</span></div>
    <div class="stat-row"><span class="stat-label">Accuracy</span><span class="stat-value" id="statAccuracy">‚Äî</span></div>
    <div class="stat-row"><span class="stat-label">Best Streak</span><span class="stat-value" id="statBestStreak">0</span></div>

    <div class="section-head" style="margin-top:24px">Current Puzzle</div>
    <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:8px;letter-spacing:0.06em;">THEMES</div>
    <div class="themes-list" id="themesList"></div>

    <div class="section-head" style="margin-top:24px">Recent History</div>
    <div id="historyList"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ
const cursor = document.getElementById('cursor');
const ring = document.getElementById('cursorRing');
document.addEventListener('mousemove', e => {
  cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
  ring.style.left = e.clientX + 'px'; ring.style.top = e.clientY + 'px';
});

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let game = null;
let currentPuzzle = null;
let solutionMoves = [];
let solutionIndex = 0;
let selectedSquare = null;
let puzzleSolved = false;
let puzzleFailed = false;
let hintUsed = false;
let playerColor = 'w';

let stats = { solved: 0, failed: 0, streak: 0, bestStreak: 0, history: [] };
let currentThemeFilter = 'all';
let puzzleQueue = [];
let loadingNext = false;

const PIECE_UNICODE = {
  wK:'‚ôî', wQ:'‚ôï', wR:'‚ôñ', wB:'‚ôó', wN:'‚ôò', wP:'‚ôô',
  bK:'‚ôö', bQ:'‚ôõ', bR:'‚ôú', bB:'‚ôù', bN:'‚ôû', bP:'‚ôü'
};

const THEME_COLORS = {
  fork:'gold', pin:'blue', skewer:'purple', discoveredAttack:'blue',
  backRankMate:'red', mateIn1:'red', mateIn2:'red', mateIn3:'red',
  endgame:'green', openingTactics:'green', sacrifice:'purple', crushing:'gold',
  middlegame:'blue', long:'purple', hangingPiece:'green', deflection:'purple',
  attraction:'purple', zugzwang:'gold', promotion:'blue', rookEndgame:'green', pawnEndgame:'green'
};

function themeClass(t) { return THEME_COLORS[t] || ''; }

function prettyTheme(t) {
  return t.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase()).trim();
}

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
function setThemeFilter(theme) {
  currentThemeFilter = theme;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('filter-' + theme);
  if (btn) btn.classList.add('active');
  puzzleQueue = [];
  loadNextPuzzle();
}

function updateRatingLabel() {
  const min = parseInt(document.getElementById('ratingMin').value);
  const max = parseInt(document.getElementById('ratingMax').value);
  document.getElementById('ratingMinLabel').textContent = min;
  document.getElementById('ratingMaxLabel').textContent = max;
}

// ‚îÄ‚îÄ SUPABASE ENGINE ‚îÄ‚îÄ
const SB_URL = 'https://nlsmrveieqadjmytsmjm.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sc21ydmVpZXFhZGpteXRzbWptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTg4NjcsImV4cCI6MjA4NzI5NDg2N30.9uIWjPJsOhdXXHqGLIMcdY5eitbkGoHyhbreAEe-apM';

async function sbQuery(table, params) {
  const url = new URL(`${SB_URL}/rest/v1/${table}`);
  Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
  const res = await fetch(url.toString(), {
    headers: {
      'apikey': SB_KEY,
      'Authorization': 'Bearer ' + SB_KEY,
      'Accept': 'application/json'
    }
  });
  if (!res.ok) throw new Error('Supabase error: ' + res.status);
  return res.json();
}

async function sbCount(table, params) {
  const url = new URL(`${SB_URL}/rest/v1/${table}`);
  Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
  const res = await fetch(url.toString(), {
    headers: {
      'apikey': SB_KEY,
      'Authorization': 'Bearer ' + SB_KEY,
      'Prefer': 'count=exact',
      'Accept': 'application/json'
    }
  });
  const range = res.headers.get('content-range') || '0/0';
  return parseInt(range.split('/')[1]) || 0;
}

let puzzleQueue = [];

async function refillQueue() {
  const minR = parseInt(document.getElementById('ratingMin').value);
  const maxR = parseInt(document.getElementById('ratingMax').value);
  const baseUrl = `${SB_URL}/rest/v1/puzzles`;
  const headers = { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Accept': 'application/json' };

  // Step 1: get total count with a small request
  let countUrl = `${baseUrl}?select=id&rating=gte.${minR}&rating=lte.${maxR}&limit=1`;
  if (currentThemeFilter !== 'all') countUrl += `&themes=ilike.*${currentThemeFilter}*`;
  const countRes = await fetch(countUrl, { headers: { ...headers, 'Prefer': 'count=exact' } });
  const rangeHeader = countRes.headers.get('content-range') || '*/50000';
  const total = parseInt((rangeHeader.split('/')[1] || '50000')) || 50000;
  const offset = Math.floor(Math.random() * Math.max(0, total - 30));

  // Step 2: fetch a batch at random offset
  let fetchUrl = `${baseUrl}?select=id,fen,moves,rating,themes&rating=gte.${minR}&rating=lte.${maxR}&order=rating.asc&offset=${offset}&limit=30`;
  if (currentThemeFilter !== 'all') fetchUrl += `&themes=ilike.*${currentThemeFilter}*`;

  const res = await fetch(fetchUrl, { headers });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`DB error ${res.status}: ${txt}`);
  }
  const data = await res.json();
  if (!Array.isArray(data) || data.length === 0) {
    throw new Error('No puzzles found for this filter. Try a wider rating range or different theme.');
  }

  // Shuffle
  for (let i = data.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [data[i], data[j]] = [data[j], data[i]];
  }

  puzzleQueue = data.map(p => ({
    puzzle: {
      id: p.id,
      fen: p.fen,
      moves: p.moves,
      rating: p.rating,
      themes: (p.themes || '').split(' ').filter(Boolean)
    }
  }));
}

async function loadNextPuzzle() {
  puzzleSolved = false;
  puzzleFailed = false;
  hintUsed = false;
  selectedSquare = null;
  document.getElementById('feedbackOverlay').className = 'feedback-overlay';
  document.getElementById('themesList').innerHTML = '';
  document.getElementById('toMoveText').textContent = 'Loading...';
  document.getElementById('puzzleRatingBadge').textContent = 'Rating: ‚Äî';

  try {
    if (puzzleQueue.length === 0) await refillQueue();
    const data = puzzleQueue.shift();
    currentPuzzle = data.puzzle;
    setupPuzzle(data);
  } catch(e) {
    showError(e);
  }
}

function setThemeFilter(theme) {
  currentThemeFilter = theme;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('filter-' + theme);
  if (btn) btn.classList.add('active');
  puzzleQueue = [];
  loadNextPuzzle();
}

function showError(e) {
  console.error('Puzzle error:', e);
  document.getElementById('toMoveText').textContent = 'Error ‚Äî try again';
  document.getElementById('puzzle-board').innerHTML = `
    <div style="grid-column:1/-1;display:flex;flex-direction:column;align-items:center;justify-content:center;height:480px;gap:16px;padding:24px;text-align:center;">
      <div style="font-size:36px;opacity:0.4">‚ö†</div>
      <div style="font-family:'DM Mono',monospace;font-size:12px;color:#e05068;letter-spacing:0.1em">LOAD FAILED</div>
      <div style="font-size:11px;color:#6b6b6b;max-width:300px;line-height:1.6">${e.message || 'Could not load puzzle. Check connection.'}</div>
      <button onclick="loadNextPuzzle()" style="margin-top:8px;padding:10px 20px;background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.4);color:#c9a84c;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:0.1em">TRY AGAIN</button>
    </div>`;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
updateStats();
loadNextPuzzle();
</script>
</body>
</html>
