<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Malachi AI ‚Äî Play Chess</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <!-- Chess engine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --black:  #0a0a0a;
      --dark:   #111111;
      --panel:  #161616;
      --border: #2a2a2a;
      --gold:   #c9a84c;
      --gold2:  #e8c97a;
      --cream:  #f5f0e8;
      --muted:  #6b6b6b;
      --white:  #ffffff;
      --sq-light: #e8d5a3;
      --sq-dark:  #8b6914;
      --sq-sel:   rgba(201,168,76,0.6);
      --sq-move:  rgba(201,168,76,0.35);
      --sq-check: rgba(220,50,50,0.5);
    }
    html, body { height: 100%; }
    body {
      background: var(--black);
      color: var(--cream);
      font-family: 'Outfit', sans-serif;
      overflow-x: hidden;
      cursor: none;
      min-height: 100vh;
    }
    .cursor { position:fixed; width:10px; height:10px; background:var(--gold); border-radius:50%; pointer-events:none; z-index:9999; transform:translate(-50%,-50%); mix-blend-mode:difference; }
    .cursor-ring { position:fixed; width:32px; height:32px; border:1px solid var(--gold); border-radius:50%; pointer-events:none; z-index:9998; transform:translate(-50%,-50%); opacity:0.4; transition:left 0.1s ease-out, top 0.1s ease-out; }

    /* chess tile bg */
    .chess-bg { position:fixed; inset:0; z-index:0; opacity:0.025; background-image:repeating-conic-gradient(var(--gold) 0% 25%, transparent 0% 50%); background-size:48px 48px; pointer-events:none; }

    /* NAV */
    nav { position:relative; z-index:10; display:flex; align-items:center; justify-content:space-between; padding:20px 40px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.95); backdrop-filter:blur(12px); }
    .logo { display:flex; align-items:center; gap:10px; text-decoration:none; }
    .logo-icon { width:28px; height:28px; display:grid; grid-template-columns:1fr 1fr; gap:2px; }
    .logo-icon span { background:var(--gold); border-radius:1px; display:block; }
    .logo-icon span:nth-child(2), .logo-icon span:nth-child(3) { background:transparent; border:1px solid var(--gold); }
    .logo-text { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:700; color:var(--white); }
    .logo-text span { color:var(--gold); }
    .nav-right { display:flex; align-items:center; gap:20px; }
    .nav-back { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); text-decoration:none; transition:color 0.2s; }
    .nav-back:hover { color:var(--gold); }
    .diff-option { padding:12px 16px; cursor:pointer; border-bottom:1px solid #222; transition:background 0.15s; }
    .diff-option:hover { background:#252525; }
    .diff-option:last-child { border-bottom:none; }

    /* LAYOUT */
    .game-layout { position:relative; z-index:1; display:grid; grid-template-columns:200px 1fr 280px; gap:0; min-height:calc(100vh - 65px); }

    /* LEFT PANEL - captured pieces */
    .panel-left { background:var(--panel); border-right:1px solid var(--border); padding:28px 20px; display:flex; flex-direction:column; gap:24px; }
    .panel-title { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.2em; text-transform:uppercase; color:var(--gold); margin-bottom:4px; }
    .player-card { border:1px solid var(--border); padding:16px; transition:border-color 0.3s; }
    .player-card.active { border-color:var(--gold); background:rgba(201,168,76,0.05); }
    .player-name { font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:600; color:var(--white); margin-bottom:4px; }
    .player-color { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.1em; color:var(--muted); }
    .captured { display:flex; flex-wrap:wrap; gap:2px; margin-top:8px; min-height:24px; font-size:16px; }
    .material-score { font-family:'DM Mono',monospace; font-size:11px; color:var(--gold); margin-top:4px; }

    .turn-indicator { text-align:center; }
    .turn-dot { width:10px; height:10px; border-radius:50%; margin:0 auto 8px; background:var(--gold); animation:pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(201,168,76,0.4)} 50%{box-shadow:0 0 0 8px rgba(201,168,76,0)} }
    .turn-text { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.1em; color:var(--cream); }

    .game-controls { display:flex; flex-direction:column; gap:8px; margin-top:auto; }
    .btn-control { background:transparent; border:1px solid var(--border); color:var(--muted); font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.1em; text-transform:uppercase; padding:10px; cursor:none; transition:all 0.2s; text-align:center; }
    .btn-control:hover { border-color:var(--gold); color:var(--gold); }
    .btn-control.primary { background:var(--gold); border-color:var(--gold); color:var(--black); font-weight:500; }
    .btn-control.primary:hover { background:var(--gold2); }

    /* CENTER - board */
    .board-area { display:flex; align-items:center; justify-content:center; padding:40px; position:relative; }
    .board-wrapper { position:relative; }

    /* rank/file labels */
    .board-labels-files { display:flex; justify-content:space-around; padding:0 0 6px 32px; }
    .board-labels-ranks { position:absolute; left:0; top:32px; display:flex; flex-direction:column; height:calc(100% - 38px); justify-content:space-around; }
    .board-label { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); width:24px; text-align:center; }

    #chessboard {
      display:grid;
      grid-template-columns:repeat(8,1fr);
      width:min(560px, calc(100vw - 560px));
      height:min(560px, calc(100vw - 560px));
      border:2px solid var(--gold);
      box-shadow:0 0 60px rgba(201,168,76,0.15), 0 0 0 1px rgba(201,168,76,0.1);
      position:relative;
    }
    .square {
      aspect-ratio:1;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      cursor:none;
      transition:background 0.15s;
    }
    .square.light { background:var(--sq-light); }
    .square.dark  { background:var(--sq-dark); }
    .square.selected { background:var(--sq-sel) !important; }
    .square.possible-move::after { content:''; position:absolute; width:30%; height:30%; background:rgba(201,168,76,0.6); border-radius:50%; }
    .square.possible-capture { box-shadow:inset 0 0 0 4px rgba(201,168,76,0.7); }
    .square.in-check { background:var(--sq-check) !important; }
    .square.last-move { background:rgba(201,168,76,0.2) !important; }

    .piece {
      font-size:clamp(28px, 4vw, 44px);
      line-height:1;
      user-select:none;
      position:relative;
      z-index:2;
      transition:transform 0.1s;
      filter:drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    }
    .square:hover .piece { transform:scale(1.1); }
    .piece.white-piece { filter:drop-shadow(0 2px 6px rgba(0,0,0,0.6)) brightness(1.1); }
    .piece.black-piece { filter:drop-shadow(0 2px 6px rgba(0,0,0,0.8)); }

    /* AI thinking overlay */
    .thinking-overlay {
      position:absolute; inset:0;
      background:rgba(10,10,10,0.5);
      display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none;
      transition:opacity 0.3s;
      z-index:10;
      backdrop-filter:blur(2px);
    }
    .thinking-overlay.active { opacity:1; pointer-events:all; }
    .thinking-box { text-align:center; }
    .thinking-dots { display:flex; gap:8px; justify-content:center; margin-bottom:16px; }
    .thinking-dots span { width:10px; height:10px; background:var(--gold); border-radius:50%; animation:dot-bounce 1.2s ease-in-out infinite; }
    .thinking-dots span:nth-child(2) { animation-delay:0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay:0.4s; }
    @keyframes dot-bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-12px)} }
    .thinking-text { font-family:'DM Mono',monospace; font-size:12px; letter-spacing:0.15em; color:var(--gold); }

    /* RIGHT PANEL - move history + AI tips */
    .panel-right { background:var(--panel); border-left:1px solid var(--border); padding:28px 20px; display:flex; flex-direction:column; gap:24px; overflow:hidden; }

    .status-banner { padding:14px 16px; border-left:3px solid var(--gold); background:rgba(201,168,76,0.06); font-family:'DM Mono',monospace; font-size:12px; letter-spacing:0.05em; color:var(--cream); line-height:1.5; min-height:48px; }
    .status-banner.error { border-color:#e05; background:rgba(220,0,80,0.06); color:#ff6b8a; }
    .status-banner.win { border-color:#4caf50; background:rgba(76,175,80,0.08); color:#81c784; }

    .move-list { flex:1; overflow-y:auto; }
    .move-list::-webkit-scrollbar { width:4px; }
    .move-list::-webkit-scrollbar-track { background:transparent; }
    .move-list::-webkit-scrollbar-thumb { background:var(--border); }
    .moves-table { width:100%; border-collapse:collapse; }
    .moves-table td { padding:6px 8px; font-family:'DM Mono',monospace; font-size:12px; color:var(--muted); }
    .moves-table tr:hover td { background:rgba(201,168,76,0.05); color:var(--cream); }
    .moves-table .move-num { color:var(--border); width:32px; }
    .moves-table .white-move { color:var(--cream); }
    .moves-table .black-move { color:var(--muted); }
    .moves-table tr.latest td { background:rgba(201,168,76,0.08); }

    .ai-tip { border:1px solid var(--border); padding:16px; }
    .ai-tip-header { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
    .ai-tip-icon { font-size:18px; }
    .ai-tip-label { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.15em; text-transform:uppercase; color:var(--gold); }
    .ai-tip-text { font-size:13px; line-height:1.6; color:var(--muted); font-weight:300; }

    /* Game over modal */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1000; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.4s; backdrop-filter:blur(8px); }
    .modal-overlay.active { opacity:1; pointer-events:all; }
    .modal { background:var(--panel); border:1px solid var(--gold); padding:56px 48px; text-align:center; max-width:420px; animation:scaleIn 0.4s ease; }
    @keyframes scaleIn { from{transform:scale(0.9);opacity:0} to{transform:scale(1);opacity:1} }
    .modal-icon { font-size:64px; margin-bottom:20px; }
    .modal h2 { font-family:'Cormorant Garamond',serif; font-size:40px; font-weight:700; color:var(--white); margin-bottom:12px; }
    .modal p { font-size:15px; color:var(--muted); margin-bottom:36px; line-height:1.6; }
    .modal-actions { display:flex; gap:12px; justify-content:center; }


    /* ‚îÄ‚îÄ MODE SELECT SCREEN ‚îÄ‚îÄ */
    #modeScreen {
      position: fixed; inset: 0; z-index: 500;
      background: var(--black);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 0;
    }
    .mode-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(28px, 4vw, 48px);
      font-weight: 700; color: var(--white);
      letter-spacing: 0.04em; margin-bottom: 8px;
      text-align: center;
    }
    .mode-subtitle {
      font-family: 'DM Mono', monospace; font-size: 11px;
      letter-spacing: 0.2em; color: var(--muted);
      text-transform: uppercase; margin-bottom: 52px; text-align: center;
    }
    .mode-cards {
      display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;
      padding: 0 24px;
    }
    .mode-card {
      width: 280px; background: var(--panel);
      border: 1px solid var(--border);
      padding: 36px 28px; cursor: pointer;
      transition: all 0.25s; position: relative; overflow: hidden;
      text-align: center;
    }
    .mode-card::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(201,168,76,0.06) 0%, transparent 60%);
      opacity: 0; transition: opacity 0.25s;
    }
    .mode-card:hover { border-color: rgba(201,168,76,0.5); transform: translateY(-3px); box-shadow: 0 12px 40px rgba(0,0,0,0.5); }
    .mode-card:hover::before { opacity: 1; }
    .mode-card-icon { font-size: 48px; margin-bottom: 16px; display: block; }
    .mode-card-title { font-family: 'Cormorant Garamond', serif; font-size: 22px; font-weight: 700; color: var(--white); margin-bottom: 8px; }
    .mode-card-desc { font-size: 12px; color: var(--muted); line-height: 1.6; margin-bottom: 20px; }
    .mode-card-btn {
      display: inline-block;
      font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--gold);
      border: 1px solid rgba(201,168,76,0.35); padding: 9px 20px;
      transition: all 0.2s; background: rgba(201,168,76,0.05);
    }
    .mode-card:hover .mode-card-btn { background: rgba(201,168,76,0.15); border-color: var(--gold); }

    /* ‚îÄ‚îÄ LOBBY / MATCHMAKING SCREEN ‚îÄ‚îÄ */
    #lobbyScreen {
      position: fixed; inset: 0; z-index: 500;
      background: var(--black);
      display: none; flex-direction: column; align-items: center; justify-content: center;
      gap: 28px;
    }
    .lobby-title { font-family: 'Cormorant Garamond', serif; font-size: 32px; color: var(--white); font-weight: 700; }
    .lobby-box {
      background: var(--panel); border: 1px solid var(--border);
      padding: 40px 48px; text-align: center; width: 420px; max-width: 95vw;
    }
    .lobby-state-icon { font-size: 52px; margin-bottom: 16px; display: block;
      animation: lobbyPulse 2s ease-in-out infinite; }
    @keyframes lobbyPulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.08);opacity:0.8} }
    .lobby-status { font-family: 'DM Mono', monospace; font-size: 13px; letter-spacing: 0.08em; color: var(--cream); margin-bottom: 8px; }
    .lobby-substatus { font-size: 12px; color: var(--muted); line-height: 1.6; }
    .lobby-game-code {
      font-family: 'DM Mono', monospace; font-size: 28px; letter-spacing: 0.3em;
      color: var(--gold); border: 1px solid rgba(201,168,76,0.3);
      padding: 12px 24px; margin: 20px 0; display: inline-block;
      background: rgba(201,168,76,0.05);
    }
    .lobby-input {
      width: 100%; background: #0d0d0d; border: 1px solid var(--border);
      color: var(--cream); font-family: 'DM Mono', monospace;
      font-size: 22px; letter-spacing: 0.3em; text-align: center;
      padding: 14px; margin: 16px 0; text-transform: uppercase;
      outline: none; transition: border-color 0.2s;
    }
    .lobby-input:focus { border-color: rgba(201,168,76,0.5); }
    .lobby-input::placeholder { color: var(--muted); letter-spacing: 0.15em; font-size: 16px; }
    .lobby-tabs { display: flex; gap: 0; margin-bottom: 28px; border: 1px solid var(--border); }
    .lobby-tab {
      flex: 1; padding: 12px; font-family: 'DM Mono', monospace;
      font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase;
      background: none; border: none; color: var(--muted); cursor: pointer; transition: all 0.2s;
    }
    .lobby-tab.active { background: rgba(201,168,76,0.08); color: var(--gold); }
    .lobby-btn {
      width: 100%; padding: 14px; font-family: 'DM Mono', monospace;
      font-size: 12px; letter-spacing: 0.15em; text-transform: uppercase;
      background: var(--gold); color: #000; border: none; cursor: pointer;
      transition: all 0.2s; font-weight: 700; margin-top: 8px;
    }
    .lobby-btn:hover { background: var(--gold2); }
    .lobby-btn.secondary {
      background: none; color: var(--muted); border: 1px solid var(--border);
      margin-top: 12px;
    }
    .lobby-btn.secondary:hover { color: var(--cream); border-color: var(--muted); }
    .lobby-dots span {
      display: inline-block; width: 6px; height: 6px; border-radius: 50%;
      background: var(--gold); margin: 0 3px; opacity: 0.3;
      animation: dotBlink 1.4s ease-in-out infinite;
    }
    .lobby-dots span:nth-child(2) { animation-delay: 0.2s; }
    .lobby-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dotBlink { 0%,80%,100%{opacity:0.3} 40%{opacity:1} }
    .online-badge {
      display: inline-flex; align-items: center; gap: 6px;
      font-family: 'DM Mono', monospace; font-size: 10px;
      color: #4caf50; letter-spacing: 0.08em;
    }
    .online-badge::before { content:''; width:6px; height:6px; border-radius:50%; background:#4caf50; display:inline-block; animation: onlinePulse 2s infinite; }
    @keyframes onlinePulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .vs-divider {
      font-family: 'Cormorant Garamond', serif; font-size: 14px;
      color: var(--muted); text-align: center; margin: 16px 0;
      display: flex; align-items: center; gap: 12px;
    }
    .vs-divider::before, .vs-divider::after { content:''; flex:1; height:1px; background:var(--border); }

    @media (max-width:900px) {
      .game-layout { grid-template-columns:1fr; grid-template-rows:auto 1fr auto; }
      .panel-left { flex-direction:row; flex-wrap:wrap; padding:16px; gap:12px; }
      .panel-right { max-height:300px; }
      #chessboard { width:min(480px,95vw); height:min(480px,95vw); }
      nav { padding:16px 20px; }
    }

    /* Profile avatar nav widget */
    .profile-nav { display:flex; align-items:center; gap:10px; }
    .profile-avatar-btn { width:34px; height:34px; border-radius:50%; background:linear-gradient(135deg,#c9a84c,#8b6914); border:2px solid rgba(201,168,76,0.4); display:flex; align-items:center; justify-content:center; font-family:'DM Mono',monospace; font-size:12px; font-weight:700; color:#000; cursor:pointer; text-decoration:none; transition:all 0.2s; flex-shrink:0; }
    .profile-avatar-btn:hover { border-color:var(--gold,#c9a84c); transform:scale(1.08); }
    .profile-rating-pill { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.08em; color:#c9a84c; background:rgba(201,168,76,0.08); border:1px solid rgba(201,168,76,0.25); padding:4px 10px; white-space:nowrap; }
    .profile-signin { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; text-transform:uppercase; color:#c9a84c; text-decoration:none; border:1px solid rgba(201,168,76,0.3); padding:6px 14px; transition:all 0.2s; }
    .profile-signin:hover { background:rgba(201,168,76,0.08); }
  </style>
</head>
<body>

<div class="chess-bg"></div>
<div class="cursor" id="cursor"></div>
<div class="cursor-ring" id="cursorRing"></div>

<!-- NAV -->
<nav>
  <a href="index.html" class="logo">
    <div class="logo-icon"><span></span><span></span><span></span><span></span></div>
    <div class="logo-text">Malachi <span>AI</span></div>
  </a>
  <div class="nav-right">
    <a href="index.html" class="nav-back">Home</a>
    <a href="learn.html" class="nav-back">Learn</a>
    <a href="dashboard.html" class="nav-back">Dashboard</a>
    <a href="profile.html" class="nav-back" id="profileLink" style="display:none">My Profile</a>
    <div id="ratingBadge" style="display:none;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.08em;color:var(--gold);background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.25);padding:6px 12px;">
      ‚ôü <span id="ratingBadgeVal">‚Äî</span>
    </div>
    <div id="difficultyBtn" onclick="toggleDifficultyMenu()" style="cursor:pointer;display:flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--border);padding:8px 14px;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.08em;color:var(--cream);position:relative;">
      <span id="difficultyLabel">‚ö° NOVICE</span>
      <span style="color:var(--muted)">‚ñæ</span>
      <div id="difficultyMenu" style="display:none;position:absolute;top:100%;right:0;width:260px;background:#1a1a1a;border:1px solid var(--border);z-index:100;margin-top:4px;">
        <div class="diff-option" onclick="setDifficulty('novice')" data-level="novice">
          <div style="color:#4caf50;font-weight:bold">‚ö° NOVICE</div>
          <div style="color:var(--muted);font-size:10px;margin-top:3px">Makes mistakes. Great for beginners learning the basics.</div>
        </div>
        <div class="diff-option" onclick="setDifficulty('casual')" data-level="casual">
          <div style="color:#8bc34a;font-weight:bold">üå± CASUAL</div>
          <div style="color:var(--muted);font-size:10px;margin-top:3px">Plays reasonably but misses tactics sometimes.</div>
        </div>
        <div class="diff-option" onclick="setDifficulty('club')" data-level="club">
          <div style="color:#ffc107;font-weight:bold">‚ôü CLUB PLAYER</div>
          <div style="color:var(--muted);font-size:10px;margin-top:3px">Solid play. Knows openings and basic tactics.</div>
        </div>
        <div class="diff-option" onclick="setDifficulty('advanced')" data-level="advanced">
          <div style="color:#ff9800;font-weight:bold">üî• ADVANCED</div>
          <div style="color:var(--muted);font-size:10px;margin-top:3px">Plays strong chess. Will punish mistakes.</div>
        </div>
        <div class="diff-option" onclick="setDifficulty('master')" data-level="master">
          <div style="color:#f44336;font-weight:bold">üëë MASTER</div>
          <div style="color:var(--muted);font-size:10px;margin-top:3px">Near-perfect play. Extremely difficult to beat.</div>
        </div>
      </div>
    </div>
  </div>
</nav>


<!-- ‚ïê‚ïê‚ïê‚ïê MODE SELECT SCREEN ‚ïê‚ïê‚ïê‚ïê -->
<div id="modeScreen">
  <div class="mode-title">Malachi Chess</div>
  <div class="mode-subtitle">Choose your game</div>
  <div class="mode-cards">
    <div class="mode-card" onclick="selectMode('ai')">
      <span class="mode-card-icon">ü§ñ</span>
      <div class="mode-card-title">vs Malachi AI</div>
      <div class="mode-card-desc">Challenge our multilevel AI ‚Äî from friendly Novice to near-perfect Master. Great for training and learning.</div>
      <div class="mode-card-btn">Play vs AI ‚Üí</div>
    </div>
    <div class="mode-card" onclick="selectMode('online')">
      <span class="mode-card-icon">üåê</span>
      <div class="mode-card-title">Play Online</div>
      <div class="mode-card-desc">Challenge another player in real-time. Create a private game or join a friend with a game code.</div>
      <div class="mode-card-btn">Play Online ‚Üí</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê LOBBY SCREEN ‚ïê‚ïê‚ïê‚ïê -->
<div id="lobbyScreen">
  <div class="lobby-title">Online Play</div>
  <div class="lobby-box" id="lobbyBox">
    <!-- Lobby tabs -->
    <div class="lobby-tabs">
      <button class="lobby-tab active" id="tabCreate" onclick="switchLobbyTab('create')">Create Game</button>
      <button class="lobby-tab" id="tabJoin" onclick="switchLobbyTab('join')">Join Game</button>
    </div>

    <!-- CREATE tab content -->
    <div id="lobbyCreate">
      <div class="lobby-state-icon" id="createIcon">‚ôü</div>
      <div class="lobby-status" id="createStatus">Ready to create a game</div>
      <div class="lobby-substatus" id="createSubstatus">Click below to generate your game code and wait for an opponent.</div>
      <div class="lobby-game-code" id="gameCodeDisplay" style="display:none">----</div>
      <div class="online-badge" id="waitingBadge" style="display:none;margin:12px auto;justify-content:center">
        Waiting for opponent <span class="lobby-dots"><span></span><span></span><span></span></span>
      </div>
      <button class="lobby-btn" id="createBtn" onclick="createOnlineGame()">Generate Game Code</button>
    </div>

    <!-- JOIN tab content -->
    <div id="lobbyJoin" style="display:none">
      <div class="lobby-state-icon">üîó</div>
      <div class="lobby-status">Enter game code</div>
      <div class="lobby-substatus">Ask your friend for their 4-letter game code.</div>
      <input class="lobby-input" id="joinCodeInput" maxlength="4" placeholder="XXXX" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z]/g,'')"/>
      <button class="lobby-btn" onclick="joinOnlineGame()">Join Game</button>
    </div>

    <div class="vs-divider">or</div>
    <button class="lobby-btn secondary" onclick="backToModeSelect()">‚Üê Back to Mode Select</button>
  </div>
</div>


<!-- GAME LAYOUT -->
<div class="game-layout">

  <!-- LEFT -->
  <div class="panel-left">
    <div>
      <div class="panel-title">Players</div>
      <div class="player-card" id="aiCard">
        <div class="player-name" id="opponentName">Malachi AI</div>
        <div class="player-color" id="opponentColor">Black ‚ôü</div>
        <div class="captured" id="capturedByAI"></div>
        <div class="material-score" id="aiScore"></div>
      </div>
    </div>

    <div class="turn-indicator" id="turnIndicator">
      <div class="turn-dot"></div>
      <div class="turn-text">Your Turn</div>
    </div>

    <div>
      <div class="player-card active" id="playerCard">
        <div class="player-name" id="playerName">You</div>
        <div class="player-color" id="playerColorLabel">White ‚ôô</div>
        <div class="captured" id="capturedByPlayer"></div>
        <div class="material-score" id="playerScore"></div>
      </div>
    </div>

    <div class="game-controls">
      <button class="btn-control" onclick="undoMove()">‚Ü© Undo</button>
      <button class="btn-control" onclick="newGame()" id="newGameBtn">New Game</button>
      <button class="btn-control" onclick="goToMenu()" style="border-color:rgba(201,168,76,0.3);color:var(--gold)">‚äû Menu</button>
    </div>
  </div>

  <!-- CENTER BOARD -->
  <div class="board-area">
    <div class="board-wrapper">
      <div class="board-labels-files" id="fileLabels"></div>
      <div style="display:flex; gap:0;">
        <div class="board-labels-ranks" id="rankLabels"></div>
        <div style="position:relative;">
          <div id="chessboard"></div>
          <div class="thinking-overlay" id="thinkingOverlay">
            <div class="thinking-box">
              <div class="thinking-dots"><span></span><span></span><span></span></div>
              <div class="thinking-text">Malachi is thinking...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel-right">
    <div>
      <div class="panel-title">Status</div>
      <div class="status-banner" id="statusBanner">Make your first move to begin. You play as White.</div>
    </div>

    <div>
      <div class="panel-title">Move History</div>
      <div class="move-list">
        <table class="moves-table" id="movesTable"><tbody></tbody></table>
      </div>
    </div>

    <div class="ai-tip">
      <div class="ai-tip-header">
        <div class="ai-tip-icon">‚ôü</div>
        <div class="ai-tip-label">Malachi's Tip</div>
      </div>
      <div class="ai-tip-text" id="aiTipText">Control the center early ‚Äî e4 or d4 are strong opening moves for White.</div>
    </div>
  </div>
</div>

<!-- GAME OVER MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-icon" id="modalIcon">‚ôõ</div>
    <h2 id="modalTitle">Game Over</h2>
    <p id="modalMsg">Well played!</p>
    <div class="modal-actions">
      <button class="btn-control primary" onclick="newGame(); closeModal();" style="padding:14px 32px;">Play Again</button>
      <button class="btn-control" onclick="closeModal()" style="padding:14px 32px;">Review</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ
const cursor = document.getElementById('cursor');
const ring = document.getElementById('cursorRing');
document.addEventListener('mousemove', e => {
  cursor.style.left = e.clientX + 'px';
  cursor.style.top = e.clientY + 'px';
  setTimeout(() => { ring.style.left = e.clientX + 'px'; ring.style.top = e.clientY + 'px'; }, 80);
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME MODE & ONLINE MULTIPLAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gameMode = 'ai'; // 'ai' | 'online'
let onlineChannel = null;
let onlineGameCode = null;
let myColor = 'white'; // which color the local player controls
let onlineOpponentName = 'Opponent';
let currentUserName = 'You';
let isMyTurn = false;

// ‚îÄ‚îÄ Mode selection ‚îÄ‚îÄ
function selectMode(mode) {
  if (mode === 'ai') {
    gameMode = 'ai';
    document.getElementById('modeScreen').style.display = 'none';
    document.getElementById('opponentName').textContent = 'Malachi AI';
    document.getElementById('opponentColor').textContent = 'Black ‚ôü';
    document.getElementById('playerName').textContent = currentUserName || 'You';
    newGame();
  } else {
    document.getElementById('modeScreen').style.display = 'none';
    document.getElementById('lobbyScreen').style.display = 'flex';
  }
}

function backToModeSelect() {
  leaveOnlineGame();
  document.getElementById('lobbyScreen').style.display = 'none';
  document.getElementById('modeScreen').style.display = 'flex';
}

// ‚îÄ‚îÄ Lobby tabs ‚îÄ‚îÄ
function switchLobbyTab(tab) {
  document.getElementById('tabCreate').classList.toggle('active', tab==='create');
  document.getElementById('tabJoin').classList.toggle('active', tab==='join');
  document.getElementById('lobbyCreate').style.display = tab==='create' ? '' : 'none';
  document.getElementById('lobbyJoin').style.display = tab==='join' ? '' : 'none';
}

// ‚îÄ‚îÄ Generate random 4-letter game code ‚îÄ‚îÄ
function genCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
  return Array.from({length:4}, () => chars[Math.floor(Math.random()*chars.length)]).join('');
}

// ‚îÄ‚îÄ Create online game (HOST = White) ‚îÄ‚îÄ
async function createOnlineGame() {
  const code = genCode();
  onlineGameCode = code;
  myColor = 'white';
  gameMode = 'online';

  document.getElementById('gameCodeDisplay').textContent = code;
  document.getElementById('gameCodeDisplay').style.display = 'inline-block';
  document.getElementById('createBtn').style.display = 'none';
  document.getElementById('createStatus').textContent = 'Share this code with your friend';
  document.getElementById('createSubstatus').textContent = 'They enter the code on the Join tab. Game starts instantly when they join.';
  document.getElementById('waitingBadge').style.display = 'flex';
  document.getElementById('createIcon').textContent = '‚è≥';

  onlineChannel = sb.channel('malachi-game-' + code, {
    config: { broadcast: { self: false, ack: false } }
  });

  onlineChannel.on('broadcast', { event: 'join' }, async ({ payload }) => {
    console.log('[HOST] join received from', payload.name);
    onlineOpponentName = payload.name || 'Opponent';
    await onlineChannel.send({ type: 'broadcast', event: 'ready', payload: { name: currentUserName || 'Host' } });
    startOnlineGame('white');
  });

  onlineChannel.on('broadcast', { event: 'move' }, ({ payload }) => {
    console.log('[HOST] move received:', payload.move);
    receiveOnlineMove(payload.move);
  });

  onlineChannel.on('broadcast', { event: 'resign' }, () => handleOpponentResign());
  onlineChannel.on('broadcast', { event: 'ping' }, ({payload}) => {
    console.log('üèì [HOST] PING RECEIVED:', payload);
  });

  onlineChannel.subscribe((status, err) => {
    console.log('[HOST] channel status:', status, err || '');
    if (status === 'SUBSCRIBED') console.log('[HOST] ‚úÖ Ready to receive broadcasts on channel: malachi-game-' + onlineGameCode);
    if (status === 'CHANNEL_ERROR') console.error('[HOST] ‚ùå Channel error:', err);
  });
}

// ‚îÄ‚îÄ Join online game (JOINER = Black) ‚îÄ‚îÄ
async function joinOnlineGame() {
  const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if (code.length !== 4) {
    document.getElementById('joinCodeInput').style.borderColor = '#e74c3c';
    setTimeout(() => document.getElementById('joinCodeInput').style.borderColor = '', 1000);
    return;
  }

  onlineGameCode = code;
  myColor = 'black';
  gameMode = 'online';

  document.getElementById('lobbyJoin').innerHTML = `
    <div class="lobby-state-icon" style="animation:lobbyPulse 1s infinite">üîó</div>
    <div class="lobby-status">Connecting to game ${code}‚Ä¶</div>
    <div class="lobby-dots" style="margin-top:16px"><span></span><span></span><span></span></div>
    <button class="lobby-btn secondary" style="margin-top:24px" onclick="backToModeSelect()">‚Üê Cancel</button>
  `;

  onlineChannel = sb.channel('malachi-game-' + code, {
    config: { broadcast: { self: false, ack: false } }
  });

  onlineChannel.on('broadcast', { event: 'ready' }, ({ payload }) => {
    console.log('[JOINER] ready received from', payload.name);
    onlineOpponentName = payload.name || 'Opponent';
    startOnlineGame('black');
  });

  onlineChannel.on('broadcast', { event: 'move' }, ({ payload }) => {
    console.log('[JOINER] move received:', payload.move);
    receiveOnlineMove(payload.move);
  });

  onlineChannel.on('broadcast', { event: 'resign' }, () => handleOpponentResign());
  onlineChannel.on('broadcast', { event: 'ping' }, ({payload}) => {
    console.log('üèì [JOINER] PING RECEIVED:', payload);
  });

  onlineChannel.subscribe(async (status, err) => {
    console.log('[JOINER] channel status:', status, err || '');
    if (status === 'SUBSCRIBED') {
      console.log('[JOINER] ‚úÖ Subscribed ‚Äî sending join to channel: malachi-game-' + onlineGameCode);
      const res = await onlineChannel.send({
        type: 'broadcast', event: 'join',
        payload: { name: currentUserName || 'Player' }
      });
      console.log('[JOINER] join send result:', res);
    }
    if (status === 'CHANNEL_ERROR') console.error('[JOINER] ‚ùå Channel error:', err);
  });
}

// ‚îÄ‚îÄ Start the online game (called on both sides after handshake) ‚îÄ‚îÄ
function startOnlineGame(color) {
  myColor = color;
  isMyTurn = (color === 'white');

  document.getElementById('lobbyScreen').style.display = 'none';

  game = new Chess();
  selectedSquare = null;

  document.getElementById('playerName').textContent = currentUserName || 'You';
  document.getElementById('opponentName').textContent = onlineOpponentName;

  if (color === 'white') {
    document.getElementById('playerColorLabel').textContent = 'White ‚ôô';
    document.getElementById('opponentColor').textContent = 'Black ‚ôü';
  } else {
    document.getElementById('playerColorLabel').textContent = 'Black ‚ôü';
    document.getElementById('opponentColor').textContent = 'White ‚ôô';
  }

  document.querySelector('.thinking-text').textContent = onlineOpponentName + ' is thinking‚Ä¶';

  document.getElementById('statusBanner').textContent = color === 'white'
    ? '‚öîÔ∏è You play White ‚Äî make your move!'
    : '‚è≥ Waiting for White to move‚Ä¶';

  buildLabels();
  renderBoard();
  updatePanels();
  // Force overlay state on game start before updateOnlineTurnUI
  const overlay = document.getElementById('thinkingOverlay');
  if (!isMyTurn) {
    overlay.classList.add('active');
    overlay.style.display = '';
  } else {
    overlay.classList.remove('active');
    overlay.style.display = '';
  }
  updateOnlineTurnUI();
}

// ‚îÄ‚îÄ Receive a move from the opponent ‚îÄ‚îÄ
function receiveOnlineMove(uci) {
  console.log('[RECEIVE] applying move:', uci, 'current turn:', game.turn(), 'myColor:', myColor);
  const from = uci.slice(0,2), to = uci.slice(2,4), promo = uci[4];
  const move = game.move({ from, to, promotion: promo || 'q' });
  if (!move) { console.error('[RECEIVE] move failed:', uci); return; }

  console.log('[RECEIVE] move applied, new turn:', game.turn());
  SFX.play(move.captured ? 'capture' : 'move');
  renderBoard();
  addMoveToHistory(move, move.color);
  updatePanels();
  checkGameOver();
  updateOnlineTurnUI(); // derives myTurn from game.turn() ‚Äî no manual flag needed

  setTimeout(() => {
    const wrap = document.querySelector(`#chessboard [data-sq="${to}"] .piece-wrap`);
    if (wrap) { wrap.classList.add('bounce'); setTimeout(() => wrap.classList.remove('bounce'), 300); }
  }, 20);
}

// ‚îÄ‚îÄ Send our move to opponent ‚îÄ‚îÄ
async function sendOnlineMove(uci) {
  if (!onlineChannel) { console.error('[MOVE] no channel!'); return; }
  console.log('[MOVE] sending:', uci);
  const res = await onlineChannel.send({
    type: 'broadcast', event: 'move',
    payload: { move: uci }
  });
  console.log('[MOVE] send result:', res);
}

// ‚îÄ‚îÄ Update UI based on online turn ‚îÄ‚îÄ
function updateOnlineTurnUI() {
  // Derive turn from actual game state ‚Äî never trust manual isMyTurn tracking
  const gameTurn = game.turn(); // 'w' or 'b'
  const myTurn = (myColor === 'white' && gameTurn === 'w') || (myColor === 'black' && gameTurn === 'b');
  isMyTurn = myTurn; // sync the flag to match reality

  const overlay = document.getElementById('thinkingOverlay');
  const turnText = document.querySelector('.turn-text');
  const turnDot = document.querySelector('.turn-dot');

  overlay.style.display = ''; // clear any inline style
  if (myTurn) {
    overlay.classList.remove('active');
    if (turnText) turnText.textContent = 'Your Turn';
    if (turnDot) turnDot.style.background = 'var(--gold)';
    document.getElementById('statusBanner').textContent = '‚ôü Your turn to move';
    document.getElementById('playerCard').classList.add('active');
    document.getElementById('aiCard').classList.remove('active');
  } else {
    overlay.classList.add('active');
    if (turnText) turnText.textContent = "Opponent's Turn";
    if (turnDot) turnDot.style.background = 'var(--muted)';
    document.getElementById('statusBanner').textContent = '‚è≥ Waiting for ' + onlineOpponentName + '...';
    document.getElementById('aiCard').classList.add('active');
    document.getElementById('playerCard').classList.remove('active');
  }
  console.log('[TURN] myColor:', myColor, 'gameTurn:', gameTurn, 'myTurn:', myTurn);
}

// ‚îÄ‚îÄ Handle opponent resign ‚îÄ‚îÄ
function handleOpponentResign() {
  game = { isGameOver: () => false, turn: () => 'w' }; // prevent further moves
  showModal('üëë', onlineOpponentName + ' Resigned!', 'You win! Well played.', true);
}

// ‚îÄ‚îÄ Leave online game & cleanup ‚îÄ‚îÄ
function leaveOnlineGame() {
  if (onlineChannel) {
    onlineChannel.send({ type: 'broadcast', event: 'resign', payload: {} }).catch(()=>{});
    sb.removeChannel(onlineChannel);
    onlineChannel = null;
  }
  onlineGameCode = null;
  gameMode = 'ai';
  // Reset lobby UI
  document.getElementById('createBtn').style.display = '';
  document.getElementById('gameCodeDisplay').style.display = 'none';
  document.getElementById('waitingBadge').style.display = 'none';
  document.getElementById('createStatus').textContent = 'Ready to create a game';
  document.getElementById('createSubstatus').textContent = 'Click below to generate your game code and wait for an opponent.';
  document.getElementById('createIcon').textContent = '‚ôü';
  document.getElementById('joinCodeInput').value = '';
  switchLobbyTab('create');
  document.querySelector('.thinking-text').textContent = 'Malachi is thinking...';
}

// ‚îÄ‚îÄ CHESS ENGINE ‚îÄ‚îÄ
let game = new Chess();
let selectedSquare = null;

// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const SUPABASE_URL = 'https://nlsmrveieqadjmytsmjm.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sc21ydmVpZXFhZGpteXRzbWptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTg4NjcsImV4cCI6MjA4NzI5NDg2N30.9uIWjPJsOhdXXHqGLIMcdY5eitbkGoHyhbreAEe-apM';
const { createClient } = supabase.createClient ? supabase : window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, storageKey: 'malachi-auth' },
  realtime: {
    params: { eventsPerSecond: 10 }
  }
});

// ‚îÄ‚îÄ TRACKING ‚îÄ‚îÄ
let moveStartTime = Date.now();   // when player's turn started
let moveTimes = [];               // array of seconds per move
let gameStartTime = Date.now();   // when current game started
let gameAbandoned = false;        // did they quit mid-game?
let possibleMoves = [];
let lastMove = null;
// ‚îÄ‚îÄ DIFFICULTY SYSTEM ‚îÄ‚îÄ
const DIFFICULTY_LEVELS = {
  novice:   { depth: 1, mistakeRate: 0.5,  randomness: 150, thinkMin: 200,  thinkMax: 600,  label: '‚ö° NOVICE',      color: '#4caf50' },
  casual:   { depth: 1, mistakeRate: 0.25, randomness: 80,  thinkMin: 300,  thinkMax: 800,  label: 'üå± CASUAL',      color: '#8bc34a' },
  club:     { depth: 2, mistakeRate: 0.08, randomness: 30,  thinkMin: 400,  thinkMax: 1000, label: '‚ôü CLUB PLAYER',  color: '#ffc107' },
  advanced: { depth: 3, mistakeRate: 0.02, randomness: 10,  thinkMin: 600,  thinkMax: 1400, label: 'üî• ADVANCED',    color: '#ff9800' },
  master:   { depth: 4, mistakeRate: 0,    randomness: 2,   thinkMin: 800,  thinkMax: 2000, label: 'üëë MASTER',      color: '#f44336' },
};
let currentDifficulty = 'novice';
let depth = 1;
let moveHistory = [];

const PIECE_UNICODE = {
  wK:'‚ôî', wQ:'‚ôï', wR:'‚ôñ', wB:'‚ôó', wN:'‚ôò', wP:'‚ôô',
  bK:'‚ôö', bQ:'‚ôõ', bR:'‚ôú', bB:'‚ôù', bN:'‚ôû', bP:'‚ôü'
};
const PIECE_VALUES = { p:1, n:3, b:3, r:5, q:9, k:0 };

const TIPS = [
  "Control the center ‚Äî the four middle squares are the most powerful.",
  "Develop your knights before bishops ‚Äî they need more moves to reach good squares.",
  "Castle early to keep your king safe!",
  "Don't move the same piece twice in the opening without a good reason.",
  "Connect your rooks by clearing the back rank.",
  "A knight on the rim is dim ‚Äî keep knights toward the center.",
  "Trade pieces when you're ahead in material.",
  "Look for forks ‚Äî one piece attacking two at once.",
  "Passed pawns must be pushed!",
  "When you see a good move, look for a better one.",
  "Rooks belong on open files.",
  "Every move should have a purpose ‚Äî ask yourself why before you play.",
  "Think about what your opponent is threatening before you move.",
  "In the endgame, the king becomes a powerful fighting piece.",
];

function toggleDifficultyMenu() {
  const menu = document.getElementById('difficultyMenu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// Close menu when clicking outside
document.addEventListener('click', function(e) {
  if (!document.getElementById('difficultyBtn').contains(e.target)) {
    document.getElementById('difficultyMenu').style.display = 'none';
  }
});

function setDifficulty(level) {
  currentDifficulty = level;
  const cfg = DIFFICULTY_LEVELS[level];
  depth = cfg.depth;
  document.getElementById('difficultyLabel').textContent = cfg.label;
  document.getElementById('difficultyMenu').style.display = 'none';
  // Show toast
  const toast = document.createElement('div');
  toast.style.cssText = `position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#1a1a1a;border:1px solid ${cfg.color};color:${cfg.color};font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.08em;padding:10px 20px;z-index:999;pointer-events:none;`;
  toast.textContent = `Difficulty set to ${cfg.label}`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2000);
}

function buildLabels() {
  const files = document.getElementById('fileLabels');
  const ranks = document.getElementById('rankLabels');
  files.innerHTML = '';
  ranks.innerHTML = '';
  'abcdefgh'.split('').forEach(f => {
    const d = document.createElement('div');
    d.className = 'board-label';
    d.textContent = f;
    files.appendChild(d);
  });
  for (let r = 8; r >= 1; r--) {
    const d = document.createElement('div');
    d.className = 'board-label';
    d.textContent = r;
    ranks.appendChild(d);
  }
}

function renderBoard() {
  const board = document.getElementById('chessboard');
  board.innerHTML = '';
  const inCheck = game.in_check();
  let kingSquare = null;
  if (inCheck) {
    const color = game.turn();
    // find king
    'abcdefgh'.split('').forEach(f => {
      for (let r = 1; r <= 8; r++) {
        const sq = f + r;
        const p = game.get(sq);
        if (p && p.type === 'k' && p.color === color) kingSquare = sq;
      }
    });
  }

  for (let rank = 8; rank >= 1; rank--) {
    for (let fileIdx = 0; fileIdx < 8; fileIdx++) {
      const file = 'abcdefgh'[fileIdx];
      const sqName = file + rank;
      const piece = game.get(sqName);
      const isLight = (fileIdx + rank) % 2 !== 0;

      const sq = document.createElement('div');
      sq.className = 'square ' + (isLight ? 'light' : 'dark');
      sq.dataset.sq = sqName;

      if (sqName === selectedSquare) sq.classList.add('selected');
      if (possibleMoves.includes(sqName)) {
        if (piece && piece.color !== game.turn()) sq.classList.add('possible-capture');
        else sq.classList.add('possible-move');
      }
      if (lastMove && (sqName === lastMove.from || sqName === lastMove.to)) sq.classList.add('last-move');
      if (sqName === kingSquare) sq.classList.add('in-check');

      if (piece) {
        const p = document.createElement('div');
        p.className = 'piece ' + (piece.color === 'w' ? 'white-piece' : 'black-piece');
        p.textContent = PIECE_UNICODE[piece.color + piece.type.toUpperCase()];
        sq.appendChild(p);
      }

      sq.addEventListener('click', () => onSquareClick(sqName));
      board.appendChild(sq);
    }
  }
  updatePanels();
}

function onSquareClick(sq) {
  if (game.turn() !== 'w') return; // only player moves
  const piece = game.get(sq);

  if (selectedSquare) {
    if (possibleMoves.includes(sq)) {
      makePlayerMove(selectedSquare, sq);
      return;
    }
    if (piece && piece.color === 'w') {
      selectSquare(sq); return;
    }
    clearSelection();
    return;
  }
  if (piece && piece.color === 'w') { selectSquare(sq); }
}

function selectSquare(sq) {
  selectedSquare = sq;
  const moves = game.moves({ square: sq, verbose: true });
  possibleMoves = moves.map(m => m.to);
  renderBoard();
}

function clearSelection() {
  selectedSquare = null;
  possibleMoves = [];
  renderBoard();
}

function makePlayerMove(from, to) {
  // In online mode, block moves if it's not your turn or wrong color
  if (gameMode === 'online') {
    if (!isMyTurn) return;
    const pieceColor = game.get(from)?.color;
    if ((myColor === 'white' && pieceColor !== 'w') || (myColor === 'black' && pieceColor !== 'b')) return;
  }
  // Track how long player thought before moving
  const thinkTime = (Date.now() - moveStartTime) / 1000;
  moveTimes.push(Math.round(thinkTime));

  // handle promotion
  const piece = game.get(from);
  let promotion = 'q';
  const move = game.move({ from, to, promotion });
  if (!move) { clearSelection(); return; }

  lastMove = { from, to };
  clearSelection();
  addMoveToHistory(move, move.color);
  showTip();
  renderBoard();
  updatePanels();
  checkGameOver();

  if (gameMode === 'online') {
    const uci = move.from + move.to + (move.promotion || '');
    sendOnlineMove(uci);
    updateOnlineTurnUI(); // derives isMyTurn from game.turn() automatically
  } else {
    // vs AI ‚Äî trigger AI response
    if (!game.game_over()) setTimeout(aiMove, 400);
  }
}

function aiMove() {
  if (gameMode === 'online') return; // no AI in online mode
  const cfg = DIFFICULTY_LEVELS[currentDifficulty];
  document.getElementById('thinkingOverlay').classList.add('active');
  document.getElementById('aiCard').classList.add('active');
  document.getElementById('playerCard').classList.remove('active');
  document.getElementById('turnIndicator').querySelector('.turn-text').textContent = 'Malachi thinking...';

  const thinkTime = cfg.thinkMin + Math.random() * (cfg.thinkMax - cfg.thinkMin);

  setTimeout(() => {
    const best = getBestMove(cfg.depth, cfg.mistakeRate, cfg.randomness);
    if (best) {
      const move = game.move(best);
      lastMove = { from: move.from, to: move.to };
      addMoveToHistory(move, 'b');
    }
    document.getElementById('thinkingOverlay').classList.remove('active');
    document.getElementById('aiCard').classList.remove('active');
    document.getElementById('playerCard').classList.add('active');
    document.getElementById('turnIndicator').querySelector('.turn-text').textContent = 'Your Turn';
    renderBoard();
    checkGameOver();
    moveStartTime = Date.now();
  }, thinkTime);
}

// ‚îÄ‚îÄ MINIMAX AI ‚îÄ‚îÄ
function getBestMove(searchDepth, mistakeRate, randomness) {
  const moves = game.moves({ verbose: true });
  if (!moves.length) return null;

  // Mistake: just play a random move
  if (mistakeRate > 0 && Math.random() < mistakeRate) {
    return moves[Math.floor(Math.random() * moves.length)];
  }

  let best = null, bestVal = -Infinity;
  const scored = [];

  for (const move of moves) {
    game.move(move);
    const val = -minimax(searchDepth - 1, -Infinity, Infinity, false);
    game.undo();
    scored.push({ move, val });
    if (val > bestVal) { bestVal = val; best = move; }
  }

  // Randomness: sometimes pick from top N moves instead of always best
  if (randomness > 0) {
    scored.sort((a, b) => b.val - a.val);
    // Add noise to scores
    const noisy = scored.map(s => ({ move: s.move, val: s.val + (Math.random() - 0.5) * randomness }));
    noisy.sort((a, b) => b.val - a.val);
    best = noisy[0].move;
  }

  return best;
}

function minimax(d, alpha, beta, isMax) {
  if (d === 0 || game.game_over()) return evaluateBoard();
  const moves = game.moves({ verbose: true });
  if (isMax) {
    let maxEval = -Infinity;
    for (const m of moves) {
      game.move(m);
      maxEval = Math.max(maxEval, minimax(d-1, alpha, beta, false));
      game.undo();
      alpha = Math.max(alpha, maxEval);
      if (beta <= alpha) break;
    }
    return maxEval;
  } else {
    let minEval = Infinity;
    for (const m of moves) {
      game.move(m);
      minEval = Math.min(minEval, minimax(d-1, alpha, beta, true));
      game.undo();
      beta = Math.min(beta, minEval);
      if (beta <= alpha) break;
    }
    return minEval;
  }
}

function evaluateBoard() {
  if (game.in_checkmate()) return game.turn() === 'b' ? 10000 : -10000;
  if (game.in_draw()) return 0;
  let score = 0;
  const board = game.board();
  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const p = board[r][c];
      if (!p) continue;
      const val = PIECE_VALUES[p.type] * 100;
      score += p.color === 'b' ? val : -val;
    }
  }
  // small randomness for variety
  score += (Math.random() - 0.5) * 10;
  return score;
}

// ‚îÄ‚îÄ MOVE HISTORY ‚îÄ‚îÄ
function addMoveToHistory(move, color) {
  moveHistory.push({ move, color });
  const tbody = document.getElementById('movesTable').querySelector('tbody');
  if (color === 'w') {
    const moveNum = Math.ceil(moveHistory.length / 2);
    // remove latest class from previous
    tbody.querySelectorAll('tr').forEach(r => r.classList.remove('latest'));
    const tr = document.createElement('tr');
    tr.className = 'latest';
    tr.innerHTML = `<td class="move-num">${moveNum}.</td><td class="white-move">${move.san}</td><td class="black-move"></td>`;
    tr.id = 'move-row-' + moveNum;
    tbody.appendChild(tr);
  } else {
    const moveNum = Math.ceil(moveHistory.length / 2);
    const row = document.getElementById('move-row-' + moveNum);
    if (row) {
      tbody.querySelectorAll('tr').forEach(r => r.classList.remove('latest'));
      row.classList.add('latest');
      row.querySelector('.black-move').textContent = move.san;
    }
  }
  // scroll to bottom
  const ml = document.querySelector('.move-list');
  ml.scrollTop = ml.scrollHeight;
}

// ‚îÄ‚îÄ MATERIAL COUNT ‚îÄ‚îÄ
function updatePanels() {
  let wMat = 0, bMat = 0;
  let capturedByAI = [], capturedByPlayer = [];
  const board = game.board();
  const startCount = {p:8,n:2,b:2,r:2,q:1};
  const cur = {wp:0,wn:0,wb:0,wr:0,wq:0,bp:0,bn:0,bb:0,br:0,bq:0};
  for (let r=0;r<8;r++) for (let c=0;c<8;c++) {
    const p = board[r][c];
    if (p) cur[p.color+p.type]++;
  }
  const whiteLost = {
    p: Math.max(0, 8 - cur.wp), n: Math.max(0, 2 - cur.wn),
    b: Math.max(0, 2 - cur.wb), r: Math.max(0, 2 - cur.wr), q: Math.max(0, 1 - cur.wq)
  };
  const blackLost = {
    p: Math.max(0, 8 - cur.bp), n: Math.max(0, 2 - cur.bn),
    b: Math.max(0, 2 - cur.bb), r: Math.max(0, 2 - cur.br), q: Math.max(0, 1 - cur.bq)
  };
  const pIcons = {p:'‚ôü',n:'‚ôû',b:'‚ôù',r:'‚ôú',q:'‚ôõ'};
  const wIcons = {p:'‚ôô',n:'‚ôò',b:'‚ôó',r:'‚ôñ',q:'‚ôï'};

  let capByP = '', capByAI = '', wAdv = 0, bAdv = 0;
  for (const [type, count] of Object.entries(blackLost)) {
    for (let i=0;i<count;i++) capByP += pIcons[type];
    wAdv += PIECE_VALUES[type] * count;
  }
  for (const [type, count] of Object.entries(whiteLost)) {
    for (let i=0;i<count;i++) capByAI += wIcons[type];
    bAdv += PIECE_VALUES[type] * count;
  }
  document.getElementById('capturedByPlayer').textContent = capByP;
  document.getElementById('capturedByAI').textContent = capByAI;

  const diff = wAdv - bAdv;
  document.getElementById('playerScore').textContent = diff > 0 ? `+${diff}` : '';
  document.getElementById('aiScore').textContent = diff < 0 ? `+${Math.abs(diff)}` : '';

  // status
  const banner = document.getElementById('statusBanner');
  if (game.in_check()) {
    banner.textContent = '‚ö† Check! Your king is under attack.';
    banner.className = 'status-banner error';
  } else if (game.turn() === 'w') {
    banner.textContent = 'Your move. Think carefully before you commit.';
    banner.className = 'status-banner';
  } else {
    banner.textContent = 'Malachi AI is calculating the best response...';
    banner.className = 'status-banner';
  }
}

function checkGameOver() {
  if (!game.game_over()) return;
  setTimeout(async () => {
    const overlay = document.getElementById('modalOverlay');
    const icon = document.getElementById('modalIcon');
    const title = document.getElementById('modalTitle');
    const msg = document.getElementById('modalMsg');
    overlay.classList.add('active');

    let playerWon = false;
    if (game.in_checkmate()) {
      if (game.turn() === 'b') {
        icon.textContent = '‚ôî'; title.textContent = 'You Win!';
        msg.textContent = 'Excellent play! You checkmated Malachi AI. Want to try a harder difficulty?';
        playerWon = true;
      } else {
        icon.textContent = '‚ôö'; title.textContent = 'Checkmate';
        msg.textContent = "Malachi AI wins this round. Study the game and try again ‚Äî every loss is a lesson.";
      }
    } else if (game.in_draw()) {
      icon.textContent = 'ü§ù'; title.textContent = 'Draw!';
      msg.textContent = game.in_stalemate() ? 'Stalemate ‚Äî the game is a draw.' : 'The game ended in a draw.';
    }

    // Save game data to Supabase
    await saveGameData(playerWon, false);
  }, 500);
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

async function saveGameData(playerWon, abandoned, passedTimes, passedAvgTime) {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) return;

  const timesToUse = passedTimes || moveTimes;
  const avgMoveTime = passedAvgTime || (timesToUse.length > 0
    ? Math.round(timesToUse.reduce((a,b) => a+b, 0) / timesToUse.length)
    : 0);
  const gameDuration = Math.round((Date.now() - gameStartTime) / 1000);
  const totalMoves = timesToUse.length;

  const { data: prog } = await sb.from('progress').select('*').eq('user_id', session.user.id).single();
  if (!prog) return;

  const gamesPlayed = (prog.games_played || 0) + 1;
  const gamesWon = (prog.games_won || 0) + (playerWon ? 1 : 0);
  const behaviorData = prog.quiz_scores || {};
  const allMoveTimes = behaviorData.move_times || [];
  allMoveTimes.push(...timesToUse);
  const gameHistory = behaviorData.game_history || [];
  const gameDate = new Date().toISOString();

  // ‚îÄ‚îÄ ELO UPDATE (only for completed games, not abandoned) ‚îÄ‚îÄ
  let ratingChange = 0;
  let newRating = currentChessRating;
  if (!abandoned && totalMoves >= 4) {
    const aiElo = DIFFICULTY_ELO[currentDifficulty] || 1000;
    ratingChange = calcEloChange(currentChessRating, aiElo, playerWon);
    newRating = Math.max(100, currentChessRating + ratingChange);
    currentChessRating = newRating;

    // Update rating badge live
    const badge = document.getElementById('ratingBadgeVal');
    if (badge) {
      badge.textContent = newRating;
      badge.style.color = ratingChange >= 0 ? '#4caf50' : '#e05068';
      setTimeout(() => badge.style.color = 'var(--gold)', 3000);
    }

    // Update profiles table
    await sb.from('profiles').update({ chess_rating: newRating }).eq('id', session.user.id);

    // Show rating change in game modal
    const msgEl = document.getElementById('modalMessage');
    if (msgEl) {
      const sign = ratingChange >= 0 ? '+' : '';
      const existingRatingLine = msgEl.querySelector('.rating-line');
      if (!existingRatingLine) {
        const rLine = document.createElement('div');
        rLine.className = 'rating-line';
        rLine.style.cssText = 'font-family:"DM Mono",monospace;font-size:13px;margin-top:10px;';
        rLine.innerHTML = `Rating: <span style="color:var(--gold)">${newRating}</span> <span style="color:${ratingChange >= 0 ? '#4caf50' : '#e05068'}">(${sign}${ratingChange})</span>`;
        msgEl.appendChild(rLine);
      }
    }
  }

  gameHistory.push({
    date: gameDate,
    won: playerWon,
    abandoned,
    avgMoveTime,
    totalMoves,
    duration: gameDuration,
    difficulty: currentDifficulty
  });

  // Rating history for chart
  const ratingHistory = behaviorData.rating_history || [];
  if (!abandoned && totalMoves >= 4) {
    ratingHistory.push({ date: gameDate, rating: newRating, change: ratingChange, won: playerWon });
  }

  // Best streak tracking
  const bestStreak = Math.max(behaviorData.best_streak || 0,
    gameHistory.filter(g => !g.abandoned).reduce((streak, g, i, arr) => {
      if (!g.won) return Math.max(streak, 0);
      const run = arr.slice(0, i+1).reverse().findIndex(x => !x.won);
      return Math.max(streak, run === -1 ? i+1 : run);
    }, 0));

  await sb.from('progress').update({
    games_played: gamesPlayed,
    games_won: gamesWon,
    quiz_scores: {
      ...behaviorData,
      move_times: allMoveTimes.slice(-200),
      game_history: gameHistory.slice(-50),
      rating_history: ratingHistory.slice(-100),
      avg_move_time: Math.round(allMoveTimes.reduce((a,b)=>a+b,0) / allMoveTimes.length),
      completion_rate: Math.round((gameHistory.filter(g=>!g.abandoned).length / gameHistory.length) * 100),
      best_streak: bestStreak
    },
    updated_at: new Date().toISOString()
  }).eq('user_id', session.user.id);
}


function goToMenu() {
  if (gameMode === 'online') leaveOnlineGame();
  game = new Chess();
  selectedSquare = null;
  document.getElementById('modeScreen').style.display = 'flex';
}

function newGame() {
  if (gameMode === 'online') {
    if (confirm('Leave the current online game?')) {
      leaveOnlineGame();
      document.getElementById('modeScreen').style.display = 'flex';
    }
    return;
  }
  // Capture current times BEFORE resetting
  const timesToSave = [...moveTimes];
  const gameWasOver = game.game_over();

  // Save abandoned game if it had moves
  if (timesToSave.length > 0 && !gameWasOver) {
    const avgMoveTime = Math.round(timesToSave.reduce((a,b)=>a+b,0) / timesToSave.length);
    saveGameData(false, true, timesToSave, avgMoveTime);
  }

  // Reset tracking
  moveTimes = [];
  gameStartTime = Date.now();
  moveStartTime = Date.now();
  gameAbandoned = false;

  game = new Chess();
  selectedSquare = null; possibleMoves = []; lastMove = null; moveHistory = [];
  document.getElementById('movesTable').querySelector('tbody').innerHTML = '';
  document.getElementById('statusBanner').textContent = 'Make your first move to begin. You play as White.';
  document.getElementById('statusBanner').className = 'status-banner';
  document.getElementById('playerCard').classList.add('active');
  document.getElementById('aiCard').classList.remove('active');
  document.getElementById('turnIndicator').querySelector('.turn-text').textContent = 'Your Turn';
  showTip();
  renderBoard();
}

function undoMove() {
  // undo both player and AI move
  game.undo(); game.undo();
  // remove last row from history table
  const tbody = document.getElementById('movesTable').querySelector('tbody');
  if (tbody.lastChild) tbody.removeChild(tbody.lastChild);
  moveHistory = moveHistory.slice(0, -2);
  lastMove = null;
  clearSelection();
}

function showTip() {
  const tip = TIPS[Math.floor(Math.random() * TIPS.length)];
  document.getElementById('aiTipText').textContent = tip;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
buildLabels();
renderBoard();
showTip();

// ‚îÄ‚îÄ ELO RATING SYSTEM ‚îÄ‚îÄ
// AI difficulty maps to an approximate Elo equivalent
const DIFFICULTY_ELO = {
  novice: 600, casual: 900, club: 1200, advanced: 1500, master: 1900
};

function calcEloChange(playerRating, opponentRating, won) {
  const K = 32;
  const expected = 1 / (1 + Math.pow(10, (opponentRating - playerRating) / 400));
  const score = won ? 1 : 0;
  return Math.round(K * (score - expected));
}

let currentUserId = null;
let currentChessRating = 1200; // default starting rating

// Check login and load rating
(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUserId = session.user.id;
    const { data: profile } = await sb.from('profiles').select('username, role, chess_rating').eq('id', session.user.id).single();
    if (profile) {
      // Show profile link + rating badge
      document.getElementById('profileLink').style.display = 'inline';
      document.getElementById('ratingBadge').style.display = 'flex';
      currentChessRating = profile.chess_rating || 1200;
      document.getElementById('ratingBadgeVal').textContent = currentChessRating;

      // Add username + sign out to nav
      const nav = document.querySelector('.nav-right');
      const nameEl = document.createElement('span');
      nameEl.style.cssText = 'font-family:"DM Mono",monospace;font-size:11px;color:var(--cream);letter-spacing:0.08em;';
      nameEl.textContent = profile.username;
      nav.appendChild(nameEl);
      const signOutBtn = document.createElement('a');
      signOutBtn.href = '#';
      signOutBtn.style.cssText = 'font-family:"DM Mono",monospace;font-size:11px;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);text-decoration:none;transition:color 0.2s;';
      signOutBtn.textContent = 'Sign Out';
      signOutBtn.onmouseover = () => signOutBtn.style.color = 'var(--gold)';
      signOutBtn.onmouseout = () => signOutBtn.style.color = 'var(--muted)';
      signOutBtn.onclick = async (e) => { e.preventDefault(); await sb.auth.signOut(); window.location.href = 'login.html'; };
      nav.appendChild(signOutBtn);
    }
  } else {
    const nav = document.querySelector('.nav-right');
    const signInBtn = document.createElement('a');
    signInBtn.href = 'login.html';
    signInBtn.style.cssText = 'font-family:"DM Mono",monospace;font-size:11px;color:var(--gold);letter-spacing:0.1em;text-transform:uppercase;text-decoration:none;';
    signInBtn.textContent = 'Sign In';
    nav.appendChild(signInBtn);
  }
})();
</script>
<script>
// ‚îÄ‚îÄ PROFILE NAV WIDGET (injected on all pages) ‚îÄ‚îÄ
(function() {
  const SB_URL = 'https://nlsmrveieqadjmytsmjm.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sc21ydmVpZXFhZGpteXRzbWptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTg4NjcsImV4cCI6MjA4NzI5NDg2N30.9uIWjPJsOhdXXHqGLIMcdY5eitbkGoHyhbreAEe-apM';
  if (!window.supabase) return;
  const { createClient } = window.supabase;
  const _sb = createClient(SB_URL, SB_KEY, { auth: { persistSession:true, storageKey:'malachi-auth' } });

  async function injectProfileNav() {
    // Also grab the username for online play display
    try {
      const { data:{ session } } = await sb.auth.getSession();
      if (session) {
        const { data: prof } = await sb.from('progress').select('username').eq('user_id', session.user.id).single();
        if (prof?.username) currentUserName = prof.username;
        else currentUserName = session.user.email.split('@')[0];
        document.getElementById('playerName').textContent = currentUserName;
      }
    } catch(e) {}
    const { data: { session } } = await _sb.auth.getSession();
    // Find best nav container
    const container = document.querySelector('.nav-right') || document.querySelector('.nav-links') || document.querySelector('nav ul');
    if (!container) return;

    const widget = document.createElement('div');
    widget.className = 'profile-nav';

    if (session) {
      const { data: profile } = await _sb.from('profiles').select('username,chess_rating').eq('id', session.user.id).single();
      const initials = (profile?.username || '?').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
      const rating = profile?.chess_rating;

      if (rating) {
        const pill = document.createElement('div');
        pill.className = 'profile-rating-pill';
        pill.textContent = '‚ôü ' + rating;
        widget.appendChild(pill);
      }

      const avatar = document.createElement('a');
      avatar.href = 'profile.html';
      avatar.className = 'profile-avatar-btn';
      avatar.title = (profile?.username || '') + ' ‚Äî View Profile';
      avatar.textContent = initials;
      widget.appendChild(avatar);
    } else {
      const signin = document.createElement('a');
      signin.href = 'login.html';
      signin.className = 'profile-signin';
      signin.textContent = 'Sign In';
      widget.appendChild(signin);
    }

    container.appendChild(widget);
  }

  // Wait for DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', injectProfileNav);
  } else {
    injectProfileNav();
  }
})();

// ‚îÄ‚îÄ REALTIME DEBUG ‚Äî call testBroadcast() in console to verify channel works ‚îÄ‚îÄ
window.testBroadcast = async function() {
  if (!onlineChannel) { console.error('No channel ‚Äî join a game first'); return; }
  console.log('Channel state:', onlineChannel.state);
  const res = await onlineChannel.send({
    type: 'broadcast', event: 'ping', payload: { msg: 'hello from ' + (currentUserName||'?'), t: Date.now() }
  });
  console.log('Ping send result:', res);
};
onlineChannel && onlineChannel.on && onlineChannel.on('broadcast', { event: 'ping' }, ({payload}) => {
  console.log('üèì PING RECEIVED:', payload);
});

</script>
</body>
</html>
