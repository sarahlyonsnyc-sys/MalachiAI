<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malachi AI — Openings Explorer</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <style>
    :root {
      --black:#0a0a0a; --dark:#111111; --panel:#161616; --panel2:#1c1c1c;
      --border:#2a2a2a; --gold:#c9a84c; --gold2:#e8c97a; --cream:#f5f0e8;
      --muted:#6b6b6b; --green:#4caf50; --red:#e05068;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { background:var(--black); color:var(--cream); font-family:'Outfit',sans-serif; min-height:100vh; overflow-x:hidden; }
    .cursor { position:fixed; width:10px; height:10px; background:var(--gold); border-radius:50%; pointer-events:none; z-index:9999; transform:translate(-50%,-50%); mix-blend-mode:difference; }
    .cursor-ring { position:fixed; width:32px; height:32px; border:1px solid var(--gold); border-radius:50%; pointer-events:none; z-index:9998; transform:translate(-50%,-50%); opacity:0.4; transition:left .12s ease-out,top .12s ease-out; }
    .chess-bg { position:fixed; inset:0; z-index:0; opacity:.025; background-image:repeating-conic-gradient(var(--gold) 0% 25%,transparent 0% 50%); background-size:48px 48px; pointer-events:none; }

    /* NAV */
    nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:18px 40px; border-bottom:1px solid var(--border); background:rgba(10,10,10,.96); backdrop-filter:blur(12px); }
    .logo { display:flex; align-items:center; gap:12px; text-decoration:none; }
    .logo-icon { display:grid; grid-template-columns:1fr 1fr; gap:2px; width:18px; height:18px; }
    .logo-icon span { background:var(--gold); border-radius:1px; }
    .logo-icon span:nth-child(2),.logo-icon span:nth-child(3) { background:transparent; border:1px solid var(--gold); }
    .logo-text { font-family:'DM Mono',monospace; font-size:13px; letter-spacing:.1em; color:var(--cream); }
    .logo-text span { color:var(--gold); }
    .nav-right { display:flex; align-items:center; gap:16px; }
    .nav-link { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:.08em; text-transform:uppercase; color:var(--muted); text-decoration:none; padding:8px 14px; border:1px solid transparent; transition:all .2s; }
    .nav-link:hover,.nav-link.active { color:var(--gold); border-color:var(--border); }

    /* LAYOUT */
    .main { position:relative; z-index:1; display:grid; grid-template-columns:290px 1fr 280px; min-height:calc(100vh - 65px); }

    /* LEFT SIDEBAR */
    .sidebar-left { background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
    .search-wrap { padding:14px; border-bottom:1px solid var(--border); }
    .search-input { width:100%; background:var(--panel2); border:1px solid var(--border); color:var(--cream); font-family:'Outfit',sans-serif; font-size:13px; padding:9px 13px; outline:none; transition:border .2s; border-radius:0; }
    .search-input:focus { border-color:rgba(201,168,76,.5); }
    .search-input::placeholder { color:var(--muted); }
    .eco-tabs { display:flex; border-bottom:1px solid var(--border); background:var(--panel2); }
    .eco-tab { flex:1; padding:9px 4px; font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.1em; text-align:center; color:var(--muted); cursor:pointer; background:none; border:none; border-bottom:2px solid transparent; transition:all .15s; }
    .eco-tab:hover { color:var(--cream); }
    .eco-tab.active { color:var(--gold); border-bottom-color:var(--gold); }
    .list-meta { padding:8px 14px; font-family:'DM Mono',monospace; font-size:9px; color:var(--muted); letter-spacing:.1em; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; }
    .opening-list { flex:1; overflow-y:auto; }
    .opening-list::-webkit-scrollbar { width:3px; }
    .opening-list::-webkit-scrollbar-thumb { background:var(--border); }
    .opening-item { padding:9px 14px; cursor:pointer; border-bottom:1px solid rgba(42,42,42,.4); border-left:3px solid transparent; transition:all .12s; }
    .opening-item:hover { background:rgba(255,255,255,.02); }
    .opening-item.active { border-left-color:var(--gold); background:rgba(201,168,76,.05); }
    .opening-item-name { font-size:12px; color:var(--cream); line-height:1.4; margin-bottom:2px; }
    .opening-item-eco { font-family:'DM Mono',monospace; font-size:9px; color:var(--muted); }
    .list-status { padding:20px; text-align:center; font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); letter-spacing:.1em; }

    /* CENTER */
    .center { display:flex; flex-direction:column; align-items:center; padding:24px 16px; gap:14px; background:var(--dark); }
    .opening-header { width:100%; max-width:480px; }
    .opening-name-big { font-size:18px; font-weight:700; color:var(--cream); margin-bottom:6px; line-height:1.3; }
    .opening-badges { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; align-items:center; }
    .eco-badge { font-family:'DM Mono',monospace; font-size:10px; color:var(--gold); background:rgba(201,168,76,.1); border:1px solid rgba(201,168,76,.25); padding:3px 10px; letter-spacing:.1em; }
    .move-count-badge { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); background:var(--panel); border:1px solid var(--border); padding:3px 10px; letter-spacing:.06em; }
    .opening-pgn-text { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); line-height:1.8; }

    /* BOARD */
    #board-wrap { position:relative; }
    #board { display:grid; grid-template-columns:repeat(8,1fr); width:464px; height:464px; border:2px solid var(--border); box-shadow:0 8px 48px rgba(0,0,0,.6); }
    .sq { width:58px; height:58px; display:flex; align-items:center; justify-content:center; position:relative; }
    .sq.light { background:#222; }
    .sq.dark  { background:#181818; }
    .sq.hi-from { background:rgba(201,168,76,.18) !important; }
    .sq.hi-to   { background:rgba(201,168,76,.36) !important; }
    .piece { font-size:36px; line-height:1; user-select:none; filter:drop-shadow(0 2px 4px rgba(0,0,0,.6)); }
    .sq-file { position:absolute; bottom:2px; right:3px; font-size:7px; font-family:'DM Mono',monospace; color:rgba(255,255,255,.18); }
    .sq-rank { position:absolute; top:2px; left:3px; font-size:7px; font-family:'DM Mono',monospace; color:rgba(255,255,255,.18); }

    /* MOVE HISTORY */
    .move-history { width:464px; display:flex; flex-wrap:wrap; gap:3px; padding:10px 12px; background:var(--panel); border:1px solid var(--border); min-height:44px; align-items:center; }
    .mv-num { font-family:'DM Mono',monospace; font-size:9px; color:rgba(107,107,107,.6); margin-right:1px; }
    .mv-token { font-family:'DM Mono',monospace; font-size:11px; padding:3px 7px; background:var(--panel2); border:1px solid var(--border); color:var(--muted); cursor:pointer; transition:all .12s; border-radius:0; }
    .mv-token:hover { color:var(--cream); border-color:var(--muted); }
    .mv-token.active { color:var(--gold); border-color:rgba(201,168,76,.5); background:rgba(201,168,76,.08); }
    .mv-empty { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); }

    /* CONTROLS */
    .controls { display:flex; gap:6px; width:464px; }
    .ctrl { flex:1; padding:10px 6px; font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.08em; border:1px solid var(--border); background:var(--panel); color:var(--muted); cursor:pointer; transition:all .2s; text-transform:uppercase; }
    .ctrl:hover { color:var(--cream); border-color:rgba(255,255,255,.2); }
    .ctrl.gold { border-color:rgba(201,168,76,.4); color:var(--gold); background:rgba(201,168,76,.05); }
    .ctrl.gold:hover { background:rgba(201,168,76,.12); }

    /* PLACEHOLDER */
    .placeholder { width:464px; height:464px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; border:2px solid var(--border); background:var(--panel); }
    .placeholder-icon { font-size:72px; opacity:.2; }
    .placeholder-text { font-family:'DM Mono',monospace; font-size:11px; color:var(--muted); letter-spacing:.18em; text-align:center; line-height:1.8; }

    /* RIGHT SIDEBAR */
    .sidebar-right { background:var(--panel); border-left:1px solid var(--border); padding:18px; overflow-y:auto; }
    .sidebar-right::-webkit-scrollbar { width:3px; }
    .sidebar-right::-webkit-scrollbar-thumb { background:var(--border); }
    .section-head { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:.25em; color:var(--muted); text-transform:uppercase; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid var(--border); }
    .stat-row { display:flex; justify-content:space-between; align-items:center; padding:7px 0; border-bottom:1px solid rgba(42,42,42,.5); font-size:12px; }
    .stat-label { color:var(--muted); }
    .stat-val { font-family:'DM Mono',monospace; font-size:11px; color:var(--gold); }
    .related-item { padding:8px 10px; border:1px solid var(--border); margin-bottom:5px; cursor:pointer; transition:all .15s; }
    .related-item:hover { border-color:rgba(201,168,76,.35); background:rgba(201,168,76,.04); }
    .related-name { font-size:11px; color:var(--cream); margin-bottom:2px; }
    .related-pgn { font-family:'DM Mono',monospace; font-size:9px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    @media(max-width:1150px){ .main{grid-template-columns:260px 1fr;} .sidebar-right{display:none;} }
    @media(max-width:820px){ .main{grid-template-columns:1fr;} .sidebar-left{max-height:240px;} #board,.move-history,.controls{width:340px !important;} .sq{width:42.5px !important;height:42.5px !important;} .piece{font-size:26px !important;} }
  </style>
</head>
<body>
<div class="cursor" id="cur"></div>
<div class="cursor-ring" id="ring"></div>
<div class="chess-bg"></div>

<nav>
  <a href="index.html" class="logo">
    <div class="logo-icon"><span></span><span></span><span></span><span></span></div>
    <div class="logo-text">Malachi <span>AI</span></div>
  </a>
  <div class="nav-right">
    <a href="index.html" class="nav-link">Home</a>
    <a href="learn.html" class="nav-link">Learn</a>
    <a href="puzzles.html" class="nav-link">Puzzles</a>
    <a href="openings.html" class="nav-link active">Openings</a>
    <a href="play.html" class="nav-link">Play</a>
    <a href="dashboard.html" class="nav-link">Dashboard</a>
  </div>
</nav>

<div class="main">

  <!-- ── LEFT ── -->
  <div class="sidebar-left">
    <div class="search-wrap">
      <input class="search-input" id="searchInput" type="text" placeholder="Search openings..." oninput="onSearch()">
    </div>
    <div class="eco-tabs">
      <button class="eco-tab active" onclick="setEco('all')" id="tab-all">All</button>
      <button class="eco-tab" onclick="setEco('A')" id="tab-A">A</button>
      <button class="eco-tab" onclick="setEco('B')" id="tab-B">B</button>
      <button class="eco-tab" onclick="setEco('C')" id="tab-C">C</button>
      <button class="eco-tab" onclick="setEco('D')" id="tab-D">D</button>
      <button class="eco-tab" onclick="setEco('E')" id="tab-E">E</button>
    </div>
    <div class="list-meta">
      <span id="listCount">Loading...</span>
      <span id="totalCount"></span>
    </div>
    <div class="opening-list" id="openingList">
      <div class="list-status">Loading openings...</div>
    </div>
  </div>

  <!-- ── CENTER ── -->
  <div class="center">
    <div class="opening-header">
      <div class="opening-name-big" id="opName">Openings Explorer</div>
      <div class="opening-badges">
        <div class="eco-badge" id="opEco" style="display:none"></div>
        <div class="move-count-badge" id="opMoves" style="display:none"></div>
      </div>
      <div class="opening-pgn-text" id="opPgn">Search or select an opening from the list to explore its moves.</div>
    </div>

    <div id="boardWrap">
      <div class="placeholder">
        <div class="placeholder-icon">♟</div>
        <div class="placeholder-text">SELECT AN OPENING<br>TO BEGIN</div>
      </div>
    </div>

    <div class="move-history" id="moveHistory"><span class="mv-empty">No moves yet</span></div>

    <div class="controls">
      <button class="ctrl" onclick="goStart()">⏮</button>
      <button class="ctrl" onclick="prevMove()">← Back</button>
      <button class="ctrl" onclick="nextMove()">Forward →</button>
      <button class="ctrl gold" id="playBtn" onclick="togglePlay()">▶ Play All</button>
      <button class="ctrl" onclick="goEnd()">⏭</button>
    </div>
  </div>

  <!-- ── RIGHT ── -->
  <div class="sidebar-right">
    <div class="section-head">Details</div>
    <div id="detailsPanel"><div style="color:var(--muted);font-size:12px">Select an opening.</div></div>

    <div class="section-head" style="margin-top:20px">Related Variations</div>
    <div id="relatedPanel"><div style="color:var(--muted);font-size:12px">Related openings appear here.</div></div>
  </div>

</div>

<script>
// ── CURSOR ──
const cur=document.getElementById('cur'), ring=document.getElementById('ring');
document.addEventListener('mousemove',e=>{cur.style.left=e.clientX+'px';cur.style.top=e.clientY+'px';ring.style.left=e.clientX+'px';ring.style.top=e.clientY+'px';});

// ── SUPABASE ──
const SB_URL='https://nlsmrveieqadjmytsmjm.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sc21ydmVpZXFhZGpteXRzbWptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTg4NjcsImV4cCI6MjA4NzI5NDg2N30.9uIWjPJsOhdXXHqGLIMcdY5eitbkGoHyhbreAEe-apM';
const {createClient}=supabase;
const sb=createClient(SB_URL,SB_KEY);

// ── PIECES ──
const P={wK:'♔',wQ:'♕',wR:'♖',wB:'♗',wN:'♘',wP:'♙',bK:'♚',bQ:'♛',bR:'♜',bB:'♝',bN:'♞',bP:'♟'};

// ── FALLBACK (20 popular openings shown before Supabase loads) ──
const FALLBACK=[
  {eco:'C50',name:'Italian Game',pgn:'1. e4 e5 2. Nf3 Nc6 3. Bc4'},
  {eco:'C60',name:'Ruy López Opening',pgn:'1. e4 e5 2. Nf3 Nc6 3. Bb5'},
  {eco:'B20',name:'Sicilian Defense',pgn:'1. e4 c5'},
  {eco:'B90',name:'Sicilian Defense: Najdorf Variation',pgn:'1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 a6'},
  {eco:'B12',name:'Caro-Kann Defense',pgn:'1. e4 c6'},
  {eco:'C00',name:'French Defense',pgn:'1. e4 e6'},
  {eco:'D06',name:"Queen's Gambit",pgn:'1. d4 d5 2. c4'},
  {eco:'D10',name:'Slav Defense',pgn:'1. d4 d5 2. c4 c6'},
  {eco:'E60',name:"King's Indian Defense",pgn:'1. d4 Nf6 2. c4 g6'},
  {eco:'E00',name:'Nimzo-Indian Defense',pgn:'1. d4 Nf6 2. c4 e6 3. Nc3 Bb4'},
  {eco:'C44',name:'Scotch Game',pgn:'1. e4 e5 2. Nf3 Nc6 3. d4'},
  {eco:'C40',name:"King's Gambit",pgn:'1. e4 e5 2. f4'},
  {eco:'A10',name:'English Opening',pgn:'1. c4'},
  {eco:'B01',name:'Scandinavian Defense',pgn:'1. e4 d5'},
  {eco:'E20',name:'Catalan Opening',pgn:'1. d4 Nf6 2. c4 e6 3. g3'},
  {eco:'A41',name:'Grünfeld Defense',pgn:'1. d4 Nf6 2. c4 g6 3. Nc3 d5'},
  {eco:'C21',name:'Danish Gambit',pgn:'1. e4 e5 2. d4 exd4 3. c3'},
  {eco:'B06',name:'Modern Defense',pgn:'1. e4 g6'},
  {eco:'A07',name:"King's Indian Attack",pgn:'1. Nf3 d5 2. g3'},
  {eco:'D30',name:'Budapest Gambit',pgn:'1. d4 Nf6 2. c4 e5'},
];

// ── STATE ──
let allOpenings=[], currentIdx=-1, allMoves=[], dispIdx=0, playTimer=null, ecoFilter='all', searchTimer=null;

// ── SUPABASE QUERIES ──
async function fetchOpenings(search='', eco='all'){
  try {
    let q=sb.from('openings').select('eco,name,pgn').order('eco').order('name').limit(300);
    if(eco!=='all') q=q.like('eco',`${eco}%`);
    if(search) q=q.ilike('name',`%${search}%`);
    const {data,error}=await q;
    if(error||!data||data.length===0) throw new Error('empty');
    return data;
  } catch(e){
    let res=[...FALLBACK];
    if(eco!=='all') res=res.filter(o=>o.eco.startsWith(eco));
    if(search) res=res.filter(o=>o.name.toLowerCase().includes(search.toLowerCase()));
    return res;
  }
}

async function fetchRelated(opening){
  const family=opening.name.split(':')[0];
  try {
    const {data}=await sb.from('openings').select('eco,name,pgn').ilike('name',`%${family}%`).neq('name',opening.name).limit(10);
    return data||[];
  } catch(e){ return []; }
}

async function fetchTotalCount(){
  try {
    const {count}=await sb.from('openings').select('*',{count:'exact',head:true});
    return count||0;
  } catch(e){ return 0; }
}

// ── RENDER LIST ──
function renderList(list){
  const el=document.getElementById('openingList');
  if(!list.length){ el.innerHTML='<div class="list-status">No openings found</div>'; return; }
  el.innerHTML=list.map((o,i)=>`
    <div class="opening-item${i===currentIdx?' active':''}" id="oi${i}" onclick="selectOpening(${i})">
      <div class="opening-item-name">${o.name}</div>
      <div class="opening-item-eco">${o.eco}</div>
    </div>`).join('');
  document.getElementById('listCount').textContent=`${list.length} shown`;
}

// ── SELECT OPENING ──
async function selectOpening(idx){
  if(playTimer){clearInterval(playTimer);playTimer=null;document.getElementById('playBtn').textContent='▶ Play All';}
  currentIdx=idx;
  const op=allOpenings[idx];
  if(!op) return;

  // Highlight list item
  document.querySelectorAll('.opening-item').forEach(el=>el.classList.remove('active'));
  const item=document.getElementById('oi'+idx);
  if(item){item.classList.add('active');item.scrollIntoView({behavior:'smooth',block:'nearest'});}

  // Header
  document.getElementById('opName').textContent=op.name;
  const ecoBadge=document.getElementById('opEco');
  ecoBadge.textContent='ECO: '+op.eco; ecoBadge.style.display='';
  document.getElementById('opPgn').textContent=op.pgn;

  // Parse moves
  allMoves=parsePGN(op.pgn);
  const movesBadge=document.getElementById('opMoves');
  movesBadge.textContent=allMoves.length+' moves'; movesBadge.style.display='';

  // Board
  dispIdx=0;
  document.getElementById('boardWrap').innerHTML='<div id="board"></div>';
  renderBoard();
  renderMoveHistory();

  // Right panel
  document.getElementById('detailsPanel').innerHTML=`
    <div class="stat-row"><span class="stat-label">ECO</span><span class="stat-val">${op.eco}</span></div>
    <div class="stat-row"><span class="stat-label">Moves</span><span class="stat-val">${allMoves.length}</span></div>
    <div class="stat-row"><span class="stat-label">Category</span><span class="stat-val">${ecoCat(op.eco)}</span></div>
  `;

  // Related
  const related=await fetchRelated(op);
  document.getElementById('relatedPanel').innerHTML=related.length
    ? related.map(r=>`<div class="related-item" onclick="selectByName('${r.name.replace(/'/g,"\\'")}')"><div class="related-name">${r.name}</div><div class="related-pgn">${r.pgn}</div></div>`).join('')
    : '<div style="color:var(--muted);font-size:12px">No variations found.</div>';
}

function selectByName(name){
  const idx=allOpenings.findIndex(o=>o.name===name);
  if(idx>=0) selectOpening(idx);
}

function ecoCat(eco){
  return {A:'Flank / Indian openings',B:'Semi-open games (1.e4)',C:'Open games (1.e4 e5)',D:'Closed / Semi-closed',E:'Indian defenses (1.d4 Nf6)'}[eco[0]]||'Unknown';
}

// ── PGN PARSER ──
function parsePGN(pgn){
  const g=new Chess();
  const tokens=pgn.replace(/\d+\.\s*/g,' ').trim().split(/\s+/).filter(t=>t&&t!=='*');
  const moves=[];
  for(const t of tokens){
    const m=g.move(t);
    if(m) moves.push(m.san); else break;
  }
  return moves;
}

// ── BOARD RENDER ──
function makeGameAtIndex(idx){
  const g=new Chess();
  for(let i=0;i<idx;i++) g.move(allMoves[i]);
  return g;
}

function renderBoard(){
  const el=document.getElementById('board');
  if(!el) return;
  const g=makeGameAtIndex(dispIdx);
  const pos=g.board();
  const hist=g.history({verbose:true});
  const last=hist[hist.length-1];
  el.innerHTML='';
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      const rank=7-r,file=c;
      const sq='abcdefgh'[file]+(rank+1);
      const pc=pos[rank][file];
      const div=document.createElement('div');
      div.className='sq '+((rank+file)%2===1?'light':'dark');
      if(last&&sq===last.from) div.classList.add('hi-from');
      if(last&&sq===last.to)   div.classList.add('hi-to');
      if(pc){const s=document.createElement('div');s.className='piece';s.textContent=P[pc.color+pc.type.toUpperCase()]||'';div.appendChild(s);}
      if(file===0){const l=document.createElement('div');l.className='sq-rank';l.textContent=rank+1;div.appendChild(l);}
      if(rank===0){const l=document.createElement('div');l.className='sq-file';l.textContent='abcdefgh'[file];div.appendChild(l);}
      el.appendChild(div);
    }
  }
}

// ── MOVE HISTORY ──
function renderMoveHistory(){
  const el=document.getElementById('moveHistory');
  if(!allMoves.length){el.innerHTML='<span class="mv-empty">No moves</span>';return;}
  let h='';
  allMoves.forEach((san,i)=>{
    if(i%2===0) h+=`<span class="mv-num">${Math.floor(i/2)+1}.</span>`;
    h+=`<span class="mv-token${dispIdx===i+1?' active':''}" onclick="goTo(${i+1})">${san}</span>`;
  });
  el.innerHTML=h;
}

// ── NAVIGATION ──
function goTo(idx){
  dispIdx=Math.max(0,Math.min(idx,allMoves.length));
  renderBoard(); renderMoveHistory();
}
function goStart(){goTo(0);}
function goEnd(){goTo(allMoves.length);}
function prevMove(){if(dispIdx>0)goTo(dispIdx-1);}
function nextMove(){if(dispIdx<allMoves.length)goTo(dispIdx+1);}

function togglePlay(){
  if(playTimer){
    clearInterval(playTimer); playTimer=null;
    document.getElementById('playBtn').textContent='▶ Play All';
    return;
  }
  goStart();
  document.getElementById('playBtn').textContent='⏸ Pause';
  playTimer=setInterval(()=>{
    if(dispIdx>=allMoves.length){
      clearInterval(playTimer); playTimer=null;
      document.getElementById('playBtn').textContent='▶ Play All';
      return;
    }
    nextMove();
  },750);
}

// ── FILTERS ──
function setEco(eco){
  ecoFilter=eco;
  document.querySelectorAll('.eco-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+eco).classList.add('active');
  refreshList();
}

function onSearch(){
  clearTimeout(searchTimer);
  searchTimer=setTimeout(refreshList,280);
}

async function refreshList(){
  const q=document.getElementById('searchInput').value.trim();
  document.getElementById('openingList').innerHTML='<div class="list-status">Searching...</div>';
  allOpenings=await fetchOpenings(q,ecoFilter);
  currentIdx=-1;
  renderList(allOpenings);
}

// ── KEYBOARD ──
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowRight') nextMove();
  if(e.key==='ArrowLeft')  prevMove();
  if(e.key==='Home')       goStart();
  if(e.key==='End')        goEnd();
});

// ── INIT ──
async function init(){
  // Show total count
  const total=await fetchTotalCount();
  if(total>0) document.getElementById('totalCount').textContent=`${total.toLocaleString()} total`;

  // Load list
  allOpenings=await fetchOpenings('','all');
  renderList(allOpenings);

  // Auto-select first
  if(allOpenings.length>0) selectOpening(0);
}

init();
</script>
</body>
</html>
