<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malachi AI ‚Äî Openings Explorer</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <style>
    :root {
      --black:  #0a0a0a;
      --dark:   #111111;
      --panel:  #161616;
      --panel2: #1c1c1c;
      --border: #2a2a2a;
      --gold:   #c9a84c;
      --gold2:  #e8c97a;
      --cream:  #f5f0e8;
      --muted:  #6b6b6b;
      --white:  #ffffff;
      --green:  #4caf50;
      --red:    #e05068;
      --blue:   #5b8dee;
      --purple: #9c6fe4;
      --orange: #f0924a;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { background:var(--black); color:var(--cream); font-family:'Outfit',sans-serif; overflow-x:hidden; min-height:100vh; }
    .cursor { position:fixed; width:10px; height:10px; background:var(--gold); border-radius:50%; pointer-events:none; z-index:9999; transform:translate(-50%,-50%); mix-blend-mode:difference; }
    .cursor-ring { position:fixed; width:32px; height:32px; border:1px solid var(--gold); border-radius:50%; pointer-events:none; z-index:9998; transform:translate(-50%,-50%); opacity:0.4; transition:left 0.12s ease-out,top 0.12s ease-out; }
    .chess-bg { position:fixed; inset:0; z-index:0; opacity:0.025; background-image:repeating-conic-gradient(var(--gold) 0% 25%, transparent 0% 50%); background-size:48px 48px; pointer-events:none; }

    nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:18px 40px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.96); backdrop-filter:blur(12px); }
    .logo { display:flex; align-items:center; gap:12px; text-decoration:none; }
    .logo-icon { display:grid; grid-template-columns:1fr 1fr; gap:2px; width:18px; height:18px; }
    .logo-icon span { background:var(--gold); border-radius:1px; display:block; }
    .logo-icon span:nth-child(2),.logo-icon span:nth-child(3) { background:transparent; border:1px solid var(--gold); }
    .logo-text { font-family:'DM Mono',monospace; font-size:13px; letter-spacing:0.1em; color:var(--cream); }
    .logo-text span { color:var(--gold); }
    .nav-right { display:flex; align-items:center; gap:16px; }
    .nav-link { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); text-decoration:none; padding:8px 14px; border:1px solid transparent; transition:all 0.2s; }
    .nav-link:hover,.nav-link.active { color:var(--gold); border-color:var(--border); }

    .main { position:relative; z-index:1; display:grid; grid-template-columns:260px 1fr 340px; min-height:calc(100vh - 65px); }

    /* LEFT: Opening categories */
    .sidebar-left { background:var(--panel); border-right:1px solid var(--border); padding:20px 0; overflow-y:auto; }
    .cat-section { padding:0 0 8px; }
    .cat-title { font-family:'DM Mono',monospace; font-size:9px; letter-spacing:0.25em; color:var(--muted); text-transform:uppercase; padding:16px 20px 8px; border-top:1px solid var(--border); }
    .cat-title:first-child { border-top:none; padding-top:0; }
    .opening-btn { width:100%; text-align:left; background:none; border:none; border-left:2px solid transparent; color:var(--muted); font-family:'Outfit',sans-serif; font-size:12px; padding:9px 20px 9px 18px; cursor:pointer; transition:all 0.15s; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .opening-btn:hover { color:var(--cream); background:rgba(255,255,255,0.03); }
    .opening-btn.active { color:var(--gold); border-left-color:var(--gold); background:rgba(201,168,76,0.06); }
    .opening-eco { font-family:'DM Mono',monospace; font-size:9px; color:var(--muted); letter-spacing:0.06em; flex-shrink:0; }

    /* CENTER: Board */
    .board-area { display:flex; flex-direction:column; align-items:center; padding:32px 24px; gap:20px; }
    .opening-header { width:100%; max-width:520px; }
    .opening-name { font-size:22px; font-weight:700; color:var(--cream); margin-bottom:4px; }
    .opening-eco-badge { font-family:'DM Mono',monospace; font-size:10px; color:var(--gold); background:rgba(201,168,76,0.1); border:1px solid rgba(201,168,76,0.2); padding:3px 10px; display:inline-block; margin-bottom:10px; letter-spacing:0.1em; }
    .opening-desc { font-size:13px; color:var(--muted); line-height:1.6; max-width:480px; }

    #board { display:grid; grid-template-columns:repeat(8,1fr); width:480px; height:480px; border:3px solid #8b6914; box-shadow:0 8px 32px rgba(0,0,0,0.7); }
    .sq { width:60px; height:60px; display:flex; align-items:center; justify-content:center; position:relative; }
    .sq.light { background:#f0d9b5; }
    .sq.dark  { background:#b58863; }
    .sq.highlight { background:rgba(246,246,105,0.6) !important; }
    .sq.last-from { background:rgba(246,246,105,0.45) !important; }
    .sq.last-to   { background:rgba(246,246,105,0.7) !important; }
    .piece { width:100%; height:100%; display:block; user-select:none; pointer-events:none; }
    .piece-wrap { width:85%; height:85%; display:flex; align-items:center; justify-content:center; }
    .piece-wrap.bounce { animation:pieceBounce 0.22s cubic-bezier(0.2,0,0,1.4); }
    @keyframes pieceBounce { 0%{transform:scale(1.15)} 60%{transform:scale(0.95)} 100%{transform:scale(1)} }
    .sq-lbl { position:absolute; bottom:2px; right:3px; font-size:9px; font-family:'DM Mono',monospace; font-weight:600; pointer-events:none; }
    .sq.light .sq-lbl, .sq.light .sq-lbl-r { color:rgba(181,136,99,0.85); }
    .sq.dark .sq-lbl, .sq.dark .sq-lbl-r { color:rgba(240,217,181,0.85); }
    .sq-lbl-r { position:absolute; top:2px; left:3px; font-size:9px; font-family:'DM Mono',monospace; font-weight:600; pointer-events:none; }

    /* Move controls */
    .move-controls { display:flex; gap:10px; width:480px; }
    .ctrl-btn { flex:1; padding:11px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; border:1px solid var(--border); background:var(--panel); color:var(--muted); cursor:pointer; transition:all 0.2s; }
    .ctrl-btn:hover { color:var(--cream); border-color:var(--muted); }
    .ctrl-btn.primary { border-color:rgba(201,168,76,0.4); color:var(--gold); background:rgba(201,168,76,0.06); }

    /* Move history bar */
    .move-history { width:480px; display:flex; flex-wrap:wrap; gap:4px; padding:12px 16px; background:var(--panel); border:1px solid var(--border); min-height:44px; align-items:center; }
    .move-token { font-family:'DM Mono',monospace; font-size:11px; padding:3px 8px; background:var(--panel2); border:1px solid var(--border); color:var(--muted); cursor:pointer; transition:all 0.15s; }
    .move-token:hover { color:var(--cream); }
    .move-token.current { color:var(--gold); border-color:rgba(201,168,76,0.4); background:rgba(201,168,76,0.08); }
    .move-num { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); opacity:0.5; }

    /* RIGHT: Info panel */
    .sidebar-right { background:var(--panel); border-left:1px solid var(--border); padding:24px 20px; overflow-y:auto; }
    .section-head { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.2em; color:var(--muted); text-transform:uppercase; margin-bottom:14px; padding-bottom:8px; border-bottom:1px solid var(--border); }

    .var-btn { width:100%; text-align:left; background:none; border:1px solid var(--border); color:var(--muted); font-family:'Outfit',sans-serif; font-size:12px; padding:10px 14px; cursor:pointer; transition:all 0.15s; margin-bottom:6px; }
    .var-btn:hover { color:var(--cream); border-color:var(--muted); background:rgba(255,255,255,0.03); }
    .var-btn .var-moves { font-family:'DM Mono',monospace; font-size:10px; color:var(--gold); margin-top:3px; display:block; }

    .key-idea { background:var(--panel2); border-left:3px solid var(--gold); padding:12px 14px; margin-bottom:10px; font-size:12px; line-height:1.6; color:var(--cream); }
    .key-idea strong { color:var(--gold); display:block; margin-bottom:4px; font-size:11px; font-family:'DM Mono',monospace; letter-spacing:0.08em; }

    .move-step { display:flex; gap:12px; padding:8px 0; border-bottom:1px solid var(--border); cursor:pointer; }
    .move-step:hover { background:rgba(255,255,255,0.02); }
    .step-num { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); width:20px; flex-shrink:0; padding-top:2px; }
    .step-move { font-family:'DM Mono',monospace; font-size:12px; color:var(--gold); width:48px; flex-shrink:0; }
    .step-desc { font-size:11px; color:var(--muted); line-height:1.5; }

    .particle { position:absolute; border-radius:50%; pointer-events:none; animation:particleFly 0.55s ease-out forwards; z-index:200; }
    @keyframes particleFly { 0%{opacity:1;transform:translate(0,0) scale(1)} 100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0)} }

    @media (max-width:1100px) { .main { grid-template-columns:220px 1fr; } .sidebar-right { display:none; } }
    @media (max-width:800px) {
      .main { grid-template-columns:1fr; }
      .sidebar-left { display:none; }
      #board { width:360px; height:360px; }
      .sq { width:45px; height:45px; }

      .move-controls,.move-history { width:360px; }
    }

    /* ‚îÄ‚îÄ Profile nav widget ‚îÄ‚îÄ */
    .profile-nav { display:flex; align-items:center; gap:10px; }
    .profile-avatar-btn { width:34px; height:34px; border-radius:50%; background:linear-gradient(135deg,#c9a84c,#8b6914); border:2px solid rgba(201,168,76,0.4); display:flex; align-items:center; justify-content:center; font-family:'DM Mono',monospace; font-size:12px; font-weight:700; color:#000; cursor:pointer; text-decoration:none; transition:all 0.2s; flex-shrink:0; }
    .profile-avatar-btn:hover { border-color:#c9a84c; transform:scale(1.08); }
    .profile-rating-pill { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:0.08em; color:#c9a84c; background:rgba(201,168,76,0.08); border:1px solid rgba(201,168,76,0.25); padding:4px 10px; white-space:nowrap; }
    .profile-signin { font-family:'DM Mono',monospace; font-size:11px; letter-spacing:0.08em; text-transform:uppercase; color:#c9a84c; text-decoration:none; border:1px solid rgba(201,168,76,0.3); padding:6px 14px; transition:all 0.2s; }
    .profile-signin:hover { background:rgba(201,168,76,0.08); }
  </style>
</head>
<body>
<div class="cursor" id="cursor"></div>
<div class="cursor-ring" id="cursorRing"></div>
<div class="chess-bg"></div>

<nav>
  <a href="index.html" class="logo">
    <div class="logo-icon"><span></span><span></span><span></span><span></span></div>
    <div class="logo-text">Malachi <span>AI</span></div>
  </a>
  <div class="nav-right">
    <a href="index.html" class="nav-link">Home</a>
    <a href="learn.html" class="nav-link">Learn</a>
    <a href="puzzles.html" class="nav-link">Puzzles</a>
    <a href="play.html" class="nav-link">Play</a>
    <a href="dashboard.html" class="nav-link">Dashboard</a>
  </div>
</nav>

<div class="main">
  <!-- LEFT SIDEBAR -->
  <div class="sidebar-left" id="openingList"></div>

  <!-- BOARD CENTER -->
  <div class="board-area">
    <div class="opening-header">
      <div class="opening-name" id="openingName">Opening Explorer</div>
      <div class="opening-eco-badge" id="openingEco">ECO: ‚Äî</div>
      <div class="opening-desc" id="openingDesc">Select an opening from the left to explore its moves, ideas, and key variations.</div>
    </div>

    <div style="position:relative;display:inline-block;line-height:0;">
      <div id="board"></div>
      <svg id="move-arrow-svg" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:50;" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>

    <div class="move-history" id="moveHistory">
      <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:0.08em;">Select an opening to begin</span>
    </div>

    <div class="move-controls">
      <button class="ctrl-btn" onclick="goStart()">‚èÆ Start</button>
      <button class="ctrl-btn" onclick="prevMove()">‚Üê Back</button>
      <button class="ctrl-btn" onclick="nextMove()">Forward ‚Üí</button>
      <button class="ctrl-btn primary" onclick="playAll()">‚ñ∂ Play All</button>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="sidebar-right" id="rightPanel">
    <div class="section-head">Key Ideas</div>
    <div id="keyIdeas" style="color:var(--muted);font-size:12px;">Select an opening to see strategic ideas and move explanations.</div>

    <div class="section-head" style="margin-top:24px">Move by Move</div>
    <div id="moveAnnotations"></div>

    <div class="section-head" style="margin-top:24px">Variations</div>
    <div id="variationsList"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CURSOR ‚îÄ‚îÄ
const cursor = document.getElementById('cursor');
const ring = document.getElementById('cursorRing');
document.addEventListener('mousemove', e => {
  cursor.style.left = e.clientX+'px'; cursor.style.top = e.clientY+'px';
  ring.style.left = e.clientX+'px'; ring.style.top = e.clientY+'px';
});

// ‚îÄ‚îÄ OPENINGS DATABASE ‚îÄ‚îÄ
// 200+ openings with ECO codes, moves, descriptions, key ideas, and variations
const OPENINGS = [
  // ‚ïê‚ïê‚ïê E-PAWN OPENINGS (e4) ‚ïê‚ïê‚ïê
  {
    eco:'C20', name:"King's Pawn Game", category:"e4 Openings",
    moves:['e2e4','e7e5'],
    desc:"The foundation of open chess. Both sides fight for the center immediately.",
    ideas:["Control d4 and d5 with pawns","Develop knights before bishops","Castle early to protect the king"],
    annotations:["1. e4 ‚Äî Stake your claim in the center","1...e5 ‚Äî Black mirrors the strategy"],
    variations:[
      {name:"Italian Game",moves:"2.Nf3 Nc6 3.Bc4"},
      {name:"Spanish (Ruy L√≥pez)",moves:"2.Nf3 Nc6 3.Bb5"},
      {name:"King's Gambit",moves:"2.f4"},
      {name:"Vienna Game",moves:"2.Nc3"},
    ]
  },
  {
    eco:'C50', name:'Italian Game', category:'e4 Openings',
    moves:['e2e4','e7e5','g1f3','b8c6','f1c4'],
    desc:"One of the oldest openings ‚Äî simple, principled, and deadly in the right hands. The bishop eyes f7.",
    ideas:["Aim the bishop at f7 ‚Äî the weakest square","Control the center with pawns","Prepare to castle kingside quickly"],
    annotations:["1. e4 ‚Äî Pawn center","1...e5 ‚Äî Mirror","2. Nf3 ‚Äî Develops and attacks e5","2...Nc6 ‚Äî Defends","3. Bc4 ‚Äî The Italian! Aims at f7"],
    variations:[
      {name:"Giuoco Piano",moves:"3...Bc5 4.c3 Nf6 5.d4"},
      {name:"Two Knights Defense",moves:"3...Nf6 4.Ng5"},
      {name:"Evans Gambit",moves:"3...Bc5 4.b4"},
      {name:"Hungarian Defense",moves:"3...Be7"},
    ]
  },
  {
    eco:'C60', name:'Spanish Opening (Ruy L√≥pez)', category:'e4 Openings',
    moves:['e2e4','e7e5','g1f3','b8c6','f1b5'],
    desc:"The most played opening by World Champions for 500 years. Subtle pressure on e5.",
    ideas:["Pressure the Nc6 that defends e5","Long-term squeeze of Black's position","Castle queenside for attacking chances"],
    annotations:["1. e4","1...e5","2. Nf3","2...Nc6","3. Bb5 ‚Äî The Spanish! Threatens to win e5 by capturing Nc6"],
    variations:[
      {name:"Berlin Defense",moves:"3...Nf6 4.0-0 Nxe4"},
      {name:"Marshall Attack",moves:"3...a6 4.Ba4 Nf6 5.0-0 Be7 6.Re1 b5 7.Bb3 0-0 8.c3 d5"},
      {name:"Morphy Defense",moves:"3...a6 4.Ba4"},
      {name:"Steinitz Defense",moves:"3...d6"},
      {name:"Classical Defense",moves:"3...Bc5"},
    ]
  },
  {
    eco:'B20', name:'Sicilian Defense', category:'e4 Openings',
    moves:['e2e4','c7c5'],
    desc:"The sharpest and most popular response to 1.e4. Black creates immediate imbalance.",
    ideas:["Fight for d4 without giving White a free tempo","Create queenside counterplay","Unbalanced positions with winning chances for both sides"],
    annotations:["1. e4","1...c5 ‚Äî The Sicilian! Fights d4 asymmetrically"],
    variations:[
      {name:"Najdorf Variation",moves:"2.Nf3 d6 3.d4 cxd4 4.Nxd4 Nf6 5.Nc3 a6"},
      {name:"Dragon Variation",moves:"2.Nf3 d6 3.d4 cxd4 4.Nxd4 Nf6 5.Nc3 g6"},
      {name:"Scheveningen",moves:"2.Nf3 d6 3.d4 cxd4 4.Nxd4 Nf6 5.Nc3 e6"},
      {name:"Kan Variation",moves:"2.Nf3 e6 3.d4 cxd4 4.Nxd4 a6"},
      {name:"Classical Sicilian",moves:"2.Nf3 Nc6 3.d4 cxd4 4.Nxd4"},
      {name:"Accelerated Dragon",moves:"2.Nf3 Nc6 3.d4 cxd4 4.Nxd4 g6"},
      {name:"Grand Prix Attack",moves:"2.Nc3 Nc6 3.f4"},
    ]
  },
  {
    eco:'C00', name:'French Defense', category:'e4 Openings',
    moves:['e2e4','e7e6'],
    desc:"Solid and strategic. Black creates a pawn chain and counterattacks White's center.",
    ideas:["Build a solid pawn structure","Attack White's center with ...c5","Use the c8 bishop carefully ‚Äî it can become bad"],
    annotations:["1. e4","1...e6 ‚Äî Prepares d5, solid but slightly passive"],
    variations:[
      {name:"Winawer Variation",moves:"2.d4 d5 3.Nc3 Bb4"},
      {name:"Classical Variation",moves:"2.d4 d5 3.Nc3 Nf6"},
      {name:"Tarrasch Variation",moves:"2.d4 d5 3.Nd2"},
      {name:"Advance Variation",moves:"2.d4 d5 3.e5"},
      {name:"Exchange Variation",moves:"2.d4 d5 3.exd5 exd5"},
    ]
  },
  {
    eco:'B10', name:'Caro-Kann Defense', category:'e4 Openings',
    moves:['e2e4','c7c6'],
    desc:"Solid and resilient. Black prepares d5 with the c-pawn, keeping the light-squared bishop active.",
    ideas:["Prepare ...d5 to contest the center","Keep the c8 bishop outside the pawn chain","Solid structure ‚Äî hard to attack"],
    annotations:["1. e4","1...c6 ‚Äî Prepares d5, unlike the French keeps the bishop free"],
    variations:[
      {name:"Classical Variation",moves:"2.d4 d5 3.Nc3 dxe4 4.Nxe4"},
      {name:"Advance Variation",moves:"2.d4 d5 3.e5"},
      {name:"Exchange Variation",moves:"2.d4 d5 3.exd5 cxd5 4.c4"},
      {name:"Fantasy Variation",moves:"2.d4 d5 3.f3"},
      {name:"Two Knights",moves:"2.Nc3 d5 3.Nf3"},
    ]
  },
  {
    eco:'C40', name:"King's Gambit", category:'e4 Openings',
    moves:['e2e4','e7e5','f2f4'],
    desc:"The most romantic opening in chess history. White sacrifices a pawn for rapid development and a kingside attack.",
    ideas:["Open the f-file for the rook","Rapid piece development after exf4","Seize the center and attack before Black consolidates"],
    annotations:["1. e4","1...e5","2. f4 ‚Äî The King's Gambit! A pawn sacrifice for attacking chances"],
    variations:[
      {name:"King's Gambit Accepted",moves:"2...exf4 3.Nf3"},
      {name:"Fischer Defense",moves:"2...exf4 3.Nf3 d6"},
      {name:"Falkbeer Counter Gambit",moves:"2...d5"},
      {name:"King's Gambit Declined",moves:"2...Bc5"},
    ]
  },
  {
    eco:'C44', name:"Scotch Game", category:'e4 Openings',
    moves:['e2e4','e7e5','g1f3','b8c6','d2d4'],
    desc:"Kasparov's revival of this classical opening. White immediately opens the center.",
    ideas:["Open the center immediately with d4","Active piece play after exd4","Avoid the slow maneuvering of the Spanish"],
    annotations:["1. e4","1...e5","2. Nf3","2...Nc6","3. d4 ‚Äî The Scotch! Immediate central confrontation"],
    variations:[
      {name:"Scotch Game Main Line",moves:"3...exd4 4.Nxd4"},
      {name:"Scotch Gambit",moves:"3...exd4 4.Bc4"},
      {name:"Schmidt Variation",moves:"3...exd4 4.Nxd4 Nf6"},
      {name:"Mieses Variation",moves:"3...exd4 4.Nxd4 Qh4"},
    ]
  },
  {
    eco:'C46', name:'Four Knights Game', category:'e4 Openings',
    moves:['e2e4','e7e5','g1f3','b8c6','b1c3','g8f6'],
    desc:"Symmetrical development. Both sides bring out all their knights before committing pawns.",
    ideas:["Develop all pieces before pushing pawns","Maintain symmetry or break it strategically","Natural development following all opening principles"],
    annotations:["1. e4","1...e5","2. Nf3","2...Nc6","3. Nc3","3...Nf6 ‚Äî Perfect symmetry! Both sides fully developed"],
    variations:[
      {name:"Spanish Four Knights",moves:"4.Bb5"},
      {name:"Italian Four Knights",moves:"4.Bc4"},
      {name:"Scotch Four Knights",moves:"4.d4"},
      {name:"Double Spanish",moves:"4.Bb5 Bb4"},
    ]
  },
  {
    eco:'B01', name:'Scandinavian Defense', category:'e4 Openings',
    moves:['e2e4','d7d5'],
    desc:"Black immediately challenges the center. Aggressive and direct ‚Äî the queen comes out early.",
    ideas:["Contest the center from move 1","Queen comes out early to d5 or d6","Solid but requires precise play to avoid harassment"],
    annotations:["1. e4","1...d5 ‚Äî Immediate central challenge!"],
    variations:[
      {name:"Main Line",moves:"2.exd5 Qxd5 3.Nc3 Qa5"},
      {name:"Modern Variation",moves:"2.exd5 Nf6"},
      {name:"Icelandic Gambit",moves:"2.exd5 Nf6 3.c4 e6"},
      {name:"Portuguese Variation",moves:"2.exd5 Nf6 3.d4 Bg4"},
    ]
  },
  {
    eco:'B07', name:'Pirc Defense', category:'e4 Openings',
    moves:['e2e4','d7d6','d2d4','g8f6','b1c3','g7g6'],
    desc:"Hypermodern strategy. Black lets White build a center, then attacks it from the flanks.",
    ideas:["Let White have the center","Attack it with ...c5 or ...e5 later","Fianchetto bishop on g7 controls the long diagonal"],
    annotations:["1. e4","1...d6","2. d4","2...Nf6","3. Nc3","3...g6 ‚Äî Hypermodern! Black prepares to attack White's center"],
    variations:[
      {name:"Classical System",moves:"4.Nf3 Bg7 5.Be2"},
      {name:"Austrian Attack",moves:"4.f4 Bg7"},
      {name:"150 Attack",moves:"4.Be3 Bg7 5.Qd2"},
    ]
  },

  // ‚ïê‚ïê‚ïê d-PAWN OPENINGS (d4) ‚ïê‚ïê‚ïê
  {
    eco:'D00', name:"Queen's Pawn Game", category:'d4 Openings',
    moves:['d2d4','d7d5'],
    desc:"The foundation of closed chess. Slower, more strategic battles than 1.e4.",
    ideas:["Control the center with d4","Develop pieces toward the center","Plan queenside or kingside attacks based on pawn structure"],
    annotations:["1. d4 ‚Äî Control d4 and e5","1...d5 ‚Äî Black fights for the center"],
    variations:[
      {name:"Queen's Gambit",moves:"2.c4"},
      {name:"London System",moves:"2.Nf3 Nf6 3.Bf4"},
      {name:"Trompowsky Attack",moves:"2.Bg5"},
      {name:"Colle System",moves:"2.Nf3 Nf6 3.e3"},
    ]
  },
  {
    eco:'D06', name:"Queen's Gambit", category:'d4 Openings',
    moves:['d2d4','d7d5','c2c4'],
    desc:"The most classic opening in chess. White offers a pawn to gain central control.",
    ideas:["Offer c4 pawn to gain e4 push","Not a real gambit ‚Äî White almost always regains the pawn","Central control through d4 + e4"],
    annotations:["1. d4","1...d5","2. c4 ‚Äî The Queen's Gambit! Offer the c-pawn for central control"],
    variations:[
      {name:"Queen's Gambit Accepted",moves:"2...dxc4 3.Nf3"},
      {name:"Queen's Gambit Declined",moves:"2...e6 3.Nc3 Nf6"},
      {name:"Slav Defense",moves:"2...c6 3.Nf3 Nf6"},
      {name:"Semi-Slav",moves:"2...c6 3.Nf3 Nf6 4.Nc3 e6"},
      {name:"Chigorin Defense",moves:"2...Nc6"},
      {name:"Albin Counter Gambit",moves:"2...e5"},
    ]
  },
  {
    eco:'D10', name:'Slav Defense', category:'d4 Openings',
    moves:['d2d4','d7d5','c2c4','c7c6'],
    desc:"Black supports the d5 pawn with c6, keeping the c8 bishop outside the pawn chain.",
    ideas:["Support d5 with c6","Keep the c8 bishop active ‚Äî it stays outside the chain","Solid structure, counterplay with ...dxc4 and ...b5"],
    annotations:["1. d4","1...d5","2. c4","2...c6 ‚Äî The Slav! Solid support for d5 without locking in the bishop"],
    variations:[
      {name:"Slav Exchange",moves:"3.cxd5 cxd5 4.Nc3"},
      {name:"Semi-Slav",moves:"3.Nf3 Nf6 4.Nc3 e6"},
      {name:"Czech Variation",moves:"3.Nf3 Nf6 4.Nc3 dxc4"},
      {name:"Chameleon Variation",moves:"3.Nf3 Nf6 4.Nc3 a6"},
    ]
  },
  {
    eco:'E60', name:"King's Indian Defense", category:'d4 Openings',
    moves:['d2d4','g8f6','c2c4','g7g6'],
    desc:"Dynamic and aggressive. Black allows White a big center, then counterattacks with ...e5.",
    ideas:["Let White build the center","Attack with ...e5 or ...c5","Fianchetto bishop becomes a monster on g7"],
    annotations:["1. d4","1...Nf6","2. c4","2...g6 ‚Äî Hypermodern! Black will fianchetto and attack the center"],
    variations:[
      {name:"Classical KID",moves:"3.Nc3 Bg7 4.e4 d6 5.Nf3 0-0 6.Be2"},
      {name:"S√§misch Variation",moves:"3.Nc3 Bg7 4.e4 d6 5.f3"},
      {name:"Four Pawns Attack",moves:"3.Nc3 Bg7 4.e4 d6 5.f4"},
      {name:"Averbakh Variation",moves:"3.Nc3 Bg7 4.e4 d6 5.Be2 0-0 6.Bg5"},
    ]
  },
  {
    eco:'E00', name:"Nimzo-Indian Defense", category:'d4 Openings',
    moves:['d2d4','g8f6','c2c4','e7e6','b1c3','f8b4'],
    desc:"One of Black's best responses. The bishop pins the knight and prevents e4.",
    ideas:["Pin the Nc3 with Bb4","Prevent White from playing e4","Double White's pawns after ...Bxc3"],
    annotations:["1. d4","1...Nf6","2. c4","2...e6","3. Nc3","3...Bb4 ‚Äî The Nimzo! Immediately pins the knight"],
    variations:[
      {name:"Classical Variation",moves:"4.Qc2"},
      {name:"Rubinstein Variation",moves:"4.e3"},
      {name:"S√§misch Variation",moves:"4.a3 Bxc3+ 5.bxc3"},
      {name:"Leningrad Variation",moves:"4.Bg5"},
    ]
  },
  {
    eco:'E20', name:"Catalan Opening", category:'d4 Openings',
    moves:['d2d4','g8f6','c2c4','e7e6','g2g3'],
    desc:"White combines the Queen's Gambit with a kingside fianchetto for long-term pressure.",
    ideas:["Fianchetto the bishop to g2","Long-term pressure on the c4-a8 diagonal","Solid queenside control combined with kingside safety"],
    annotations:["1. d4","1...Nf6","2. c4","2...e6","3. g3 ‚Äî The Catalan! Planning Bg2 for long diagonal pressure"],
    variations:[
      {name:"Open Catalan",moves:"3...d5 4.Bg2 dxc4"},
      {name:"Closed Catalan",moves:"3...d5 4.Bg2 Be7"},
      {name:"Catalan with Nf3",moves:"4.Nf3 d5 5.Bg2"},
    ]
  },
  {
    eco:'A45', name:"Trompowsky Attack", category:'d4 Openings',
    moves:['d2d4','g8f6','c1g5'],
    desc:"Unusual and tricky. White immediately attacks the knight, avoiding theory.",
    ideas:["Avoid heavily theoretical lines","Create immediate problems for Black","Exchange the knight for the bishop to double pawns"],
    annotations:["1. d4","1...Nf6","2. Bg5 ‚Äî The Trompowsky! Immediately attacks the knight, very annoying"],
    variations:[
      {name:"Main Line",moves:"2...Ne4 3.Bf4"},
      {name:"Classical Response",moves:"2...d5 3.Bxf6"},
      {name:"Sharp Response",moves:"2...e6 3.e4"},
    ]
  },
  {
    eco:'A10', name:'English Opening', category:'d4 Openings',
    moves:['c2c4'],
    desc:"The third most popular first move. Flexible and hypermodern ‚Äî fight for d5 from the flank.",
    ideas:["Control d5 with the c-pawn","Flexibility ‚Äî can transpose to many openings","Popular at grandmaster level for avoiding Black's preparation"],
    annotations:["1. c4 ‚Äî The English! Control d5 from the flank, not the center"],
    variations:[
      {name:"Symmetrical English",moves:"1...c5"},
      {name:"English vs KID",moves:"1...Nf6 2.Nc3 g6"},
      {name:"Reversed Sicilian",moves:"1...e5 2.Nc3"},
      {name:"Anglo-Indian",moves:"1...Nf6 2.Nc3 e6 3.e4"},
    ]
  },

  // ‚ïê‚ïê‚ïê FLANK OPENINGS ‚ïê‚ïê‚ïê
  {
    eco:'A00', name:"Reti Opening", category:'Flank Openings',
    moves:['g1f3'],
    desc:"Hypermodern king's knight opening. Delays central pawns and fights for the center with pieces.",
    ideas:["Control the center with pieces, not pawns","Fianchetto the bishop for long diagonal control","Flexible ‚Äî transpose to many structures"],
    annotations:["1. Nf3 ‚Äî The Reti! No pawn in the center yet"],
    variations:[
      {name:"King's Indian Attack",moves:"1...d5 2.g3"},
      {name:"Reti vs Sicilian",moves:"1...c5 2.c4"},
      {name:"Reversed Gr√ºnfeld",moves:"1...d5 2.c4 d4"},
    ]
  },
  {
    eco:'A07', name:"King's Indian Attack", category:'Flank Openings',
    moves:['g1f3','d7d5','g2g3'],
    desc:"White builds the same structure as the King's Indian but with the colors reversed.",
    ideas:["Build a solid kingside structure","Attack later with e4 and f4","Flexible ‚Äî works against many Black setups"],
    annotations:["1. Nf3","1...d5","2. g3 ‚Äî KIA! White mirrors the KID structure"],
    variations:[
      {name:"vs French structure",moves:"2...e6 3.Bg2 Nf6 4.0-0"},
      {name:"vs Sicilian",moves:"1.Nf3 c5 2.g3 Nc6 3.Bg2"},
    ]
  },

  // ‚ïê‚ïê‚ïê GAMBIT OPENINGS ‚ïê‚ïê‚ïê
  {
    eco:'C21', name:"Danish Gambit", category:'Gambits',
    moves:['e2e4','e7e5','d2d4','e5d4','c2c3'],
    desc:"White sacrifices two pawns for a massive lead in development and a devastating attack.",
    ideas:["Sacrifice two pawns for two open files","Rapid development ‚Äî pieces come out with tempo","Attack the king before Black can consolidate"],
    annotations:["1. e4","1...e5","2. d4","2...exd4","3. c3 ‚Äî The Danish! Two pawn sacrifices for massive compensation"],
    variations:[
      {name:"Accepted",moves:"3...dxc3 4.Bc4 cxb2 5.Bxb2"},
      {name:"Declined",moves:"3...d5 4.exd5 Qxd5"},
    ]
  },
  {
    eco:'A57', name:'Benko Gambit', category:'Gambits',
    moves:['d2d4','g8f6','c2c4','c7c5','d4d5','b7b5'],
    desc:"Black sacrifices a pawn for lasting queenside pressure and open files.",
    ideas:["Sacrifice b5 pawn for open a and b files","Long-term queenside pressure","Rooks become very powerful on open files"],
    annotations:["1. d4","1...Nf6","2. c4","2...c5","3. d5","3...b5 ‚Äî The Benko! Pawn sacrifice for queenside play"],
    variations:[
      {name:"Accepted",moves:"4.cxb5 a6 5.bxa6 Bxa6"},
      {name:"Declined",moves:"4.Nf3"},
      {name:"Half-Accepted",moves:"4.cxb5 a6 5.e3"},
    ]
  },
  {
    eco:'D30', name:'Budapest Gambit', category:'Gambits',
    moves:['d2d4','g8f6','c2c4','e7e5'],
    desc:"A surprise weapon. Black immediately attacks the center with a pawn sacrifice.",
    ideas:["Immediate counterattack against d4","Gambit pawn for active piece play","Tricky tactics if White is unprepared"],
    annotations:["1. d4","1...Nf6","2. c4","2...e5 ‚Äî The Budapest! Immediate counterattack"],
    variations:[
      {name:"Fajarowicz Variation",moves:"3.dxe5 Ne4"},
      {name:"Alekhine Variation",moves:"3.dxe5 Ng4 4.Nf3"},
    ]
  },

  // ‚ïê‚ïê‚ïê DEFENSES ‚ïê‚ïê‚ïê
  {
    eco:'A41', name:"Gr√ºnfeld Defense", category:'Defenses',
    moves:['d2d4','g8f6','c2c4','g7g6','b1c3','d7d5'],
    desc:"Black allows White a big center, then attacks it head-on with ...d5.",
    ideas:["Allow White a center, then destroy it","Active piece play especially on g7 diagonal","The g7 bishop becomes a monster attacking d4"],
    annotations:["1. d4","1...Nf6","2. c4","2...g6","3. Nc3","3...d5 ‚Äî The Gr√ºnfeld! Direct central confrontation"],
    variations:[
      {name:"Exchange Variation",moves:"4.cxd5 Nxd5 5.e4 Nxc3 6.bxc3"},
      {name:"Russian System",moves:"4.Nf3 Bg7 5.Qb3"},
      {name:"Three Knights",moves:"4.Nf3 Bg7 5.Bf4"},
    ]
  },
  {
    eco:'E40', name:'Dutch Defense', category:'Defenses',
    moves:['d2d4','f7f5'],
    desc:"Aggressive from move one. Black immediately fights for the kingside.",
    ideas:["Control the e4 square","Kingside attack with ...f5-f4","Very double-edged ‚Äî risky but exciting"],
    annotations:["1. d4","1...f5 ‚Äî The Dutch! Aggressive kingside intent from move one"],
    variations:[
      {name:"Stonewall Dutch",moves:"2.c4 Nf6 3.g3 e6 4.Bg2 d5 5.Nf3 c3"},
      {name:"Leningrad Dutch",moves:"2.c4 Nf6 3.g3 g6"},
      {name:"Classical Dutch",moves:"2.c4 Nf6 3.g3 e6"},
    ]
  },
  {
    eco:'E10', name:"Benoni Defense", category:'Defenses',
    moves:['d2d4','g8f6','c2c4','c7c5','d4d5'],
    desc:"Dynamic and imbalanced. Black accepts a backward pawn for active counterplay.",
    ideas:["Accept pawn imbalance for active play","Attack on the kingside with ...f5","The c5 break is always in the air"],
    annotations:["1. d4","1...Nf6","2. c4","2...c5","3. d5 ‚Äî The Benoni! Imbalanced pawn structure with mutual chances"],
    variations:[
      {name:"Modern Benoni",moves:"3...e6 4.Nc3 exd5 5.cxd5 d6"},
      {name:"Czech Benoni",moves:"3...e5"},
      {name:"Benko Gambit",moves:"3...b5"},
    ]
  },
  {
    eco:'B00', name:"Owen's Defense", category:'Defenses',
    moves:['e2e4','b7b6'],
    desc:"Unorthodox and tricky. Black fianchettoes the queen's bishop to attack the center.",
    ideas:["Fianchetto the queen's bishop","Attack the center from the flank","Surprise weapon against unprepared opponents"],
    annotations:["1. e4","1...b6 ‚Äî Owen's! Prepares Bb7 to attack the center diagonally"],
    variations:[
      {name:"Classical",moves:"2.d4 Bb7 3.Bd3 e6"},
      {name:"Modern",moves:"2.d4 Bb7 3.Nc3 e6"},
    ]
  },
  {
    eco:'B06', name:'Modern Defense', category:'Defenses',
    moves:['e2e4','g7g6'],
    desc:"Pure hypermodern play. Black avoids the center entirely, planning to attack it later.",
    ideas:["Let White build any center they want","Attack it from range with the g7 bishop","Very flexible ‚Äî transpose to Pirc, KID, or more"],
    annotations:["1. e4","1...g6 ‚Äî The Modern! Pure hypermodern ‚Äî Black will attack whatever center White builds"],
    variations:[
      {name:"Robatsch Variation",moves:"2.d4 Bg7 3.Nc3 d6"},
      {name:"vs Kingside Fianchetto",moves:"2.d4 Bg7 3.Nf3 d6 4.g3"},
    ]
  },
];

// ‚îÄ‚îÄ BOARD STATE ‚îÄ‚îÄ
const PIECE_BASE = 'https://lichess1.org/assets/piece/cburnett/';
const PIECE_SRC = {
  wK:'wK.svg',wQ:'wQ.svg',wR:'wR.svg',wB:'wB.svg',wN:'wN.svg',wP:'wP.svg',
  bK:'bK.svg',bQ:'bQ.svg',bR:'bR.svg',bB:'bB.svg',bN:'bN.svg',bP:'bP.svg'
};

const SFX = {
  ctx: null,
  init() { if (!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if (this.ctx.state==='suspended') this.ctx.resume(); },
  play(type) {
    try { this.init(); const ctx=this.ctx, now=ctx.currentTime, g=ctx.createGain(); g.connect(ctx.destination);
      if (type==='move') { const o=ctx.createOscillator(); o.connect(g); o.type='triangle'; o.frequency.setValueAtTime(320,now); o.frequency.exponentialRampToValueAtTime(180,now+0.08); g.gain.setValueAtTime(0.18,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.12); o.start(now); o.stop(now+0.12); }
      else if (type==='capture') { const o=ctx.createOscillator(); o.connect(g); o.type='sawtooth'; o.frequency.setValueAtTime(220,now); o.frequency.exponentialRampToValueAtTime(80,now+0.1); g.gain.setValueAtTime(0.25,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.15); o.start(now); o.stop(now+0.15); }
      else if (type==='select') { const o=ctx.createOscillator(); o.connect(g); o.type='sine'; o.frequency.setValueAtTime(520,now); o.frequency.exponentialRampToValueAtTime(440,now+0.06); g.gain.setValueAtTime(0.1,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.08); o.start(now); o.stop(now+0.08); }
    } catch(e) {}
  }
};

let game = new Chess();
let currentOpening = null;
let playedMoves = [];    // all moves in UCI
let displayIndex = 0;    // which move we're showing
let playAllTimer = null;

// ‚îÄ‚îÄ BUILD SIDEBAR ‚îÄ‚îÄ
function buildSidebar() {
  const cats = [...new Set(OPENINGS.map(o => o.category))];
  const el = document.getElementById('openingList');
  let html = '';
  cats.forEach(cat => {
    html += `<div class="cat-section"><div class="cat-title">${cat}</div>`;
    OPENINGS.filter(o => o.category === cat).forEach((o,i) => {
      html += `<button class="opening-btn" id="obtn-${o.eco}" onclick="selectOpening('${o.eco}')">
        <span>${o.name}</span>
        <span class="opening-eco">${o.eco}</span>
      </button>`;
    });
    html += '</div>';
  });
  el.innerHTML = html;
}

function selectOpening(eco) {
  SFX.play('select');
  if (playAllTimer) { clearInterval(playAllTimer); playAllTimer = null; }
  currentOpening = OPENINGS.find(o => o.eco === eco);
  if (!currentOpening) return;

  // Highlight button
  document.querySelectorAll('.opening-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('obtn-' + eco);
  if (btn) { btn.classList.add('active'); btn.scrollIntoView({ behavior:'smooth', block:'nearest' }); }

  // Set up game
  game = new Chess();
  playedMoves = [...currentOpening.moves];
  displayIndex = 0;

  // Update header
  document.getElementById('openingName').textContent = currentOpening.name;
  document.getElementById('openingEco').textContent = 'ECO: ' + currentOpening.eco;
  document.getElementById('openingDesc').textContent = currentOpening.desc;

  // Key ideas
  const ideasHtml = currentOpening.ideas.map(idea =>
    `<div class="key-idea"><strong>üí° KEY IDEA</strong>${idea}</div>`).join('');
  document.getElementById('keyIdeas').innerHTML = ideasHtml;

  // Variations
  const varHtml = (currentOpening.variations || []).map(v =>
    `<button class="var-btn" onclick="loadVariation('${v.moves}')">
      ${v.name}
      <span class="var-moves">${v.moves}</span>
    </button>`).join('');
  document.getElementById('variationsList').innerHTML = varHtml || '<div style="color:var(--muted);font-size:12px">No variations listed</div>';

  // Move annotations
  const annHtml = (currentOpening.annotations || []).map((a, i) => {
    const moveNum = Math.floor(i/2) + 1;
    const isWhite = i % 2 === 0;
    return `<div class="move-step" onclick="goToMove(${i+1})">
      <div class="step-num">${isWhite ? moveNum+'.' : ''}</div>
      <div class="step-move">${isWhite ? '...' : '...'}${a.split('‚Äî')[0].trim()}</div>
      <div class="step-desc">${a.includes('‚Äî') ? a.split('‚Äî')[1].trim() : ''}</div>
    </div>`;
  }).join('');
  document.getElementById('moveAnnotations').innerHTML = annHtml;

  goStart();
}

function loadVariation(movesStr) {
  if (!currentOpening) return;
  if (playAllTimer) { clearInterval(playAllTimer); playAllTimer = null; }
  const varMoves = movesStr.trim().split(' ');
  // Parse the variation moves (they're in SAN format like "2.Nf3 Nc6 3.Bc4")
  // Clean: remove move numbers
  const cleanMoves = varMoves.filter(m => !m.match(/^\d+\./));
  // Base moves from the opening
  const baseMoves = [...currentOpening.moves];
  // Convert base moves to game, then add variation
  game = new Chess();
  const uciMoves = [];
  baseMoves.forEach(uci => {
    const from = uci.slice(0,2), to = uci.slice(2,4), promo = uci[4];
    const m = game.move({ from, to, promotion: promo });
    if (m) uciMoves.push(uci);
  });
  // Now try to play the SAN variation moves
  cleanMoves.forEach(san => {
    const m = game.move(san);
    if (m) uciMoves.push(m.from + m.to + (m.promotion || ''));
  });
  playedMoves = uciMoves;
  displayIndex = 0;
  showMoveAtIndex(0);
  renderMoveHistory();
}

function goToMove(idx) {
  displayIndex = Math.min(idx, playedMoves.length);
  game = new Chess();
  let lastMove = null;
  for (let i = 0; i < displayIndex; i++) {
    const uci = playedMoves[i];
    lastMove = game.move({ from: uci.slice(0,2), to: uci.slice(2,4), promotion: uci[4] || undefined });
  }
  const lastUCI = displayIndex > 0 ? playedMoves[displayIndex-1] : null;
  if (lastMove) {
    SFX.play(lastMove.captured ? 'capture' : 'move');
    setTimeout(() => {
      const toSq = lastUCI ? lastUCI.slice(2,4) : null;
      if (toSq) {
        const wrap = document.querySelector(`#board [data-sq="${toSq}"] .piece-wrap`);
        if (wrap) { wrap.classList.add('bounce'); setTimeout(() => wrap.classList.remove('bounce'), 300); }
      }
    }, 20);
  }
  renderBoard(lastUCI);
  // Animate dots AFTER board renders so layout is stable
  if (lastMove && lastUCI) {
    requestAnimationFrame(() => animateMoveArrow(lastUCI.slice(0,2), lastUCI.slice(2,4)));
  }
  renderMoveHistory();
}

function showMoveAtIndex(idx) {
  goToMove(idx);
}

function goStart() {
  game = new Chess();
  displayIndex = 0;
  renderBoard(null);
  renderMoveHistory();
}

function prevMove() {
  if (displayIndex > 0) goToMove(displayIndex - 1);
}

function nextMove() {
  if (displayIndex < playedMoves.length) goToMove(displayIndex + 1);
}

function playAll() {
  if (playAllTimer) { clearInterval(playAllTimer); playAllTimer = null; return; }
  goStart();
  playAllTimer = setInterval(() => {
    if (displayIndex >= playedMoves.length) {
      clearInterval(playAllTimer); playAllTimer = null; return;
    }
    nextMove();
  }, 900);
}


// ‚îÄ‚îÄ MOVE DOT ANIMATION ‚îÄ‚îÄ


function animateMoveArrow(fromSq, toSq) {
  const svg = document.getElementById('move-arrow-svg');
  const boardEl = document.getElementById('board');
  if (!svg || !boardEl) return;
  svg.innerHTML = '';

  const boardSize = boardEl.offsetWidth || 480;
  const SQ = boardSize / 8;
  svg.setAttribute('viewBox', `0 0 ${boardSize} ${boardSize}`);

  function sqCenter(sq) {
    const f = 'abcdefgh'.indexOf(sq[0]);
    const r = parseInt(sq[1]) - 1;
    return { x: f * SQ + SQ/2, y: (7-r) * SQ + SQ/2 };
  }

  const from = sqCenter(fromSq);
  const to   = sqCenter(toSq);
  const dx = to.x - from.x;
  const dy = to.y - from.y;
  const dist = Math.sqrt(dx*dx + dy*dy);
  const NUM_DOTS = Math.max(4, Math.round(dist / 20));
  const DURATION = 420;
  const GAP = 50;

  for (let i = 0; i < NUM_DOTS; i++) {
    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    const isLead = i === NUM_DOTS - 1;
    dot.setAttribute('r', isLead ? 6 : 4);
    dot.setAttribute('fill', isLead ? '#f0c040' : '#f5d876');
    dot.setAttribute('opacity', '0');
    svg.appendChild(dot);

    const delay = i * GAP;
    const start = performance.now() + delay;

    (function(d, sx, sy, ex, ey, dur, t0) {
      function tick(now) {
        const p = Math.min((now - t0) / dur, 1);
        if (p < 0) { requestAnimationFrame(tick); return; }
        const e = p < 0.5 ? 2*p*p : 1 - Math.pow(-2*p+2, 2)/2;
        d.setAttribute('cx', sx + (ex-sx)*e);
        d.setAttribute('cy', sy + (ey-sy)*e);
        d.setAttribute('opacity', p < 0.15 ? p/0.15 : p > 0.75 ? (1-p)/0.25 : 1);
        if (p < 1) requestAnimationFrame(tick);
        else d.remove();
      }
      requestAnimationFrame(tick);
    })(dot, from.x, from.y, to.x, to.y, DURATION, start);
  }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function renderBoard(lastMoveUCI) {
  const boardEl = document.getElementById('board');
  boardEl.innerHTML = '';
  const pos = game.board();
  const lastFrom = lastMoveUCI ? lastMoveUCI.slice(0,2) : null;
  const lastTo   = lastMoveUCI ? lastMoveUCI.slice(2,4) : null;

  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const rank = 7 - r;
      const file = c;
      const sq = 'abcdefgh'[file] + (rank + 1);
      // chess.js pos[0]=rank8 pos[7]=rank1 ‚Üí arrayRow=r for white-at-bottom
      const piece = pos[r] ? pos[r][file] : null;
      const isLight = (rank + file) % 2 === 1;

      const div = document.createElement('div');
      div.className = 'sq ' + (isLight ? 'light' : 'dark');
      div.dataset.sq = sq;
      if (sq === lastFrom) div.classList.add('last-from');
      if (sq === lastTo)   div.classList.add('last-to');

      if (piece) {
        const key = piece.color + piece.type.toUpperCase();
        const wrap = document.createElement('div');
        wrap.className = 'piece-wrap';
        const img = document.createElement('img');
        img.src = PIECE_BASE + PIECE_SRC[key];
        img.className = 'piece';
        img.draggable = false;
        wrap.appendChild(img);
        div.appendChild(wrap);
      }
      if (file === 0) {
        const l = document.createElement('div'); l.className='sq-lbl-r'; l.textContent=rank+1; div.appendChild(l);
      }
      if (rank === 0) {
        const l = document.createElement('div'); l.className='sq-lbl'; l.textContent='abcdefgh'[file]; div.appendChild(l);
      }
      boardEl.appendChild(div);
    }
  }
}

function renderMoveHistory() {
  if (!currentOpening) return;
  const el = document.getElementById('moveHistory');
  if (playedMoves.length === 0) {
    el.innerHTML = '<span style="font-family:\'DM Mono\',monospace;font-size:11px;color:var(--muted)">Starting position</span>';
    return;
  }

  // Replay to get SAN notation
  const tempGame = new Chess();
  const sanMoves = [];
  playedMoves.forEach(uci => {
    const m = tempGame.move({ from:uci.slice(0,2), to:uci.slice(2,4), promotion:uci[4]||undefined });
    if (m) sanMoves.push(m.san);
  });

  let html = '';
  sanMoves.forEach((san, i) => {
    if (i % 2 === 0) html += `<span class="move-num">${Math.floor(i/2)+1}.</span>`;
    html += `<span class="move-token ${displayIndex === i+1 ? 'current' : ''}" onclick="goToMove(${i+1})">${san}</span>`;
  });
  el.innerHTML = html;
}

// ‚îÄ‚îÄ KEYBOARD NAVIGATION ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'ArrowRight') nextMove();
  if (e.key === 'ArrowLeft') prevMove();
  if (e.key === 'Home') goStart();
  if (e.key === 'End') goToMove(playedMoves.length);
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
buildSidebar();
renderBoard(null);

// Auto-select first opening
if (OPENINGS.length > 0) selectOpening(OPENINGS[0].eco);
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function() {
  const SB_URL = 'https://nlsmrveieqadjmytsmjm.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sc21ydmVpZXFhZGpteXRzbWptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTg4NjcsImV4cCI6MjA4NzI5NDg2N30.9uIWjPJsOhdXXHqGLIMcdY5eitbkGoHyhbreAEe-apM';
  function tryInject() {
    if (!window.supabase) { setTimeout(tryInject, 50); return; }
    const _sb = window.supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession:true, storageKey:'malachi-auth' } });
    _sb.auth.getSession().then(({ data: { session } }) => {
      const container = document.querySelector('.nav-right');
      if (!container) return;
      const widget = document.createElement('div');
      widget.className = 'profile-nav';
      if (session) {
        _sb.from('profiles').select('username,chess_rating').eq('id', session.user.id).single().then(({ data: profile }) => {
          const initials = (profile?.username||'?').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
          const rating = profile?.chess_rating;
          if (rating) {
            const pill = document.createElement('div'); pill.className='profile-rating-pill';
            pill.textContent='‚ôü '+rating; widget.appendChild(pill);
          }
          const avatar = document.createElement('a'); avatar.href='profile.html';
          avatar.className='profile-avatar-btn'; avatar.title='My Profile';
          avatar.textContent=initials; widget.appendChild(avatar);
          container.appendChild(widget);
        });
      } else {
        const signin = document.createElement('a'); signin.href='login.html';
        signin.className='profile-signin'; signin.textContent='Sign In';
        widget.appendChild(signin); container.appendChild(widget);
      }
    });
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', tryInject);
  else tryInject();
})();
</script>
</body>
</html>
